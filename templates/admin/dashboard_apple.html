{% extends "admin/base_apple.html" %}

{% block title %}管理仪表板 - Angela AI{% endblock %}

{% block content %}
<!-- 页面标题区域 -->
<div class="admin-page-header">
    <h1 class="admin-page-title">管理中心</h1>
    <p class="admin-page-subtitle">管理知识库文件和用户账户</p>
</div>

<!-- Tab 导航栏 -->
<div class="admin-tabs">
    <div class="admin-tab-nav">
        <button class="admin-tab-btn active" data-tab="knowledge" onclick="switchTab('knowledge')">
            <i class="fas fa-database"></i>
            知识库
        </button>
        <button class="admin-tab-btn" data-tab="users" onclick="switchTab('users')">
            <i class="fas fa-users"></i>
            用户管理
        </button>
    </div>
</div>

<!-- 知识库管理 Tab 内容 -->
<div class="admin-tab-content" id="knowledge-tab">

<!-- 统计卡片 -->
<div class="stats-grid">
    <div class="stats-card fade-in">
        <div class="stats-header">
            <div class="stats-icon" style="background: var(--color-primary);">
                <i class="fas fa-database"></i>
            </div>
        </div>
        <div class="stats-value">{{ knowledge_items|length }}</div>
        <div class="stats-label">知识库文件</div>
        <div class="stats-change positive">
            <i class="fas fa-arrow-up me-1"></i>
            活跃状态
        </div>
    </div>
    
    <div class="stats-card fade-in" style="animation-delay: 0.1s;">
        <div class="stats-header">
            <div class="stats-icon" style="background: var(--status-active);">
                <i class="fas fa-check-circle"></i>
            </div>
        </div>
        <div class="stats-value">{{ knowledge_items|selectattr("status", "equalto", "active")|list|length }}</div>
        <div class="stats-label">活跃文件</div>
        <div class="stats-change positive">
            <i class="fas fa-arrow-up me-1"></i>
            可用于AI处理
        </div>
    </div>
    
    <div class="stats-card fade-in" style="animation-delay: 0.2s;">
        <div class="stats-header">
            <div class="stats-icon" style="background: var(--status-paused);">
                <i class="fas fa-pause-circle"></i>
            </div>
        </div>
        <div class="stats-value">{{ knowledge_items|selectattr("status", "equalto", "paused")|list|length }}</div>
        <div class="stats-label">暂停文件</div>
        <div class="stats-change">
            <i class="fas fa-minus me-1"></i>
            临时停用
        </div>
    </div>
    
    <div class="stats-card fade-in" style="animation-delay: 0.3s;">
        <div class="stats-header">
            <div class="stats-icon" style="background: var(--color-accent);">
                <i class="fas fa-chart-line"></i>
            </div>
        </div>
        <div class="stats-value">{{ (knowledge_items|sum(attribute='file_size') / 1024 / 1024)|round(1) }}</div>
        <div class="stats-label">总大小 (MB)</div>
        <div class="stats-change">
            <i class="fas fa-database me-1"></i>
            存储空间使用
        </div>
    </div>
</div>

<!-- 多文件上传区域 -->
<div class="upload-section">
<div class="upload-zone fade-in" style="animation-delay: 0.4s;" onclick="document.getElementById('fileInput').click()">
    <div class="upload-icon">
        <i class="fas fa-cloud-upload-alt"></i>
    </div>
    <h4 class="upload-title">上传知识库文件</h4>
    <p class="upload-description">将文件拖拽到此处，或点击选择文件上传（支持多文件选择）</p>
    <div class="upload-formats">
        支持格式：TXT, PDF, DOC, DOCX, XLSX, CSV, MD, JSON
    </div>
    
    <form id="uploadForm" action="{{ url_for('upload_knowledge_multiple') }}" method="post" enctype="multipart/form-data" style="display: none;">
        <input type="file" id="fileInput" name="files" accept=".txt,.pdf,.doc,.docx,.xlsx,.csv,.md,.json" multiple>
    </form>
</div>

<!-- 上传进度显示区域 -->
<div id="uploadProgress" class="upload-progress" style="display: none;">
    <div class="progress-header">
        <h5>上传进度</h5>
        <button type="button" class="close-progress" onclick="hideUploadProgress()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div id="uploadList" class="upload-list">
        <!-- 动态生成上传项目 -->
    </div>
</div>
</div>

<!-- 快速创建文本知识 -->
<div class="upload-section">
<div class="card fade-in" style="animation-delay: 0.5s;">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-plus-circle"></i>
            快速创建文本知识
        </h3>
    </div>
    <div class="card-body">
        <form action="{{ url_for('create_text_knowledge') }}" method="post">
            <div class="form-group">
                <label for="textTitle" class="form-label">标题</label>
                <input type="text" class="form-control" id="textTitle" name="title" placeholder="输入知识条目标题" required>
            </div>
            <div class="form-group">
                <label for="textContent" class="form-label">内容</label>
                <textarea class="form-control" id="textContent" name="content" rows="6" placeholder="输入知识条目内容..." required></textarea>
            </div>
            <div style="text-align: right;">
                <button type="submit" class="btn btn-primary interactive">
                    <i class="fas fa-save me-2"></i>
                    创建知识条目
                </button>
            </div>
        </form>
    </div>
</div>
</div>

<!-- 知识库文件列表 -->
<div class="table-container fade-in" style="animation-delay: 0.6s;">
    <div class="table-header">
        <h3 class="table-title">知识库文件列表</h3>
        <div class="table-filters">
            <form method="GET" style="display: flex; align-items: center; gap: var(--space-3);">
                <input type="text" name="search" class="filter-input" placeholder="搜索文件名..." 
                       value="{{ search_query or '' }}">
                <select name="status" class="filter-select">
                    <option value="">全部状态</option>
                    <option value="active" {{ 'selected' if status_filter == 'active' }}>活跃</option>
                    <option value="paused" {{ 'selected' if status_filter == 'paused' }}>暂停</option>
                </select>
                <button type="submit" class="btn btn-secondary btn-small">
                    <i class="fas fa-search"></i>
                </button>
            </form>
        </div>
    </div>
    
    {% if knowledge_items %}
    <table class="data-table">
        <thead>
            <tr>
                <th>文件名</th>
                <th>类型</th>
                <th>大小</th>
                <th>状态</th>
                <th>上传时间</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for item in knowledge_items %}
            <tr class="slide-up" style="animation-delay: {{ loop.index * 0.05 }}s;">
                <td>
                    <div style="display: flex; align-items: center;">
                        <div style="width: 40px; height: 40px; background: var(--color-primary); color: var(--color-text-inverse); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; margin-right: var(--space-3); font-weight: var(--font-semibold);">
                            {% if item.file_type == 'text' %}
                                <i class="fas fa-file-text"></i>
                            {% elif item.file_type in ['pdf'] %}
                                <i class="fas fa-file-pdf"></i>
                            {% elif item.file_type in ['doc', 'docx'] %}
                                <i class="fas fa-file-word"></i>
                            {% elif item.file_type in ['xlsx', 'csv'] %}
                                <i class="fas fa-file-excel"></i>
                            {% elif item.file_type == 'json' %}
                                <i class="fas fa-file-code"></i>
                            {% else %}
                                <i class="fas fa-file"></i>
                            {% endif %}
                        </div>
                        <div>
                            <div style="font-weight: var(--font-medium); color: var(--color-text-primary);">{{ item.original_filename }}</div>
                            <div style="font-size: var(--text-xs); color: var(--color-text-secondary);">{{ item.filename }}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <span style="font-size: var(--text-xs); text-transform: uppercase; font-weight: var(--font-semibold); color: var(--color-text-secondary);">
                        {{ item.file_type }}
                    </span>
                </td>
                <td>{{ "%.1f"|format(item.file_size / 1024) }} KB</td>
                <td>
                    {% if item.status == 'active' %}
                        <span class="status-badge active">活跃</span>
                    {% elif item.status == 'paused' %}
                        <span class="status-badge paused">暂停</span>
                    {% else %}
                        <span class="status-badge draft">{{ item.status }}</span>
                    {% endif %}
                </td>
                <td style="color: var(--color-text-secondary);">
                    {{ item.upload_time.strftime('%Y-%m-%d %H:%M') }}
                </td>
                <td>
                    <div class="action-buttons">
                        {% if item.file_type == 'text' %}
                        <button type="button" class="action-btn edit" onclick="editTextItem({{ item.id }}, '{{ item.original_filename }}', '{{ item.content_summary|replace("'", "\\'") }}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        {% endif %}
                        
                        <form method="post" action="{{ url_for('toggle_knowledge_status', item_id=item.id) }}" style="display: inline;">
                            <button type="submit" class="action-btn toggle">
                                {% if item.status == 'active' %}
                                    <i class="fas fa-pause"></i>
                                {% else %}
                                    <i class="fas fa-play"></i>
                                {% endif %}
                            </button>
                        </form>
                        
                        <form method="post" action="{{ url_for('delete_knowledge', item_id=item.id) }}" 
                              onsubmit="return confirm('确定要删除这个文件吗？')" style="display: inline;">
                            <button type="submit" class="action-btn delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">
            <i class="fas fa-folder-open"></i>
        </div>
        <h4 class="empty-title">暂无知识库文件</h4>
        <p class="empty-description">
            {% if search_query or status_filter %}
                未找到符合条件的文件，请尝试调整搜索条件。
            {% else %}
                开始上传文件或创建文本知识条目来建设您的知识库。
            {% endif %}
        </p>
        {% if not search_query and not status_filter %}
        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
            <i class="fas fa-plus me-2"></i>
            上传第一个文件
        </button>
        {% endif %}
    </div>
    {% endif %}
</div>

</div>
<!-- 知识库管理 Tab 内容结束 -->

<!-- 用户管理 Tab 内容 -->
<div class="admin-tab-content" id="users-tab" style="display: none;">
    
    <!-- 用户统计卡片 -->
    <div class="stats-grid">
        <div class="stats-card fade-in">
            <div class="stats-header">
                <div class="stats-icon" style="background: var(--color-primary);">
                    <i class="fas fa-users"></i>
                </div>
            </div>
            <div class="stats-value" id="total-users">0</div>
            <div class="stats-label">总用户数</div>
            <div class="stats-change positive">
                <i class="fas fa-arrow-up me-1"></i>
                注册用户
            </div>
        </div>
        
        <div class="stats-card fade-in" style="animation-delay: 0.1s;">
            <div class="stats-header">
                <div class="stats-icon" style="background: var(--status-active);">
                    <i class="fas fa-user-check"></i>
                </div>
            </div>
            <div class="stats-value" id="active-users">0</div>
            <div class="stats-label">活跃用户</div>
            <div class="stats-change positive">
                <i class="fas fa-arrow-up me-1"></i>
                可正常使用
            </div>
        </div>
        
        <div class="stats-card fade-in" style="animation-delay: 0.2s;">
            <div class="stats-header">
                <div class="stats-icon" style="background: var(--color-accent);">
                    <i class="fas fa-user-shield"></i>
                </div>
            </div>
            <div class="stats-value" id="admin-users">0</div>
            <div class="stats-label">管理员</div>
            <div class="stats-change">
                <i class="fas fa-shield-alt me-1"></i>
                管理权限
            </div>
        </div>
        
        <div class="stats-card fade-in" style="animation-delay: 0.3s;">
            <div class="stats-header">
                <div class="stats-icon" style="background: var(--status-paused);">
                    <i class="fas fa-user-clock"></i>
                </div>
            </div>
            <div class="stats-value" id="recent-users">0</div>
            <div class="stats-label">近期注册</div>
            <div class="stats-change">
                <i class="fas fa-calendar me-1"></i>
                30天内
            </div>
        </div>
    </div>

    <!-- 添加用户按钮 -->
    <div class="upload-section">
        <div class="card fade-in" style="animation-delay: 0.4s;">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-user-plus"></i>
                    添加新用户
                </h3>
            </div>
            <div class="card-body">
                <form id="addUserForm" method="post" action="/admin/users/add">
                    <div class="form-group">
                        <label for="userName" class="form-label">姓名</label>
                        <input type="text" class="form-control" id="userName" name="name" placeholder="输入用户姓名" required>
                    </div>
                    <div class="form-group">
                        <label for="userPhone" class="form-label">手机号</label>
                        <input type="tel" class="form-control" id="userPhone" name="phone" placeholder="输入手机号" required>
                    </div>
                    <div class="form-group">
                        <label for="userPassword" class="form-label">密码</label>
                        <input type="password" class="form-control" id="userPassword" name="password" placeholder="输入初始密码" required>
                    </div>
                    <div class="form-group">
                        <div style="display: flex; align-items: center; gap: var(--space-2);">
                            <input type="checkbox" id="isAdmin" name="is_admin" value="1">
                            <label for="isAdmin" class="form-label" style="margin: 0;">管理员权限</label>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <button type="submit" class="btn btn-primary interactive">
                            <i class="fas fa-user-plus me-2"></i>
                            添加用户
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 用户列表 -->
    <div class="table-container fade-in" style="animation-delay: 0.6s;">
        <div class="table-header">
            <h3 class="table-title">用户列表</h3>
            <div class="table-filters">
                <form method="GET" style="display: flex; align-items: center; gap: var(--space-3);" onsubmit="return false;">
                    <input type="text" id="userSearch" class="filter-input" placeholder="搜索用户..." 
                           onkeyup="filterUsers()">
                    <select id="userStatusFilter" class="filter-select" onchange="filterUsers()">
                        <option value="">全部状态</option>
                        <option value="active">活跃</option>
                        <option value="inactive">停用</option>
                    </select>
                </form>
            </div>
        </div>
        
        <div id="usersTableContainer">
            <!-- 用户表格将通过AJAX加载 -->
            <div class="loading-spinner" style="text-align: center; padding: var(--space-8);">
                <i class="fas fa-spinner fa-spin" style="font-size: var(--text-2xl); color: var(--color-primary);"></i>
                <p style="margin-top: var(--space-2); color: var(--color-text-secondary);">加载用户数据中...</p>
            </div>
        </div>
    </div>

</div>
<!-- 用户管理 Tab 内容结束 -->

<!-- 编辑文本模态框 -->
<div class="modal-overlay" id="editModal" style="display: none;" onclick="closeEditModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h4 class="modal-title">编辑文本知识条目</h4>
            <button type="button" class="modal-close" onclick="closeEditModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="editForm" method="post">
            <div class="modal-body">
                <div class="form-group">
                    <label for="editTitle" class="form-label">标题</label>
                    <input type="text" class="form-control" id="editTitle" name="title" required>
                </div>
                <div class="form-group">
                    <label for="editContent" class="form-label">内容</label>
                    <textarea class="form-control" id="editContent" name="content" rows="8" required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">取消</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-2"></i>
                    保存更改
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<style>
/* Admin Tab 样式 */
.admin-tabs {
    max-width: 1400px;
    margin: 0 auto var(--space-6);
    padding: 0 var(--space-6);
}

.admin-tab-nav {
    display: flex;
    background: var(--color-bg-primary);
    border-radius: var(--radius-xl);
    padding: var(--space-2);
    box-shadow: var(--shadow-sm);
    border: 0.5px solid var(--color-gray-200);
    gap: var(--space-2);
}

.admin-tab-btn {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
    padding: var(--space-4) var(--space-6);
    background: transparent;
    border: none;
    border-radius: var(--radius-lg);
    font-size: var(--text-base);
    font-weight: var(--font-medium);
    color: var(--color-text-secondary);
    cursor: pointer;
    transition: var(--transition-base);
    position: relative;
    overflow: hidden;
}

.admin-tab-btn:hover {
    color: var(--color-primary);
    background: rgba(0, 122, 255, 0.05);
}

.admin-tab-btn.active {
    color: var(--color-primary);
    background: linear-gradient(135deg, rgba(0, 122, 255, 0.1) 0%, rgba(0, 122, 255, 0.05) 100%);
    box-shadow: 0 2px 8px rgba(0, 122, 255, 0.15);
}

.admin-tab-btn.active::before {
    content: '';
    position: absolute;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 40px;
    height: 3px;
    background: var(--color-primary);
    border-radius: 3px 3px 0 0;
}

.admin-tab-btn i {
    font-size: var(--text-lg);
}

.admin-tab-content {
    animation: fadeIn 0.4s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* 移动端适配 */
@media (max-width: 768px) {
    .admin-tabs {
        padding: 0 var(--space-4);
        margin-bottom: var(--space-4);
    }
    
    .admin-tab-nav {
        flex-direction: row;
        padding: var(--space-1);
        border-radius: var(--radius-lg);
    }
    
    .admin-tab-btn {
        padding: var(--space-3) var(--space-4);
        font-size: var(--text-sm);
        flex-direction: column;
        gap: var(--space-1);
    }
    
    .admin-tab-btn i {
        font-size: var(--text-base);
    }
}

@media (max-width: 480px) {
    .admin-tabs {
        padding: 0 var(--space-3);
    }
    
    .admin-tab-btn {
        padding: var(--space-2) var(--space-3);
        font-size: var(--text-xs);
    }
    
    .admin-tab-btn i {
        font-size: var(--text-sm);
    }
}
</style>

<script>
// 多文件上传处理
document.getElementById('fileInput').addEventListener('change', function() {
    if (this.files.length > 0) {
        handleFileUpload(Array.from(this.files));
    }
});

// 拖拽上传
const uploadZone = document.querySelector('.upload-zone');

uploadZone.addEventListener('dragover', function(e) {
    e.preventDefault();
    this.classList.add('dragover');
});

uploadZone.addEventListener('dragleave', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
});

uploadZone.addEventListener('drop', function(e) {
    e.preventDefault();
    this.classList.remove('dragover');
    
    const files = Array.from(e.dataTransfer.files);
    if (files.length > 0) {
        handleFileUpload(files);
    }
});

// 处理文件上传
async function handleFileUpload(files) {
    if (files.length === 0) return;
    
    // 显示上传进度区域
    showUploadProgress();
    
    // 清空之前的上传列表
    const uploadList = document.getElementById('uploadList');
    uploadList.innerHTML = '';
    
    // 为每个文件创建进度项
    files.forEach(file => {
        const uploadItem = createUploadItem(file);
        uploadList.appendChild(uploadItem);
    });
    
    // 逐个上传文件
    for (let i = 0; i < files.length; i++) {
        await uploadSingleFile(files[i], i);
    }
    
    // 上传完成后延迟隐藏进度区域
    setTimeout(() => {
        hideUploadProgress();
        // 刷新页面显示新上传的文件
        location.reload();
    }, 2000);
}

// 上传单个文件
async function uploadSingleFile(file, index) {
    const formData = new FormData();
    formData.append('file', file);
    
    const uploadItem = document.querySelector(`[data-file-index="${index}"]`);
    const progressBar = uploadItem.querySelector('.upload-progress-bar');
    const statusIcon = uploadItem.querySelector('.upload-status i');
    const statusText = uploadItem.querySelector('.upload-status-text');
    
    try {
        statusText.textContent = '上传中...';
        
        const response = await fetch('{{ url_for("upload_knowledge") }}', {
            method: 'POST',
            body: formData
        });
        
        if (response.ok) {
            progressBar.style.width = '100%';
            statusIcon.className = 'fas fa-check-circle';
            statusIcon.style.color = 'var(--status-active)';
            statusText.textContent = '上传成功';
            uploadItem.classList.add('upload-success');
        } else {
            throw new Error('上传失败');
        }
    } catch (error) {
        statusIcon.className = 'fas fa-times-circle';
        statusIcon.style.color = 'var(--status-error)';
        statusText.textContent = '上传失败';
        uploadItem.classList.add('upload-error');
    }
}

// 创建上传项目DOM
function createUploadItem(file) {
    const item = document.createElement('div');
    item.className = 'upload-item';
    item.setAttribute('data-file-index', document.querySelectorAll('.upload-item').length);
    
    item.innerHTML = `
        <div class="upload-item-info">
            <div class="upload-file-icon">
                <i class="fas fa-file"></i>
            </div>
            <div class="upload-file-details">
                <div class="upload-file-name">${file.name}</div>
                <div class="upload-file-size">${formatFileSize(file.size)}</div>
            </div>
        </div>
        <div class="upload-item-progress">
            <div class="upload-progress-track">
                <div class="upload-progress-bar" style="width: 0%"></div>
            </div>
            <div class="upload-status">
                <i class="fas fa-clock"></i>
                <span class="upload-status-text">等待上传</span>
            </div>
        </div>
    `;
    
    return item;
}

// 显示上传进度区域
function showUploadProgress() {
    const progressArea = document.getElementById('uploadProgress');
    progressArea.style.display = 'block';
    setTimeout(() => {
        progressArea.classList.add('show');
    }, 10);
}

// 隐藏上传进度区域
function hideUploadProgress() {
    const progressArea = document.getElementById('uploadProgress');
    progressArea.classList.remove('show');
    setTimeout(() => {
        progressArea.style.display = 'none';
    }, 300);
}

// 格式化文件大小
function formatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

// 编辑文本项目
function editTextItem(itemId, title, content) {
    document.getElementById('editTitle').value = title.replace('.txt', '');
    document.getElementById('editContent').value = content;
    document.getElementById('editForm').action = `/admin/knowledge/${itemId}/edit`;
    document.getElementById('editModal').style.display = 'flex';
    
    // 添加显示动画
    setTimeout(() => {
        document.querySelector('.modal-content').style.transform = 'scale(1)';
        document.querySelector('.modal-content').style.opacity = '1';
    }, 10);
}

// 关闭编辑模态框
function closeEditModal(event) {
    if (event && event.target !== event.currentTarget) return;
    
    const modal = document.getElementById('editModal');
    const content = document.querySelector('.modal-content');
    
    content.style.transform = 'scale(0.95)';
    content.style.opacity = '0';
    
    setTimeout(() => {
        modal.style.display = 'none';
        content.style.transform = 'scale(1)';
        content.style.opacity = '1';
    }, 200);
}

// 键盘快捷键
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeEditModal();
    }
});

// 页面加载动画
document.addEventListener('DOMContentLoaded', function() {
    // 为统计卡片添加交错动画
    const statsCards = document.querySelectorAll('.stats-card');
    statsCards.forEach((card, index) => {
        card.style.animationDelay = `${index * 0.1}s`;
    });
    
    // 为表格行添加交错动画
    const tableRows = document.querySelectorAll('.data-table tbody tr');
    tableRows.forEach((row, index) => {
        row.style.animationDelay = `${0.7 + index * 0.05}s`;
    });
    
    // 添加滚动动画观察器
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, { threshold: 0.1 });
    
    // 观察所有动画元素
    document.querySelectorAll('.slide-up').forEach(el => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(20px)';
        el.style.transition = 'opacity 0.6s ease, transform 0.6s ease';
        observer.observe(el);
    });
});

// 表单验证增强
document.querySelectorAll('form').forEach(form => {
    form.addEventListener('submit', function(e) {
        const submitBtn = this.querySelector('button[type="submit"]');
        if (submitBtn) {
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>处理中...';
            submitBtn.disabled = true;
            
            // 如果表单验证失败，恢复按钮状态
            setTimeout(() => {
                if (!this.checkValidity()) {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }
            }, 100);
        }
    });
});

// Tab 切换功能
function switchTab(tabName) {
    // 移除所有tab按钮的active类
    document.querySelectorAll('.admin-tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // 隐藏所有tab内容
    document.querySelectorAll('.admin-tab-content').forEach(content => {
        content.style.display = 'none';
    });
    
    // 激活当前tab按钮
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    
    // 显示当前tab内容
    document.getElementById(`${tabName}-tab`).style.display = 'block';
    
    // 如果切换到用户管理tab，加载用户数据
    if (tabName === 'users') {
        loadUsersData();
    }
}

// 加载用户数据
async function loadUsersData() {
    try {
        const response = await fetch('/admin/api/users');
        const data = await response.json();
        
        if (data.success) {
            // 更新统计数据
            document.getElementById('total-users').textContent = data.stats.total || 0;
            document.getElementById('active-users').textContent = data.stats.active || 0;
            document.getElementById('admin-users').textContent = data.stats.admin || 0;
            document.getElementById('recent-users').textContent = data.stats.recent || 0;
            
            // 更新用户表格
            renderUsersTable(data.users);
        }
    } catch (error) {
        console.error('加载用户数据失败:', error);
        document.getElementById('usersTableContainer').innerHTML = 
            '<div style="text-align: center; padding: var(--space-8); color: var(--color-error);">' +
            '<i class="fas fa-exclamation-triangle" style="font-size: var(--text-2xl); margin-bottom: var(--space-2);"></i>' +
            '<p>加载用户数据失败，请刷新页面重试</p>' +
            '</div>';
    }
}

// 渲染用户表格
function renderUsersTable(users) {
    const container = document.getElementById('usersTableContainer');
    
    if (!users || users.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="text-align: center; padding: var(--space-8);">
                <div class="empty-icon">
                    <i class="fas fa-users" style="font-size: var(--text-4xl); color: var(--color-gray-400); margin-bottom: var(--space-4);"></i>
                </div>
                <h4 class="empty-title">暂无用户数据</h4>
                <p class="empty-description">还没有注册的用户</p>
            </div>
        `;
        return;
    }
    
    const tableHTML = `
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>姓名</th>
                    <th>手机号</th>
                    <th>用户类型</th>
                    <th>状态</th>
                    <th>创建时间</th>
                    <th>最后登录</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                ${users.map(user => `
                    <tr>
                        <td>${user.id}</td>
                        <td>
                            <div style="display: flex; align-items: center; gap: var(--space-3);">
                                <div style="width: 32px; height: 32px; background: var(--color-primary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px;">
                                    <i class="fas fa-user"></i>
                                </div>
                                <strong>${user.name || '未设置'}</strong>
                            </div>
                        </td>
                        <td><span style="font-family: var(--font-mono); font-weight: 500;">${user.phone}</span></td>
                        <td>
                            <span class="user-type-badge ${user.is_admin ? 'admin' : ''}" style="display: inline-flex; align-items: center; gap: var(--space-1); padding: var(--space-1) var(--space-3); font-size: var(--text-xs); font-weight: var(--font-medium); border-radius: var(--radius-md); ${user.is_admin ? 'background: var(--color-secondary); color: white;' : 'background: var(--color-gray-100); color: var(--color-text-secondary);'}">
                                <i class="fas fa-${user.is_admin ? 'user-shield' : 'user'}"></i>
                                ${user.is_admin ? '管理员' : '普通用户'}
                            </span>
                        </td>
                        <td>
                            <span class="status-badge ${user.active ? 'active' : 'paused'}" style="display: inline-flex; align-items: center; gap: var(--space-1); padding: var(--space-1) var(--space-3); font-size: var(--text-xs); border-radius: var(--radius-md); ${user.active ? 'background: var(--status-active); color: white;' : 'background: var(--status-paused); color: white;'}">
                                <i class="fas fa-${user.active ? 'check-circle' : 'pause-circle'}"></i>
                                ${user.active ? '活跃' : '停用'}
                            </span>
                        </td>
                        <td><span style="font-size: var(--text-sm); color: var(--color-text-secondary);">${user.created_at || '-'}</span></td>
                        <td><span style="font-size: var(--text-sm); color: var(--color-text-secondary);">${user.last_login || '从未登录'}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn edit" onclick="editUser(${user.id})" title="编辑用户">
                                    <i class="fas fa-edit"></i>
                                </button>
                                ${user.id !== ${user.current_user_id || 0} ? `
                                <button class="action-btn delete" onclick="deleteUser(${user.id}, '${user.name || user.phone}')" title="删除用户">
                                    <i class="fas fa-trash"></i>
                                </button>
                                ` : ''}
                            </div>
                        </td>
                    </tr>
                `).join('')}
            </tbody>
        </table>
    `;
    
    container.innerHTML = tableHTML;
}

// 用户搜索过滤
function filterUsers() {
    const search = document.getElementById('userSearch').value.toLowerCase();
    const statusFilter = document.getElementById('userStatusFilter').value;
    const rows = document.querySelectorAll('#usersTableContainer tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        const statusCell = row.querySelector('.status-badge');
        const status = statusCell ? (statusCell.textContent.includes('活跃') ? 'active' : 'inactive') : '';
        
        const matchesSearch = !search || text.includes(search);
        const matchesStatus = !statusFilter || status === statusFilter;
        
        row.style.display = matchesSearch && matchesStatus ? '' : 'none';
    });
}

// 编辑用户
function editUser(userId) {
    // 跳转到编辑用户页面
    window.location.href = `/admin/users/${userId}/edit`;
}

// 删除用户
function deleteUser(userId, userName) {
    if (confirm(`确定要删除用户 "${userName}" 吗？此操作不可撤销！`)) {
        // 发送删除请求
        fetch(`/admin/users/${userId}/delete`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('用户删除成功');
                loadUsersData(); // 重新加载用户数据
            } else {
                alert('删除失败: ' + (data.message || '未知错误'));
            }
        })
        .catch(error => {
            console.error('删除用户失败:', error);
            alert('删除失败，请重试');
        });
    }
}

// 页面加载时的初始化
document.addEventListener('DOMContentLoaded', function() {
    // 检查URL参数决定初始显示哪个tab
    const urlParams = new URLSearchParams(window.location.search);
    const activeTab = urlParams.get('tab') || 'knowledge';
    
    if (activeTab !== 'knowledge') {
        switchTab(activeTab);
    }
});
</script>
{% endblock %}