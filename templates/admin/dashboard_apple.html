{% extends "admin/base_apple.html" %}

{% block title %}管理仪表板 - Angela AI{% endblock %}

{% block content %}
<!-- 页面标题区域 -->
<div class="admin-page-header">
    <h1 class="admin-page-title">管理中心</h1>
    <p class="admin-page-subtitle">管理知识库文件和用户账户</p>
</div>

<!-- Tab 导航栏 -->
<div class="admin-tabs">
    <div class="admin-tab-nav">
        <button class="admin-tab-btn active" data-tab="knowledge" onclick="switchTab('knowledge')">
            <i class="fas fa-database"></i>
            知识库
        </button>
        <button class="admin-tab-btn" data-tab="users" onclick="switchTab('users')">
            <i class="fas fa-users"></i>
            用户管理
        </button>
    </div>
</div>

<!-- 知识库管理 Tab 内容 -->
<div class="admin-tab-content" id="knowledge-tab">

<!-- 统计卡片 -->
<div class="stats-grid">
    <div class="stats-card fade-in">
        <div class="stats-header">
            <div class="stats-icon" style="background: var(--color-primary);">
                <i class="fas fa-database"></i>
            </div>
        </div>
        <div class="stats-value">{{ knowledge_items|length }}</div>
        <div class="stats-label">知识库文件</div>
        <div class="stats-change positive">
            <i class="fas fa-arrow-up me-1"></i>
            活跃状态
        </div>
    </div>

    <div class="stats-card fade-in" style="animation-delay: 0.1s;">
        <div class="stats-header">
            <div class="stats-icon" style="background: var(--status-active);">
                <i class="fas fa-check-circle"></i>
            </div>
        </div>
        <div class="stats-value">{{ knowledge_items|selectattr("status", "equalto", "active")|list|length }}</div>
        <div class="stats-label">活跃文件</div>
        <div class="stats-change positive">
            <i class="fas fa-arrow-up me-1"></i>
            可用于AI处理
        </div>
    </div>

    <div class="stats-card fade-in" style="animation-delay: 0.2s;">
        <div class="stats-header">
            <div class="stats-icon" style="background: var(--status-paused);">
                <i class="fas fa-pause-circle"></i>
            </div>
        </div>
        <div class="stats-value">{{ knowledge_items|selectattr("status", "equalto", "paused")|list|length }}</div>
        <div class="stats-label">暂停文件</div>
        <div class="stats-change">
            <i class="fas fa-minus me-1"></i>
            临时停用
        </div>
    </div>

    <div class="stats-card fade-in" style="animation-delay: 0.3s;">
        <div class="stats-header">
            <div class="stats-icon" style="background: var(--color-accent);">
                <i class="fas fa-chart-line"></i>
            </div>
        </div>
        <div class="stats-value">{{ (knowledge_items|sum(attribute='file_size') / 1024 / 1024)|round(1) }}</div>
        <div class="stats-label">总大小 (MB)</div>
        <div class="stats-change">
            <i class="fas fa-database me-1"></i>
            存储空间使用
        </div>
    </div>
</div>

<!-- 多文件上传区域 -->
<div class="upload-section">
<div class="upload-zone fade-in" style="animation-delay: 0.4s;" onclick="document.getElementById('fileInput').click()">
    <div class="upload-icon">
        <i class="fas fa-cloud-upload-alt"></i>
    </div>
    <h4 class="upload-title">上传知识库文件</h4>
    <p class="upload-description">将文件拖拽到此处，或点击选择文件上传（支持多文件选择）</p>
    <div class="upload-formats">
        支持格式：TXT, PDF, DOC, DOCX, XLSX, CSV, MD, JSON
    </div>

    <form id="uploadForm" action="{{ url_for('upload_knowledge_multiple') }}" method="post" enctype="multipart/form-data" style="display: none;">
        <input type="file" id="fileInput" name="files" accept=".txt,.pdf,.doc,.docx,.xlsx,.csv,.md,.json" multiple>
    </form>
</div>

<!-- 上传进度显示区域 -->
<div id="uploadProgress" class="upload-progress" style="display: none;">
    <div class="progress-header">
        <h5>上传进度</h5>
        <button type="button" class="close-progress" onclick="hideUploadProgress()">
            <i class="fas fa-times"></i>
        </button>
    </div>
    <div id="uploadList" class="upload-list">
        <!-- 动态生成上传项目 -->
    </div>
</div>
</div>

<!-- 快速创建文本知识 -->
<div class="upload-section">
<div class="card fade-in" style="animation-delay: 0.5s;">
    <div class="card-header">
        <h3 class="card-title">
            <i class="fas fa-plus-circle"></i>
            快速创建文本知识
        </h3>
    </div>
    <div class="card-body">
        <form action="{{ url_for('create_text_knowledge') }}" method="post">
            <div class="form-group">
                <label for="textTitle" class="form-label">标题</label>
                <input type="text" class="form-control" id="textTitle" name="title" placeholder="输入知识条目标题" required>
            </div>
            <div class="form-group">
                <label for="textContent" class="form-label">内容</label>
                <textarea class="form-control" id="textContent" name="content" rows="6" placeholder="输入知识条目内容..." required></textarea>
            </div>
            <div style="text-align: right;">
                <button type="submit" class="btn btn-primary interactive">
                    <i class="fas fa-save me-2"></i>
                    创建知识条目
                </button>
            </div>
        </form>
    </div>
</div>
</div>

<!-- 知识库文件列表 -->
<div class="table-container fade-in" style="animation-delay: 0.6s;">
    <div class="table-header">
        <h3 class="table-title">知识库文件列表</h3>
        <div class="table-filters">
            <form method="GET" style="display: flex; align-items: center; gap: var(--space-3);">
                <input type="text" name="search" class="filter-input" placeholder="搜索文件名..." 
                       value="{{ search_query or '' }}">
                <select name="status" class="filter-select">
                    <option value="">全部状态</option>
                    <option value="active" {{ 'selected' if status_filter == 'active' }}>活跃</option>
                    <option value="paused" {{ 'selected' if status_filter == 'paused' }}>暂停</option>
                </select>
                <button type="submit" class="btn btn-secondary btn-small">
                    <i class="fas fa-search"></i>
                </button>
            </form>
        </div>
    </div>

    {% if knowledge_items %}
    <table class="data-table">
        <thead>
            <tr>
                <th>文件名</th>
                <th>类型</th>
                <th>大小</th>
                <th>状态</th>
                <th>上传时间</th>
                <th>操作</th>
            </tr>
        </thead>
        <tbody>
            {% for item in knowledge_items %}
            <tr class="slide-up" style="animation-delay: {{ loop.index * 0.05 }}s;">
                <td>
                    <div style="display: flex; align-items: center;">
                        <div style="width: 40px; height: 40px; background: var(--color-primary); color: var(--color-text-inverse); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; margin-right: var(--space-3); font-weight: var(--font-semibold);">
                            {% if item.file_type == 'text' %}
                                <i class="fas fa-file-text"></i>
                            {% elif item.file_type in ['pdf'] %}
                                <i class="fas fa-file-pdf"></i>
                            {% elif item.file_type in ['doc', 'docx'] %}
                                <i class="fas fa-file-word"></i>
                            {% elif item.file_type in ['xlsx', 'csv'] %}
                                <i class="fas fa-file-excel"></i>
                            {% elif item.file_type == 'json' %}
                                <i class="fas fa-file-code"></i>
                            {% else %}
                                <i class="fas fa-file"></i>
                            {% endif %}
                        </div>
                        <div>
                            <div style="font-weight: var(--font-medium); color: var(--color-text-primary);">{{ item.original_filename }}</div>
                            <div style="font-size: var(--text-xs); color: var(--color-text-secondary);">{{ item.filename }}</div>
                        </div>
                    </div>
                </td>
                <td>
                    <span style="font-size: var(--text-xs); text-transform: uppercase; font-weight: var(--font-semibold); color: var(--color-text-secondary);">
                        {{ item.file_type }}
                    </span>
                </td>
                <td>{{ "%.1f"|format(item.file_size / 1024) }} KB</td>
                <td>
                    {% if item.status == 'active' %}
                        <span class="status-badge active">活跃</span>
                    {% elif item.status == 'paused' %}
                        <span class="status-badge paused">暂停</span>
                    {% else %}
                        <span class="status-badge draft">{{ item.status }}</span>
                    {% endif %}
                </td>
                <td style="color: var(--color-text-secondary);">
                    {{ item.upload_time.strftime('%Y-%m-%d %H:%M') }}
                </td>
                <td>
                    <div class="action-buttons">
                        {% if item.file_type == 'text' %}
                        <button type="button" class="action-btn edit" onclick="editTextItem({{ item.id }}, '{{ item.original_filename }}', '{{ item.content_summary|replace("'", "\\'") }}')">
                            <i class="fas fa-edit"></i>
                        </button>
                        {% endif %}

                        <form method="post" action="{{ url_for('toggle_knowledge_status', item_id=item.id) }}" style="display: inline;">
                            <button type="submit" class="action-btn toggle">
                                {% if item.status == 'active' %}
                                    <i class="fas fa-pause"></i>
                                {% else %}
                                    <i class="fas fa-play"></i>
                                {% endif %}
                            </button>
                        </form>

                        <form method="post" action="{{ url_for('delete_knowledge', item_id=item.id) }}" 
                              onsubmit="return confirm('确定要删除这个文件吗？')" style="display: inline;">
                            <button type="submit" class="action-btn delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </form>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">
            <i class="fas fa-folder-open"></i>
        </div>
        <h4 class="empty-title">暂无知识库文件</h4>
        <p class="empty-description">
            {% if search_query or status_filter %}
                未找到符合条件的文件，请尝试调整搜索条件。
            {% else %}
                开始上传文件或创建文本知识条目来建设您的知识库。
            {% endif %}
        </p>
        {% if not search_query and not status_filter %}
        <button class="btn btn-primary" onclick="document.getElementById('fileInput').click()">
            <i class="fas fa-plus me-2"></i>
            上传第一个文件
        </button>
        {% endif %}
    </div>
    {% endif %}
</div>

</div>
<!-- 知识库管理 Tab 内容结束 -->

<!-- 用户管理 Tab 内容 -->
<div class="admin-tab-content" id="users-tab" style="display: none;">

    <!-- 用户统计卡片 -->
    <div class="stats-grid">
        <div class="stats-card fade-in">
            <div class="stats-header">
                <div class="stats-icon" style="background: var(--color-primary);">
                    <i class="fas fa-users"></i>
                </div>
            </div>
            <div class="stats-value" id="total-users">0</div>
            <div class="stats-label">总用户数</div>
            <div class="stats-change positive">
                <i class="fas fa-arrow-up me-1"></i>
                注册用户
            </div>
        </div>

        <div class="stats-card fade-in" style="animation-delay: 0.1s;">
            <div class="stats-header">
                <div class="stats-icon" style="background: var(--status-active);">
                    <i class="fas fa-user-check"></i>
                </div>
            </div>
            <div class="stats-value" id="active-users">0</div>
            <div class="stats-label">活跃用户</div>
            <div class="stats-change positive">
                <i class="fas fa-arrow-up me-1"></i>
                可正常使用
            </div>
        </div>

        <div class="stats-card fade-in" style="animation-delay: 0.2s;">
            <div class="stats-header">
                <div class="stats-icon" style="background: var(--color-accent);">
                    <i class="fas fa-user-shield"></i>
                </div>
            </div>
            <div class="stats-value" id="admin-users">0</div>
            <div class="stats-label">管理员</div>
            <div class="stats-change">
                <i class="fas fa-shield-alt me-1"></i>
                管理权限
            </div>
        </div>

        <div class="stats-card fade-in" style="animation-delay: 0.3s;">
            <div class="stats-header">
                <div class="stats-icon" style="background: var(--status-paused);">
                    <i class="fas fa-user-clock"></i>
                </div>
            </div>
            <div class="stats-value" id="recent-users">0</div>
            <div class="stats-label">近期注册</div>
            <div class="stats-change">
                <i class="fas fa-calendar me-1"></i>
                30天内
            </div>
        </div>
    </div>

    <!-- 添加用户按钮 -->
    <div class="upload-section">
        <div class="card fade-in" style="animation-delay: 0.4s;">
            <div class="card-header">
                <h3 class="card-title">
                    <i class="fas fa-user-plus"></i>
                    添加新用户
                </h3>
            </div>
            <div class="card-body">
                <form id="addUserForm" method="post" action="/admin/users/add">
                    <div class="form-group">
                        <label for="userName" class="form-label">姓名</label>
                        <input type="text" class="form-control" id="userName" name="name" placeholder="输入用户姓名" required>
                    </div>
                    <div class="form-group">
                        <label for="userPhone" class="form-label">手机号</label>
                        <input type="tel" class="form-control" id="userPhone" name="phone" placeholder="输入手机号" required>
                    </div>
                    <div class="form-group">
                        <label for="userPassword" class="form-label">密码</label>
                        <input type="password" class="form-control" id="userPassword" name="password" placeholder="输入初始密码" required>
                    </div>
                    <div class="form-group">
                        <div style="display: flex; align-items: center; gap: var(--space-2);">
                            <input type="checkbox" id="isAdmin" name="is_admin" value="1">
                            <label for="isAdmin" class="form-label" style="margin: 0;">管理员权限</label>
                        </div>
                    </div>
                    <div style="text-align: right;">
                        <button type="submit" class="btn btn-primary interactive">
                            <i class="fas fa-user-plus me-2"></i>
                            添加用户
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- 用户列表 -->
    <div class="table-container fade-in" style="animation-delay: 0.6s;">
        <div class="table-header">
            <h3 class="table-title">用户列表</h3>
            <div class="table-filters">
                <form method="GET" style="display: flex; align-items: center; gap: var(--space-3);" onsubmit="return false;">
                    <input type="text" id="userSearch" class="filter-input" placeholder="搜索用户..." 
                           onkeyup="filterUsers()">
                    <select id="userStatusFilter" class="filter-select" onchange="filterUsers()">
                        <option value="">全部状态</option>
                        <option value="active">活跃</option>
                        <option value="inactive">停用</option>
                    </select>
                </form>
            </div>
        </div>

        <div id="usersTableContainer">
            <!-- 用户表格将通过AJAX加载 -->
            <div class="loading-spinner" style="text-align: center; padding: var(--space-8);">
                <i class="fas fa-spinner fa-spin" style="font-size: var(--text-2xl); color: var(--color-primary);"></i>
                <p style="margin-top: var(--space-2); color: var(--color-text-secondary);">加载用户数据中...</p>
            </div>
        </div>
    </div>

</div>
<!-- 用户管理 Tab 内容结束 -->

<!-- 编辑文本模态框 -->
<div class="modal-overlay" id="editModal" style="display: none;" onclick="closeEditModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h4 class="modal-title">编辑文本知识条目</h4>
            <button type="button" class="modal-close" onclick="closeEditModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="editForm" method="post">
            <div class="modal-body">
                <div class="form-group">
                    <label for="editTitle" class="form-label">标题</label>
                    <input type="text" class="form-control" id="editTitle" name="title" required>
                </div>
                <div class="form-group">
                    <label for="editContent" class="form-label">内容</label>
                    <textarea class="form-control" id="editContent" name="content" rows="8" required></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeEditModal()">取消</button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-2"></i>
                    保存更改
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// 在页面顶部定义全局函数，确保按钮点击时可用
function switchTab(tabName) {
    console.log('Switching to tab:', tabName);

    // 移除所有tab按钮的active类
    document.querySelectorAll('.admin-tab-btn').forEach(btn => {
        btn.classList.remove('active');
    });

    // 隐藏所有tab内容
    document.querySelectorAll('.admin-tab-content').forEach(content => {
        content.style.display = 'none';
    });

    // 激活当前tab按钮
    const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
    if (activeBtn) {
        activeBtn.classList.add('active');
    }

    // 显示当前tab内容
    const activeContent = document.getElementById(`${tabName}-tab`);
    if (activeContent) {
        activeContent.style.display = 'block';
    }

    // 如果切换到用户管理tab，加载用户数据
    if (tabName === 'users' && typeof loadUsersData === 'function') {
        loadUsersData();
    }
}

// 简单的提示功能
function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = 'alert alert-' + (type === 'success' ? 'success' : 'danger') + ' position-fixed';
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    toast.innerHTML = '<i class="fas fa-' + (type === 'success' ? 'check-circle' : 'exclamation-circle') + '"></i> ' + message + ' <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>';
    document.body.appendChild(toast);

    // 5秒后自动消失
    setTimeout(() => {
        if (toast.parentNode) {
            toast.remove();
        }
    }, 5000);
}

// 确保函数是全局可访问的
window.switchTab = switchTab;
console.log('switchTab function defined globally');

// 确保管理中心的消息提示也能自动消失
    function initAutoHideMessages() {
        const messageSelectors = [
            '.alert', 
            '.flash-message', 
            '.message', 
            '.notification',
            '[class*="alert"]',
            '[class*="success"]',
            '[class*="error"]',
            '[class*="message"]'
        ];

        const allMessages = [];
        messageSelectors.forEach(selector => {
            const elements = document.querySelectorAll(selector);
            elements.forEach(el => {
                // 确保只选取可见的元素，并且是直接子元素，避免重复添加
                if (!allMessages.includes(el) && el.offsetParent !== null && el.parentElement === document.body) {
                    allMessages.push(el);
                }
            });
        });

        allMessages.forEach(function(alert) {
            // 添加关闭按钮
            if (!alert.querySelector('.btn-close') && !alert.querySelector('[onclick*="remove"]')) {
                const closeBtn = document.createElement('button');
                closeBtn.type = 'button';
                closeBtn.className = 'btn-close';
                closeBtn.style.cssText = `
                    position: absolute;
                    top: 8px;
                    right: 8px;
                    background: none;
                    border: none;
                    font-size: 20px;
                    cursor: pointer;
                    opacity: 0.7;
                    padding: 4px;
                `;
                closeBtn.innerHTML = '×';
                closeBtn.onclick = function() {
                    removeMessage(alert);
                };
                alert.style.position = 'relative';
                alert.appendChild(closeBtn);
            }

            // 5秒后自动消失
            setTimeout(function() {
                removeMessage(alert);
            }, 5000);
        });

        function removeMessage(element) {
            if (element && element.parentNode) {
                element.style.transition = 'all 0.3s ease';
                element.style.opacity = '0';
                element.style.transform = 'translateY(-20px)';
                setTimeout(() => {
                    if (element.parentNode) {
                        element.remove();
                    }
                }, 300);
            }
        }
    }

    // 立即执行一次
    initAutoHideMessages();

    // 监听页面变化（比如切换标签页后，或者AJAX加载内容后）
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            // 检查是否有新的节点被添加
            if (mutation.addedNodes.length > 0) {
                // 稍微延迟执行，确保新元素已渲染
                setTimeout(initAutoHideMessages, 100);
            }
        });
    });

    // 监听整个文档的子节点变化
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
</script>
{% endblock %}