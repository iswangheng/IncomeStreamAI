{% extends "admin/base_apple.html" %}

{% block title %}用户管理 - Angela AI{% endblock %}

{% block content %}
<!-- 页面标题区域 -->
<div class="admin-page-header">
    <h1 class="admin-page-title">用户管理</h1>
    <p class="admin-page-subtitle">管理系统用户账户和权限</p>
</div>

<!-- 统计卡片 -->
<div class="stats-grid">
    <div class="stats-card fade-in">
        <div class="stats-header">
            <div class="stats-icon" style="background: var(--color-primary);">
                <i class="fas fa-users"></i>
            </div>
        </div>
        <div class="stats-value">{{ users|length }}</div>
        <div class="stats-label">总用户数</div>
        <div class="stats-change positive">
            <i class="fas fa-arrow-up me-1"></i>
            系统用户
        </div>
    </div>
    
    <div class="stats-card fade-in" style="animation-delay: 0.1s;">
        <div class="stats-header">
            <div class="stats-icon" style="background: var(--status-active);">
                <i class="fas fa-user-check"></i>
            </div>
        </div>
        <div class="stats-value">{{ users|selectattr("active", "equalto", true)|list|length }}</div>
        <div class="stats-label">活跃用户</div>
        <div class="stats-change positive">
            <i class="fas fa-check me-1"></i>
            正常使用
        </div>
    </div>
    
    <div class="stats-card fade-in" style="animation-delay: 0.2s;">
        <div class="stats-header">
            <div class="stats-icon" style="background: var(--color-accent);">
                <i class="fas fa-user-plus"></i>
            </div>
        </div>
        <div class="stats-value">{{ users|selectattr("last_login", "none")|list|length }}</div>
        <div class="stats-label">新用户</div>
        <div class="stats-change">
            <i class="fas fa-calendar me-1"></i>
            未登录过
        </div>
    </div>
    
    <div class="stats-card fade-in" style="animation-delay: 0.3s;">
        <div class="stats-header">
            <div class="stats-icon" style="background: var(--status-paused);">
                <i class="fas fa-clock"></i>
            </div>
        </div>
        <div class="stats-value">{{ users|selectattr("last_login", "ne", none)|list|length }}</div>
        <div class="stats-label">已登录用户</div>
        <div class="stats-change">
            <i class="fas fa-sign-in-alt me-1"></i>
            有登录记录
        </div>
    </div>
</div>

<!-- 操作工具栏 -->
<div class="table-filters fade-in" style="animation-delay: 0.4s;">
    <div class="filters-left">
        <div class="search-wrapper">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="filter-input" placeholder="搜索用户姓名或手机号..." value="{{ search_query }}" 
                   onkeyup="searchUsers(this.value)">
        </div>
    </div>
    <div class="filters-right">
        <a href="{{ url_for('admin_add_user') }}" class="btn btn-primary interactive">
            <i class="fas fa-user-plus"></i>
            添加新用户
        </a>
    </div>
</div>

<!-- 用户表格 - 响应式设计 -->
<div class="table-container fade-in" style="animation-delay: 0.5s;">
    <!-- 桌面端表格视图 -->
    <div class="desktop-table-view">
        <table class="data-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>姓名</th>
                    <th>手机号</th>
                    <th>用户类型</th>
                    <th>状态</th>
                    <th>创建时间</th>
                    <th>最后登录</th>
                    <th class="text-center">操作</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr class="table-row-hover">
                    <td>{{ user.id }}</td>
                    <td>
                        <div class="user-info">
                            <div class="user-avatar-small">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="user-details">
                                <strong>{{ user.name or '未设置' }}</strong>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="phone-number">{{ user.phone }}</span>
                    </td>
                    <td>
                        <span class="user-type-badge {% if user.is_admin %}admin{% endif %}">
                            {% if user.is_admin %}
                                <i class="fas fa-user-shield"></i>
                                管理员
                            {% else %}
                                <i class="fas fa-user"></i>
                                普通用户
                            {% endif %}
                        </span>
                    </td>
                    <td>
                        {% if user.active %}
                            <span class="status-badge status-active">
                                <i class="fas fa-check-circle"></i>
                                活跃
                            </span>
                        {% else %}
                            <span class="status-badge status-paused">
                                <i class="fas fa-pause-circle"></i>
                                停用
                            </span>
                        {% endif %}
                    </td>
                    <td>
                        <span class="datetime-display">{{ user.created_at_display }}</span>
                    </td>
                    <td>
                        <span class="datetime-display">{{ user.last_login_display }}</span>
                    </td>
                    <td class="text-center">
                        <div class="action-buttons">
                            <a href="{{ url_for('admin_edit_user', user_id=user.id) }}" 
                               class="action-btn edit" 
                               title="编辑用户">
                                <i class="fas fa-edit"></i>
                            </a>
                            {% if user.id != current_user.id %}
                            <button type="button" 
                                    class="action-btn delete" 
                                    onclick="confirmDelete({{ user.id }}, '{{ user.name or user.phone }}')"
                                    title="删除用户">
                                <i class="fas fa-trash"></i>
                            </button>
                            {% endif %}
                        </div>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="8" class="text-center py-5">
                        <div class="empty-state">
                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                            <h5>暂无用户数据</h5>
                            <p class="text-muted">还没有注册的用户</p>
                            <a href="{{ url_for('admin_add_user') }}" class="btn btn-primary">
                                <i class="fas fa-user-plus me-2"></i>
                                添加第一个用户
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- 移动端卡片视图 -->
    <div class="mobile-cards-view">
        {% for user in users %}
        <div class="user-card">
            <div class="user-card-header">
                <div class="user-main-info">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-basic">
                        <h4 class="user-name">{{ user.name or '未设置' }}</h4>
                        <p class="user-phone">{{ user.phone }}</p>
                    </div>
                </div>
                <div class="user-id">
                    <span class="id-label">ID</span>
                    <span class="id-value">{{ user.id }}</span>
                </div>
            </div>
            
            <div class="user-card-body">
                <div class="user-card-row">
                    <div class="card-field">
                        <label>用户类型</label>
                        <span class="user-type-badge {% if user.is_admin %}admin{% endif %}">
                            {% if user.is_admin %}
                                <i class="fas fa-user-shield"></i>
                                管理员
                            {% else %}
                                <i class="fas fa-user"></i>
                                普通用户
                            {% endif %}
                        </span>
                    </div>
                    <div class="card-field">
                        <label>状态</label>
                        {% if user.active %}
                            <span class="status-badge status-active">
                                <i class="fas fa-check-circle"></i>
                                活跃
                            </span>
                        {% else %}
                            <span class="status-badge status-paused">
                                <i class="fas fa-pause-circle"></i>
                                停用
                            </span>
                        {% endif %}
                    </div>
                </div>
                
                <div class="user-card-row">
                    <div class="card-field">
                        <label>创建时间</label>
                        <span class="datetime-value">{{ user.created_at_display }}</span>
                    </div>
                </div>
                
                <div class="user-card-row">
                    <div class="card-field">
                        <label>最后登录</label>
                        <span class="datetime-value">{{ user.last_login_display }}</span>
                    </div>
                </div>
            </div>
            
            <div class="user-card-actions">
                <a href="{{ url_for('admin_edit_user', user_id=user.id) }}" 
                   class="mobile-action-btn edit">
                    <i class="fas fa-edit"></i>
                    编辑
                </a>
                {% if user.id != current_user.id %}
                <button type="button" 
                        class="mobile-action-btn delete" 
                        onclick="confirmDelete({{ user.id }}, '{{ user.name or user.phone }}')">
                    <i class="fas fa-trash"></i>
                    删除
                </button>
                {% endif %}
            </div>
        </div>
        {% else %}
        <div class="mobile-empty-state">
            <div class="empty-icon">
                <i class="fas fa-users"></i>
            </div>
            <h3>暂无用户数据</h3>
            <p>还没有注册的用户</p>
            <a href="{{ url_for('admin_add_user') }}" class="btn btn-primary">
                <i class="fas fa-user-plus"></i>
                添加第一个用户
            </a>
        </div>
        {% endfor %}
    </div>
</div>

<!-- 删除确认模态框 -->
<div id="deleteModal" class="modal-overlay" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    确认删除
                </h5>
                <button type="button" class="modal-close" onclick="closeDeleteModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p>您确定要删除用户 "<span id="deleteUserName"></span>" 吗？</p>
                <p class="text-danger"><small>此操作不可撤销！</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">取消</button>
                <form id="deleteForm" method="post" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>
                        确认删除
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// 搜索用户功能
function searchUsers(query) {
    const url = new URL(window.location);
    if (query.trim()) {
        url.searchParams.set('search', query);
    } else {
        url.searchParams.delete('search');
    }
    window.location.href = url.toString();
}

// 删除确认
function confirmDelete(userId, userName) {
    document.getElementById('deleteUserName').textContent = userName;
    document.getElementById('deleteForm').action = `/admin/users/${userId}/delete`;
    document.getElementById('deleteModal').style.display = 'flex';
}

function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
}

// ESC键关闭模态框
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeDeleteModal();
    }
});

// 点击模态框外部关闭
document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDeleteModal();
    }
});
</script>

<style>
/* 基础样式 */
.user-info {
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.user-avatar-small {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--color-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 14px;
}

.phone-number {
    font-family: var(--font-mono);
    font-weight: 500;
}

.datetime-display {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
}

.user-type-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-1) var(--space-3);
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
    border-radius: var(--radius-md);
    background: var(--color-gray-100);
    color: var(--color-text-secondary);
    white-space: nowrap;
}

.user-type-badge.admin {
    background: var(--color-secondary);
    color: white;
}

.action-buttons {
    display: flex;
    gap: var(--space-2);
    justify-content: center;
}

.empty-state {
    padding: var(--space-8);
}

/* 响应式视图控制 */
.mobile-cards-view {
    display: none;
}

.desktop-table-view {
    display: block;
}

/* 移动端适配 */
@media (max-width: 768px) {
    .desktop-table-view {
        display: none;
    }
    
    .mobile-cards-view {
        display: block;
        padding: 0;
    }
    
    /* 用户卡片样式 */
    .user-card {
        background: var(--color-bg-primary);
        border-radius: var(--radius-xl);
        box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
        border: 1px solid var(--color-gray-200);
        margin-bottom: var(--space-4);
        overflow: hidden;
        transition: all 0.3s ease;
    }
    
    .user-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 20px rgba(0, 122, 255, 0.15);
    }
    
    /* 卡片头部 */
    .user-card-header {
        padding: var(--space-4);
        background: linear-gradient(135deg, rgba(0, 122, 255, 0.05) 0%, rgba(255, 255, 255, 0.8) 100%);
        border-bottom: 1px solid var(--color-gray-200);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .user-main-info {
        display: flex;
        align-items: center;
        gap: var(--space-3);
        flex: 1;
    }
    
    .user-avatar {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        background: var(--color-primary);
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 18px;
        flex-shrink: 0;
    }
    
    .user-basic {
        flex: 1;
        min-width: 0;
    }
    
    .user-name {
        font-size: var(--text-lg);
        font-weight: var(--font-semibold);
        color: var(--color-text-primary);
        margin: 0 0 4px 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    .user-phone {
        font-size: var(--text-sm);
        color: var(--color-text-secondary);
        font-family: var(--font-mono);
        margin: 0;
        font-weight: 500;
    }
    
    .user-id {
        display: flex;
        flex-direction: column;
        align-items: center;
        background: rgba(0, 122, 255, 0.1);
        padding: var(--space-2);
        border-radius: var(--radius-md);
        min-width: 50px;
    }
    
    .id-label {
        font-size: 10px;
        color: var(--color-primary);
        font-weight: var(--font-medium);
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .id-value {
        font-size: var(--text-base);
        font-weight: var(--font-bold);
        color: var(--color-primary);
    }
    
    /* 卡片内容 */
    .user-card-body {
        padding: var(--space-4);
    }
    
    .user-card-row {
        display: flex;
        gap: var(--space-4);
        margin-bottom: var(--space-3);
    }
    
    .user-card-row:last-child {
        margin-bottom: 0;
    }
    
    .card-field {
        flex: 1;
        min-width: 0;
    }
    
    .card-field label {
        display: block;
        font-size: 11px;
        color: var(--color-text-tertiary);
        font-weight: var(--font-medium);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }
    
    .datetime-value {
        font-size: var(--text-xs);
        color: var(--color-text-secondary);
        line-height: 1.3;
    }
    
    /* 卡片操作区 */
    .user-card-actions {
        padding: var(--space-3) var(--space-4);
        background: var(--color-gray-50);
        border-top: 1px solid var(--color-gray-200);
        display: flex;
        gap: var(--space-3);
    }
    
    .mobile-action-btn {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: var(--space-2);
        padding: var(--space-3) var(--space-4);
        border-radius: var(--radius-lg);
        font-size: var(--text-sm);
        font-weight: var(--font-medium);
        text-decoration: none;
        transition: all 0.2s ease;
        border: none;
        cursor: pointer;
        min-height: 44px;
        touch-action: manipulation;
        user-select: none;
        -webkit-user-select: none;
        -webkit-tap-highlight-color: transparent;
    }
    
    .mobile-action-btn.edit {
        background: var(--color-primary);
        color: white;
    }
    
    .mobile-action-btn.edit:hover {
        background: var(--color-primary-dark);
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
    }
    
    .mobile-action-btn.delete {
        background: var(--status-deleted);
        color: white;
    }
    
    .mobile-action-btn.delete:hover {
        background: #c62828;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(255, 59, 48, 0.3);
    }
    
    /* 移动端空状态 */
    .mobile-empty-state {
        text-align: center;
        padding: var(--space-8) var(--space-4);
    }
    
    .empty-icon {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: var(--color-gray-100);
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto var(--space-4);
        color: var(--color-text-tertiary);
        font-size: var(--text-2xl);
    }
    
    .mobile-empty-state h3 {
        font-size: var(--text-lg);
        font-weight: var(--font-semibold);
        color: var(--color-text-primary);
        margin: 0 0 var(--space-2);
    }
    
    .mobile-empty-state p {
        font-size: var(--text-sm);
        color: var(--color-text-secondary);
        margin: 0 0 var(--space-6);
    }
}

/* 超小屏幕优化 */
@media (max-width: 480px) {
    .user-card {
        margin-bottom: var(--space-3);
        border-radius: var(--radius-lg);
    }
    
    .user-card-header {
        padding: var(--space-3);
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-3);
    }
    
    .user-main-info {
        width: 100%;
    }
    
    .user-id {
        align-self: flex-end;
    }
    
    .user-card-body {
        padding: var(--space-3);
    }
    
    .user-card-row {
        flex-direction: column;
        gap: var(--space-3);
    }
    
    .user-card-actions {
        padding: var(--space-3);
        flex-direction: column;
        gap: var(--space-2);
    }
    
    .mobile-action-btn {
        min-height: 48px;
    }
}

/* 模态框样式 */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    backdrop-filter: blur(4px);
}

.modal-dialog {
    max-width: 500px;
    width: 90%;
}

.modal-content {
    background: var(--color-bg-primary);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl);
    overflow: hidden;
}

.modal-header {
    padding: var(--space-6);
    border-bottom: 1px solid var(--color-gray-200);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.modal-title {
    margin: 0;
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
}

.modal-close {
    background: none;
    border: none;
    font-size: var(--text-lg);
    color: var(--color-text-secondary);
    cursor: pointer;
    padding: var(--space-2);
    border-radius: var(--radius-md);
    transition: var(--transition-fast);
}

.modal-close:hover {
    background: var(--color-gray-100);
    color: var(--color-text-primary);
}

.modal-body {
    padding: var(--space-6);
}

.modal-footer {
    padding: var(--space-6);
    border-top: 1px solid var(--color-gray-200);
    display: flex;
    gap: var(--space-3);
    justify-content: flex-end;
}

@media (max-width: 768px) {
    .modal-dialog {
        width: 95%;
        margin: var(--space-4);
    }
    
    .modal-header,
    .modal-body,
    .modal-footer {
        padding: var(--space-4);
    }
    
    .modal-footer {
        flex-direction: column;
        gap: var(--space-2);
    }
    
    .modal-footer button,
    .modal-footer .btn {
        width: 100%;
        min-height: 44px;
        justify-content: center;
    }
}
</style>
{% endblock %}