{% extends "admin/base_apple.html" %}

{% block title %}用户管理 - Angela AI{% endblock %}

{% block content %}
<!-- 页面标题区域 -->
<div class="admin-page-header">
    <h1 class="admin-page-title">用户管理</h1>
    <p class="admin-page-subtitle">管理系统用户账户和权限</p>
</div>

<!-- 统计卡片 -->
<div class="stats-grid">
    <div class="stats-card fade-in">
        <div class="stats-header">
            <div class="stats-icon" style="background: var(--color-primary);">
                <i class="fas fa-users"></i>
            </div>
        </div>
        <div class="stats-value">{{ users|length }}</div>
        <div class="stats-label">总用户数</div>
        <div class="stats-change positive">
            <i class="fas fa-arrow-up me-1"></i>
            系统用户
        </div>
    </div>
    
    <div class="stats-card fade-in" style="animation-delay: 0.1s;">
        <div class="stats-header">
            <div class="stats-icon" style="background: var(--status-active);">
                <i class="fas fa-user-check"></i>
            </div>
        </div>
        <div class="stats-value">{{ users|selectattr("active", "equalto", true)|list|length }}</div>
        <div class="stats-label">活跃用户</div>
        <div class="stats-change positive">
            <i class="fas fa-check me-1"></i>
            正常使用
        </div>
    </div>
    
    <div class="stats-card fade-in" style="animation-delay: 0.2s;">
        <div class="stats-header">
            <div class="stats-icon" style="background: var(--color-accent);">
                <i class="fas fa-user-plus"></i>
            </div>
        </div>
        <div class="stats-value">{{ users|selectattr("last_login", "none")|list|length }}</div>
        <div class="stats-label">新用户</div>
        <div class="stats-change">
            <i class="fas fa-calendar me-1"></i>
            未登录过
        </div>
    </div>
    
    <div class="stats-card fade-in" style="animation-delay: 0.3s;">
        <div class="stats-header">
            <div class="stats-icon" style="background: var(--status-paused);">
                <i class="fas fa-clock"></i>
            </div>
        </div>
        <div class="stats-value">{{ users|selectattr("last_login", "ne", none)|list|length }}</div>
        <div class="stats-label">已登录用户</div>
        <div class="stats-change">
            <i class="fas fa-sign-in-alt me-1"></i>
            有登录记录
        </div>
    </div>
</div>

<!-- 操作工具栏 -->
<div class="table-filters fade-in" style="animation-delay: 0.4s;">
    <div class="filters-left">
        <div class="search-wrapper">
            <i class="fas fa-search search-icon"></i>
            <input type="text" class="filter-input" placeholder="搜索用户姓名或手机号..." value="{{ search_query }}" 
                   onkeyup="searchUsers(this.value)">
        </div>
    </div>
    <div class="filters-right">
        <a href="{{ url_for('admin_add_user') }}" class="btn btn-primary interactive">
            <i class="fas fa-user-plus"></i>
            添加新用户
        </a>
    </div>
</div>

<!-- 用户表格 -->
<div class="table-container fade-in" style="animation-delay: 0.5s;">
    <table class="data-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>姓名</th>
                <th>手机号</th>
                <th>状态</th>
                <th>创建时间</th>
                <th>最后登录</th>
                <th class="text-center">操作</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr class="table-row-hover">
                <td>{{ user.id }}</td>
                <td>
                    <div class="user-info">
                        <div class="user-avatar-small">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="user-details">
                            <strong>{{ user.name or '未设置' }}</strong>
                        </div>
                    </div>
                </td>
                <td>
                    <span class="phone-number">{{ user.phone }}</span>
                </td>
                <td>
                    {% if user.active %}
                        <span class="status-badge status-active">
                            <i class="fas fa-check-circle"></i>
                            活跃
                        </span>
                    {% else %}
                        <span class="status-badge status-paused">
                            <i class="fas fa-pause-circle"></i>
                            停用
                        </span>
                    {% endif %}
                </td>
                <td>
                    <span class="datetime-display">{{ user.created_at_display }}</span>
                </td>
                <td>
                    <span class="datetime-display">{{ user.last_login_display }}</span>
                </td>
                <td class="text-center">
                    <div class="action-buttons">
                        <a href="{{ url_for('admin_edit_user', user_id=user.id) }}" 
                           class="btn btn-sm btn-outline-primary" 
                           title="编辑用户">
                            <i class="fas fa-edit"></i>
                        </a>
                        {% if user.id != current_user.id %}
                        <button type="button" 
                                class="btn btn-sm btn-outline-danger" 
                                onclick="confirmDelete({{ user.id }}, '{{ user.name or user.phone }}')"
                                title="删除用户">
                            <i class="fas fa-trash"></i>
                        </button>
                        {% endif %}
                    </div>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="7" class="text-center py-5">
                    <div class="empty-state">
                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                        <h5>暂无用户数据</h5>
                        <p class="text-muted">还没有注册的用户</p>
                        <a href="{{ url_for('admin_add_user') }}" class="btn btn-primary">
                            <i class="fas fa-user-plus me-2"></i>
                            添加第一个用户
                        </a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- 删除确认模态框 -->
<div id="deleteModal" class="modal-overlay" style="display: none;">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    确认删除
                </h5>
                <button type="button" class="modal-close" onclick="closeDeleteModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <p>您确定要删除用户 "<span id="deleteUserName"></span>" 吗？</p>
                <p class="text-danger"><small>此操作不可撤销！</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">取消</button>
                <form id="deleteForm" method="post" style="display: inline;">
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-2"></i>
                        确认删除
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// 搜索用户功能
function searchUsers(query) {
    const url = new URL(window.location);
    if (query.trim()) {
        url.searchParams.set('search', query);
    } else {
        url.searchParams.delete('search');
    }
    window.location.href = url.toString();
}

// 删除确认
function confirmDelete(userId, userName) {
    document.getElementById('deleteUserName').textContent = userName;
    document.getElementById('deleteForm').action = `/admin/users/${userId}/delete`;
    document.getElementById('deleteModal').style.display = 'flex';
}

function closeDeleteModal() {
    document.getElementById('deleteModal').style.display = 'none';
}

// ESC键关闭模态框
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeDeleteModal();
    }
});

// 点击模态框外部关闭
document.getElementById('deleteModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeDeleteModal();
    }
});
</script>

<style>
.user-info {
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.user-avatar-small {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: var(--color-primary);
    display: flex;
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 14px;
}

.phone-number {
    font-family: var(--font-mono);
    font-weight: 500;
}

.datetime-display {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
}

.action-buttons {
    display: flex;
    gap: var(--space-2);
    justify-content: center;
}

.empty-state {
    padding: var(--space-8);
}

.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    backdrop-filter: blur(4px);
}

.modal-dialog {
    max-width: 500px;
    width: 90%;
}

.modal-content {
    background: var(--color-bg-primary);
    border-radius: var(--radius-lg);
    box-shadow: var(--shadow-xl);
    overflow: hidden;
}

.modal-header {
    padding: var(--space-6);
    border-bottom: 1px solid var(--color-gray-200);
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.modal-title {
    margin: 0;
    font-size: var(--text-lg);
    font-weight: var(--font-semibold);
}

.modal-close {
    background: none;
    border: none;
    font-size: var(--text-lg);
    color: var(--color-text-secondary);
    cursor: pointer;
    padding: var(--space-2);
    border-radius: var(--radius-md);
    transition: var(--transition-fast);
}

.modal-close:hover {
    background: var(--color-gray-100);
    color: var(--color-text-primary);
}

.modal-body {
    padding: var(--space-6);
}

.modal-footer {
    padding: var(--space-6);
    border-top: 1px solid var(--color-gray-200);
    display: flex;
    gap: var(--space-3);
    justify-content: flex-end;
}
</style>
{% endblock %}