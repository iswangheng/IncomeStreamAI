<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Angela · 非劳务收入管道设计师</title>

    <!-- 预加载关键字体 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Apple级别设计系统 -->
    <link href="{{ url_for('static', filename='css/apple-design-system.css') }}" rel="stylesheet">
    <!-- 未来科幻增强版设计系统 -->
    <link href="{{ url_for('static', filename='css/future-enhanced-apple.css') }}" rel="stylesheet">
    <!-- 按钮修复样式 -->
    <link href="{{ url_for('static', filename='css/button-fix.css') }}" rel="stylesheet">
    <!-- 用户认证样式 -->
    <link href="{{ url_for('static', filename='css/auth-styles.css') }}" rel="stylesheet">
    <!-- 世界一流导航设计 -->
    <link href="{{ url_for('static', filename='css/navigation-redesign.css') }}" rel="stylesheet">
    <!-- 用户菜单下拉设计 -->
    <link href="{{ url_for('static', filename='css/user-menu-dropdown.css') }}" rel="stylesheet">
    <!-- 导航栏间距修复 - 解决顶部空白问题 -->
    <link href="{{ url_for('static', filename='css/navigation-spacing-fix.css') }}" rel="stylesheet">
    <!-- 移动端导航样式 - 确保移动端正常显示 -->
    <link href="{{ url_for('static', filename='css/mobile-navigation-isolated.css') }}" rel="stylesheet">

    <!-- SEO优化 -->
    <meta name="description" content="Angela - Apple级别AI驱动的非劳务收入管道设计工具，世界一流的用户体验">
    <meta name="keywords" content="AI收入设计,非劳务收入,智能管道,商业策略,Apple设计">
</head>
<body>
    <!-- 引用公共导航栏组件 -->
    {% include 'components/navigation.html' %}

    <!-- 主要内容区域 -->
    <main class="main-content">
        <!-- 页面标题区域 -->
        <header class="page-header">
            <h1 class="page-title">非劳务收入管道设计师</h1>
            <p class="page-subtitle">根据您的项目和关键人物信息，生成个性化的非劳务收入管道方案</p>

            <!-- 测试案例选择区域 -->
            <div class="demo-cases-section">
                <div class="demo-cases-header">
                    <h3>
                        <i class="fas fa-lightbulb"></i>
                        快速开始-选择示例案例
                    </h3>
                    <p>选择下方任一真实案例，快速体验Angela AI的分析能力</p>
                </div>
                <div class="demo-cases-grid">
                    <div class="demo-case-card" data-case="english-training">
                        <div class="case-icon">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <div class="case-content">
                            <h4>在线口语陪练连接平台</h4>
                            <p>连接升学规划师客户和专业外教，打造标准化口语培训产品，3方共赢收入管道</p>
                            <div class="case-tags">
                                <span class="tag">在线教育</span>
                                <span class="tag">资源连接</span>
                            </div>
                        </div>
                    </div>

                    <div class="demo-case-card" data-case="rental-business">
                        <div class="case-icon">
                            <i class="fas fa-building"></i>
                        </div>
                        <div class="case-content">
                            <h4>社区生活服务集合店</h4>
                            <p>整租商铺分区转包，打造便利店+美甲+托管一体化社区服务，客户互导增收</p>
                            <div class="case-tags">
                                <span class="tag">社区服务</span>
                                <span class="tag">业态整合</span>
                            </div>
                        </div>
                    </div>

                    <div class="demo-case-card" data-case="cicada-farming">
                        <div class="case-icon">
                            <i class="fas fa-seedling"></i>
                        </div>
                        <div class="case-content">
                            <h4>订单农业知了猴供应链</h4>
                            <p>建立标准化养殖收购体系，连接林农、专家、餐厅，年产值目标50万供应链</p>
                            <div class="case-tags">
                                <span class="tag">订单农业</span>
                                <span class="tag">供应链整合</span>
                            </div>
                        </div>
                    </div>

                    <div class="demo-case-card" data-case="custom">
                        <div class="case-icon">
                            <i class="fas fa-edit"></i>
                        </div>
                        <div class="case-content">
                            <h4>自定义项目</h4>
                            <p>根据您的实际情况，从零开始设计专属的非劳务收入方案</p>
                            <div class="case-tags">
                                <span class="tag">个性定制</span>
                                <span class="tag">原创设计</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div style="margin-bottom: var(--space-8);">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'error' if category == 'error' else 'info' }} slide-up">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- 主要表单 -->
        <form method="POST" action="{{ url_for('generate') }}" id="mainForm">

            <!-- 项目基础信息模块 -->
            <div class="card interactive-hover">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-rocket"></i>
                        项目基础信息
                    </h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="project_name" class="form-label">项目名称</label>
                        <input type="text" class="form-control" id="project_name" name="project_name" 
                               placeholder="请输入您的项目名称" required>
                    </div>

                    <div class="form-group">
                        <label for="project_description" class="form-label">项目背景描述</label>
                        <textarea class="form-control" id="project_description" name="project_description" 
                                  placeholder="详细描述您的项目背景、目标和现状..." required></textarea>
                    </div>



                </div>
            </div>

            <!-- 关键人物清单（概览表格） -->
            <div class="card interactive-hover">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-list-alt"></i>
                        关键人物清单
                    </h3>
                    <small class="text-muted">项目中所有关键人物的概览，支持快速添加和编辑</small>
                </div>
                <div class="card-body">
                    <div class="personnel-overview-container">
                        <!-- 表格头部 -->
                        <div class="personnel-table-header">
                            <div class="table-column col-number">#</div>
                            <div class="table-column col-name">姓名/代号</div>
                            <div class="table-column col-roles">身份角色</div>
                            <div class="table-column col-resources">掌握资源</div>
                            <div class="table-column col-needs">如何让TA高兴</div>
                            <div class="table-column col-actions">操作</div>
                        </div>

                        <!-- 表格内容区域 -->
                        <div class="personnel-table-body" id="personnelTableBody">
                            <div class="empty-personnel-state">
                                <div class="empty-state-content">
                                    <i class="fas fa-users-slash"></i>
                                    <h4>还没有添加关键人物</h4>
                                    <p>点击下方按钮开始添加项目中的关键人物</p>
                                </div>
                            </div>
                        </div>

                        <!-- 快速添加按钮 -->
                        <div class="personnel-quick-add">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addNewPersonnel()">
                                <i class="fas fa-plus"></i>
                                快速添加人物
                            </button>
                        </div>

                        <!-- 隐藏的表单字段用于提交 -->
                        <div style="display: none;" id="hiddenPersonnelData">
                            <!-- 人物数据将动态添加到这里 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 提交按钮 -->
            <div style="text-align: center; margin-top: 32px; padding-top: 24px; border-top: 1px solid rgba(0, 0, 0, 0.1);">
                <button type="submit" class="btn btn-primary btn-large interactive gpu-accelerated">
                    <i class="fas fa-magic me-2"></i>
                    开始AI智能分析
                </button>
                <p style="margin-top: 16px; color: #667680; font-size: 14px;">
                    基于您提供的信息，AI将在几秒内生成专业的收入管道设计方案
                </p>
            </div>
        </form>
    </main>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/future-enhanced-interactions.js') }}"></script>
    <script src="{{ url_for('static', filename='js/user-menu.js') }}"></script>
    <script src="{{ url_for('static', filename='js/mobile-menu.js') }}"></script>
    <script>
        // Navigation Enhancement Script
        document.addEventListener('DOMContentLoaded', function() {
            const navbar = document.querySelector('.navigation-bar');

            // Add scroll effect to navigation
            let lastScrollTop = 0;
            window.addEventListener('scroll', function() {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

                if (scrollTop > 20) {
                    navbar.classList.add('scrolled');
                } else {
                    navbar.classList.remove('scrolled');
                }

                lastScrollTop = scrollTop;
            });

            // Enhanced button interactions
            const navButtons = document.querySelectorAll('.nav-actions .btn');
            navButtons.forEach(button => {
                button.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-1px)';
                });

                button.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                });

                button.addEventListener('click', function(e) {
                    // Add ripple effect
                    const ripple = document.createElement('span');
                    ripple.classList.add('ripple');

                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    const x = e.clientX - rect.left - size / 2;
                    const y = e.clientY - rect.top - size / 2;

                    ripple.style.width = ripple.style.height = size + 'px';
                    ripple.style.left = x + 'px';
                    ripple.style.top = y + 'px';

                    this.appendChild(ripple);

                    setTimeout(() => {
                        ripple.remove();
                    }, 600);
                });
            });

            // Mobile menu toggle for very small screens
            function handleResponsiveNavigation() {
                const navActions = document.querySelector('.nav-actions');
                const userMenu = document.querySelector('.user-menu');

                if (window.innerWidth <= 480) {
                    navActions.style.flexDirection = 'column';
                    userMenu.style.flexDirection = 'column';
                } else if (window.innerWidth <= 768) {
                    navActions.style.flexDirection = 'row';
                    userMenu.style.flexDirection = 'row';
                }
            }

            // Handle resize events
            window.addEventListener('resize', handleResponsiveNavigation);
            handleResponsiveNavigation(); // Initial call
        });
    </script>
    <script>
        // 初始化功能
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化交互功能
            initializeInteractions();
            // 初始化独立人物清单表格
            updatePersonnelTable();
            // 设置输入框的随机提示语
            setRandomPlaceholder();
            // 处理测试案例选择
            handleDemoCaseSelection();
        });





        // 角色到资源的映射
        const roleToResourceSuggestions = {
            // 需求方
            "enterprise_owner": ["采购预算", "项目立项权", "签约权限", "内部宣传位", "企业客户名单", "决策权"],
            "store_owner": ["店铺空间", "客流量", "本地资源", "营业执照", "店面展示位", "顾客数据", "采购预算", "签约权限", "决策权"],
            "department_head": ["部门预算", "团队人力", "内部协调权", "KPI指标", "汇报渠道", "资源分配权", "采购预算", "签约权限", "决策权"],
            "brand_manager": ["品牌授权", "营销预算", "品牌露出机会", "用户社群", "品牌合作资源", "市场推广权", "采购预算", "签约权限", "决策权"],

            // 交付方
            "product_provider": ["产品试用名额", "样品/兑换码", "分销价权限", "售后支持", "产品授权", "库存资源"],
            "service_provider": ["专业技能", "执行团队", "服务时间", "工具平台", "交付方案", "质量保证"],
            "traffic_provider": ["用户粉丝", "媒体渠道", "社群资源", "推广位", "流量入口", "曝光机会"],
            "other_provider": ["特殊资质", "关系网络", "平台权限", "独特资源", "专业认证", "行业地位"],

            // 资金方
            "funding_provider": ["投资资金", "赞助额度", "现金预算", "投后服务", "背书资源", "融资渠道"]
        };

        // 资源示例模板
        const resourceExamples = [
            ["视频号8万粉", "社群2个", "品牌对接人：本地咖啡连锁"],
            ["SaaS试用名额100个", "API授权（14天）", "实施团队2人/2周"],
            ["赞助额度30万", "项目排期控制权", "合同模板/法务接口"]
        ];

        // 资源输入随机提示语
        const resourcePlaceholders = [
            "微信社群5个、视频号10万粉、年度广告预算50万、产品试用码100个、活动场地一天、品牌对接人：XX",
            "电商渠道位3个、线下门店2家、KOL合作位2期、媒体采访资源、API授权、课程版权",
            "企业客户名单200条、招商会场地、投委会路演名额、供应链工厂档期、施工队2组"
        ];

        // 随机设置提示语
        function setRandomPlaceholder() {
            const textareas = document.querySelectorAll('.dynamic-placeholder-textarea');
            textareas.forEach(textarea => {
                const randomText = inspirationTexts[Math.floor(Math.random() * inspirationTexts.length)];
                textarea.placeholder = `还有什么特别的点会让他愿意参与？比如：${randomText}`;
            });

            // 设置资源输入的随机提示语
            const resourceInputs = document.querySelectorAll('.dynamic-placeholder-resource');
            resourceInputs.forEach(input => {
                const randomPlaceholder = resourcePlaceholders[Math.floor(Math.random() * resourcePlaceholders.length)];
                input.placeholder = randomPlaceholder;
            });
        }



        // ==== 独立人物清单表格管理功能 ====

        // 存储人物数据的全局变量
        let personnelData = [];
        let currentEditingPersonId = null;

        // 角色映射
        const roleMapping = {
            'enterprise_owner': { text: '企业主', type: 'demand', displayText: '需求方-企业主' },
            'store_owner': { text: '实体店主', type: 'demand', displayText: '需求方-实体店主' },
            'department_head': { text: '部门负责人', type: 'demand', displayText: '需求方-部门负责人' },
            'brand_manager': { text: '主理人', type: 'demand', displayText: '需求方-主理人' },
            'product_provider': { text: '产品', type: 'delivery', displayText: '交付方-产品' },
            'service_provider': { text: '服务', type: 'delivery', displayText: '交付方-服务' },
            'traffic_provider': { text: '流量', type: 'delivery', displayText: '交付方-流量' },
            'other_provider': { text: '其他', type: 'delivery', displayText: '交付方-其他' },
            'funding_provider': { text: '资金提供方', type: 'funding', displayText: '资金提供方' }
        };

        // 添加新人物到独立表格
        function addNewPersonnel() {
            const newPerson = {
                id: Date.now(),
                name: '未命名',
                roles: [],
                resources: [],
                needs: []
            };

            personnelData.push(newPerson);
            updatePersonnelTable();

            // 立即编辑姓名
            setTimeout(() => {
                editPersonName(newPerson.id);
            }, 100);
        }

        // 更新人物清单表格
        function updatePersonnelTable() {
            const tableBody = document.getElementById('personnelTableBody');

            if (personnelData.length === 0) {
                tableBody.innerHTML = `
                    <div class="empty-personnel-state">
                        <div class="empty-state-content">
                            <i class="fas fa-users-slash"></i>
                            <h4>还没有添加关键人物</h4>
                            <p>点击下方按钮开始添加项目中的关键人物</p>
                        </div>
                    </div>
                `;
                return;
            }

            tableBody.innerHTML = '';
            personnelData.forEach((person, index) => {
                const row = createPersonnelRow(person, index + 1);
                tableBody.appendChild(row);
            });

            // 更新隐藏表单数据
            updateHiddenFormData();
        }

        // 创建人物表格行
        function createPersonnelRow(person, number) {
            const row = document.createElement('div');
            row.className = 'personnel-table-row';
            row.dataset.personId = person.id;

            // 角色标签
            const roleTagsHtml = person.roles.map(roleValue => {
                const roleInfo = roleMapping[roleValue];
                return roleInfo ? `<span class="role-tag ${roleInfo.type}">${roleInfo.displayText}</span>` : '';
            }).join('');

            // 资源摘要
            const resourcesSummary = person.resources.length > 0 ? 
                person.resources.slice(0, 2).join('、') + (person.resources.length > 2 ? '...' : '') : 
                '待添加';

            // 需求摘要
            const needsSummary = person.needs.length > 0 ? 
                person.needs.slice(0, 2).join('、') + (person.needs.length > 2 ? '...' : '') : 
                '待补充';

            row.innerHTML = `
                <!-- 桌面端表格布局 -->
                <div class="desktop-table-layout">
                    <div class="row-number">${number}</div>
                    <div class="row-name" onclick="editPersonName(${person.id})" style="cursor: pointer;">
                        ${person.name}
                    </div>
                    <div class="row-roles" onclick="editPersonRoles(${person.id})" style="cursor: pointer;">
                        ${roleTagsHtml || '<span style="color: #999;">未选择</span>'}
                    </div>
                    <div class="row-resources" onclick="editPersonResources(${person.id})" style="cursor: pointer;" title="${person.resources.join('、')}">
                        ${resourcesSummary}
                    </div>
                    <div class="row-needs" onclick="editPersonNeeds(${person.id})" style="cursor: pointer;" title="${person.needs.join('、')}">
                        ${needsSummary}
                    </div>
                    <div class="row-actions">
                        <button type="button" class="action-btn delete" onclick="deletePerson(${person.id})" title="删除此人物">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>

                <!-- 移动端卡片布局 -->
                <div class="mobile-card-layout">
                    <div class="mobile-person-header">
                        <div class="mobile-person-title">
                            <div class="row-number">${number}</div>
                            <div class="row-name" onclick="editPersonName(${person.id})" style="cursor: pointer;" title="点击编辑姓名">
                                <span class="mobile-field-prefix">姓名：</span>
                                <span class="name-content">${person.name}</span>
                                <div class="mobile-edit-hint">点击编辑</div>
                            </div>
                        </div>
                        <div class="row-actions">
                            <button type="button" class="action-btn delete" onclick="deletePerson(${person.id})" title="删除此人物">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mobile-person-content">
                        <div class="mobile-field">
                            <div class="mobile-field-label">身份角色</div>
                            <div class="mobile-field-content row-roles" onclick="editPersonRoles(${person.id})" style="cursor: pointer; padding: 8px; border-radius: 4px; transition: background-color 0.2s;" title="点击编辑身份角色">
                                ${roleTagsHtml || '<span style="color: #999;">未选择 <small>(点击编辑)</small></span>'}
                            </div>
                        </div>

                        <div class="mobile-field">
                            <div class="mobile-field-label">掌握资源</div>
                            <div class="mobile-field-content row-resources" onclick="editPersonResources(${person.id})" style="cursor: pointer; padding: 8px; border-radius: 4px; transition: background-color 0.2s;" title="点击编辑掌握资源">
                                ${resourcesSummary === '待添加' ? '<span style="color: #999;">待添加 <small>(点击编辑)</small></span>' : resourcesSummary}
                            </div>
                        </div>

                        <div class="mobile-field">
                            <div class="mobile-field-label">如何让TA高兴</div>
                            <div class="mobile-field-content row-needs" onclick="editPersonNeeds(${person.id})" style="cursor: pointer; padding: 8px; border-radius: 4px; transition: background-color 0.2s;" title="点击编辑让TA高兴的方式">
                                ${needsSummary === '待补充' ? '<span style="color: #999;">待补充 <small>(点击编辑)</small></span>' : needsSummary}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            return row;
        }

        // 编辑人物姓名（内联编辑）
        function editPersonName(personId) {
            
            const person = personnelData.find(p => p.id === personId);
            if (!person) {
                console.warn('未找到人物数据:', personId);
                return;
            }

            // 检测当前是否为移动端
            const isMobile = window.innerWidth <= 768;
            
            // 根据屏幕大小选择合适的元素
            let nameCell;
            const personRow = document.querySelector(`[data-person-id="${personId}"]`);
            
            if (!personRow) {
                console.warn('未找到人物行元素:', personId);
                return;
            }
            
            if (isMobile) {
                // 移动端：选择移动端布局中的姓名元素
                nameCell = personRow.querySelector('.mobile-card-layout .row-name');
            } else {
                // 桌面端：选择桌面端布局中的姓名元素
                nameCell = personRow.querySelector('.desktop-table-layout .row-name');
            }

            if (!nameCell) {
                nameCell = personRow.querySelector('.row-name');
            }

            if (!nameCell) {
                console.warn('完全未找到姓名元素:', personId);
                return;
            }

            // 防止重复编辑
            if (nameCell.querySelector('input')) {
                return;
            }
            
            const currentName = person.name;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentName;
            input.className = 'form-control form-control-sm name-edit-input';
            
            // 移动端优化的样式
            if (isMobile) {
                input.style.cssText = `
                    width: 100%;
                    border: 2px solid #007AFF;
                    border-radius: 8px;
                    padding: 12px;
                    font-size: 16px;
                    font-weight: 600;
                    background: white;
                    box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
                    -webkit-appearance: none;
                    -webkit-tap-highlight-color: transparent;
                `;
            } else {
                input.style.cssText = `
                    width: 100%;
                    border: 2px solid #007AFF;
                    border-radius: 6px;
                    padding: 8px;
                    font-size: 16px;
                    font-weight: 600;
                    background: white;
                    box-shadow: 0 2px 8px rgba(0, 122, 255, 0.2);
                `;
            }

            // 先显示视觉反馈
            nameCell.style.backgroundColor = '#f0f8ff';
            nameCell.style.borderRadius = '8px';
            nameCell.style.padding = '4px';
            
            // 清空内容并添加输入框
            nameCell.innerHTML = '';
            nameCell.appendChild(input);
            
            // 聚焦并选中文本
            setTimeout(() => {
                input.focus();
                input.select();
            }, 100);

            const saveName = () => {
                const newName = input.value.trim() || '未命名';
                person.name = newName;
                
                // 恢复视觉状态
                nameCell.style.backgroundColor = '';
                nameCell.style.borderRadius = '';
                nameCell.style.padding = '';
                
                updatePersonnelTable();

                // 显示保存成功提示
                showQuickToast('姓名已保存');
            };

            const cancelEdit = () => {
                // 恢复视觉状态
                nameCell.style.backgroundColor = '';
                nameCell.style.borderRadius = '';
                nameCell.style.padding = '';
                updatePersonnelTable();
            };

            // 事件监听
            input.addEventListener('blur', saveName);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveName();
                }
                if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelEdit();
                }
            });
        }

        // 快速提示函数
        function showQuickToast(message) {
            const toast = document.createElement('div');
            toast.className = 'quick-toast';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #007AFF;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;

            document.body.appendChild(toast);

            // 滑入动画
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);

            // 自动消失
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }, 2000);
        }

        // 编辑人物角色
        function editPersonRoles(personId) {
            currentEditingPersonId = personId;
            const person = personnelData.find(p => p.id === personId);
            if (!person) return;

            // 清空模态框选择
            document.querySelectorAll('#editRolesModal input[name="modal_person_role"]').forEach(checkbox => {
                checkbox.checked = person.roles.includes(checkbox.value);
            });

            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('editRolesModal'));
            modal.show();
        }

        // 编辑人物资源
        function editPersonResources(personId) {
            currentEditingPersonId = personId;
            const person = personnelData.find(p => p.id === personId);
            if (!person) return;

            // 填充当前资源
            const resourcesText = (person.resources || []).join('\n');
            document.getElementById('resourcesTextArea').value = resourcesText;

            // 根据已选择的角色生成智能推荐
            updateModalResourceSuggestions(person.roles || []);

            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('editResourcesModal'));
            modal.show();
        }

        // 为模态框更新资源推荐
        function updateModalResourceSuggestions(selectedRoles) {
            const suggestionsContainer = document.getElementById('modalResourceSuggestions');

            if (!suggestionsContainer) {
                console.warn('资源推荐容器未找到');
                return;
            }

            if (!selectedRoles || selectedRoles.length === 0) {
                suggestionsContainer.innerHTML = '<p class="text-muted">请先在角色选择中选择身份角色以获得智能推荐</p>';
                return;
            }

            // 获取所有选中角色的候选资源
            const allSuggestions = new Set();
            selectedRoles.forEach(role => {
                if (roleToResourceSuggestions[role]) {
                    roleToResourceSuggestions[role].forEach(resource => allSuggestions.add(resource));
                }
            });

            if (allSuggestions.size === 0) {
                suggestionsContainer.innerHTML = '<p class="text-muted">暂无推荐资源</p>';
                return;
            }

            // 生成推荐标签
            const tagsHtml = Array.from(allSuggestions).map(resource => 
                `<span class="suggestion-tag" onclick="addResourceSuggestion('${resource.replace(/'/g, "\\'")}')">${resource}</span>`
            ).join('');

            suggestionsContainer.innerHTML = `<div class="suggestion-tags">${tagsHtml}</div>`;
        }

        // 编辑人物需求
        function editPersonNeeds(personId) {
            currentEditingPersonId = personId;
            const person = personnelData.find(p => p.id === personId);
            if (!person) return;

            // 设置文本框内容
            document.getElementById('needsTextArea').value = person.needs.join('\n');

            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('editNeedsModal'));
            modal.show();

            // 绑定滚动事件
            setTimeout(() => {
                initNeedsStickyScroll();
            }, 300);
        }

        // 初始化粘性滚动效果
        function initNeedsStickyScroll() {
            const modalBody = document.querySelector('#editNeedsModal .modal-body');
            const stickySection = document.getElementById('needsStickySection');

            if (!modalBody || !stickySection) return;

            modalBody.addEventListener('scroll', () => {
                if (modalBody.scrollTop > 20) {
                    stickySection.classList.add('scrolled');
                } else {
                    stickySection.classList.remove('scrolled');
                }
            });
        }

        // 保存角色选择
        function saveRoles() {
            if (!currentEditingPersonId) return;

            const person = personnelData.find(p => p.id === currentEditingPersonId);
            if (!person) return;

            const selectedRoles = [];
            document.querySelectorAll('#editRolesModal input[name="modal_person_role"]:checked').forEach(checkbox => {
                selectedRoles.push(checkbox.value);
            });

            person.roles = selectedRoles;
            updatePersonnelTable();

            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('editRolesModal'));
            modal.hide();

            // 显示保存成功提示
            showQuickToast('角色已保存');
        }

        // 保存资源
        function saveResources() {
            if (!currentEditingPersonId) return;

            const person = personnelData.find(p => p.id === currentEditingPersonId);
            if (!person) return;

            const resourcesText = document.getElementById('resourcesTextArea').value;
            person.resources = resourcesText.split('\n').map(r => r.trim()).filter(r => r);

            updatePersonnelTable();

            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('editResourcesModal'));
            modal.hide();

            // 显示保存成功提示
            showQuickToast('资源已保存');
        }

        // 保存需求
        function saveNeeds() {
            if (!currentEditingPersonId) return;

            const person = personnelData.find(p => p.id === currentEditingPersonId);
            if (!person) return;

            const needsText = document.getElementById('needsTextArea').value;
            person.needs = needsText.split('\n').map(n => n.trim()).filter(n => n);

            updatePersonnelTable();

            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('editNeedsModal'));
            modal.hide();

            // 显示保存成功提示
            showQuickToast('需求已保存');
        }

        // 添加资源建议
        function addResourceSuggestion(resource) {
            const textarea = document.getElementById('resourcesTextArea');
            const currentValue = textarea.value;
            if (currentValue) {
                textarea.value = currentValue + (currentValue.endsWith('\n') ? '' : '\n') + resource;
            } else {
                textarea.value = resource;
            }
            textarea.focus();
        }

        // 添加需求建议
        function addNeedsSuggestion(need) {
            const textarea = document.getElementById('needsTextArea');
            const currentValue = textarea.value;
            if (currentValue) {
                textarea.value = currentValue + (currentValue.endsWith('\n') ? '' : '\n') + need;
            } else {
                textarea.value = need;
            }

            // 更新显示区域
            const needs = textarea.value.split('\n').map(n => n.trim()).filter(n => n);
            updateNeedsDisplay(needs);

            textarea.focus();
        }

        // 删除人物
        function deletePerson(personId) {
            const person = personnelData.find(p => p.id === personId);
            if (!person) return;
            
            showDeleteConfirm(person.name, () => {
                personnelData = personnelData.filter(p => p.id !== personId);
                updatePersonnelTable();
                showQuickToast('已删除关键人物');
            });
        }

        // 美观的删除确认对话框
        function showDeleteConfirm(personName, onConfirm) {
            // 创建遮罩层
            const overlay = document.createElement('div');
            overlay.className = 'delete-confirm-overlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.4);
                backdrop-filter: blur(4px);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.3s ease;
            `;

            // 创建对话框
            const dialog = document.createElement('div');
            dialog.className = 'delete-confirm-dialog';
            dialog.style.cssText = `
                background: white;
                border-radius: 16px;
                padding: 24px;
                max-width: 400px;
                width: 90%;
                box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
                transform: scale(0.9) translateY(20px);
                transition: all 0.3s ease;
                text-align: center;
            `;

            // 创建内容
            const icon = document.createElement('div');
            icon.innerHTML = '<i class="fas fa-exclamation-triangle"></i>';
            icon.style.cssText = `
                font-size: 48px;
                color: #FF6B6B;
                margin-bottom: 16px;
            `;

            const title = document.createElement('h3');
            title.textContent = '确认删除';
            title.style.cssText = `
                margin: 0 0 8px 0;
                font-size: 20px;
                font-weight: 600;
                color: #333;
            `;

            const message = document.createElement('p');
            message.textContent = `确定要删除关键人物"${personName}"吗？`;
            message.style.cssText = `
                margin: 0 0 24px 0;
                font-size: 16px;
                color: #666;
                line-height: 1.4;
            `;

            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = `
                display: flex;
                gap: 12px;
                justify-content: center;
            `;

            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = '取消';
            cancelBtn.style.cssText = `
                background: #f5f5f5;
                border: none;
                border-radius: 10px;
                padding: 12px 24px;
                font-size: 16px;
                font-weight: 500;
                color: #666;
                cursor: pointer;
                transition: all 0.2s ease;
            `;

            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = '确定删除';
            deleteBtn.style.cssText = `
                background: #FF6B6B;
                border: none;
                border-radius: 10px;
                padding: 12px 24px;
                font-size: 16px;
                font-weight: 500;
                color: white;
                cursor: pointer;
                transition: all 0.2s ease;
            `;

            // 按钮悬停效果
            cancelBtn.onmouseenter = () => {
                cancelBtn.style.background = '#ebebeb';
                cancelBtn.style.transform = 'translateY(-1px)';
            };
            cancelBtn.onmouseleave = () => {
                cancelBtn.style.background = '#f5f5f5';
                cancelBtn.style.transform = 'translateY(0)';
            };

            deleteBtn.onmouseenter = () => {
                deleteBtn.style.background = '#ff5252';
                deleteBtn.style.transform = 'translateY(-1px)';
            };
            deleteBtn.onmouseleave = () => {
                deleteBtn.style.background = '#FF6B6B';
                deleteBtn.style.transform = 'translateY(0)';
            };

            // 事件处理
            const closeDialog = () => {
                overlay.style.opacity = '0';
                dialog.style.transform = 'scale(0.9) translateY(20px)';
                setTimeout(() => {
                    if (overlay.parentNode) {
                        overlay.remove();
                    }
                }, 300);
            };

            cancelBtn.onclick = closeDialog;
            overlay.onclick = (e) => {
                if (e.target === overlay) closeDialog();
            };

            deleteBtn.onclick = () => {
                closeDialog();
                setTimeout(() => {
                    onConfirm();
                }, 100);
            };

            // 组装对话框
            buttonContainer.appendChild(cancelBtn);
            buttonContainer.appendChild(deleteBtn);
            
            dialog.appendChild(icon);
            dialog.appendChild(title);
            dialog.appendChild(message);
            dialog.appendChild(buttonContainer);
            
            overlay.appendChild(dialog);
            document.body.appendChild(overlay);

            // 显示动画
            setTimeout(() => {
                overlay.style.opacity = '1';
                dialog.style.transform = 'scale(1) translateY(0)';
            }, 10);

            // ESC键关闭
            const handleKeyDown = (e) => {
                if (e.key === 'Escape') {
                    closeDialog();
                    document.removeEventListener('keydown', handleKeyDown);
                }
            };
            document.addEventListener('keydown', handleKeyDown);
        }

        // 更新隐藏表单数据
        function updateHiddenFormData() {
            const hiddenContainer = document.getElementById('hiddenPersonnelData');
            hiddenContainer.innerHTML = '';

            personnelData.forEach((person, index) => {
                // 添加隐藏字段以便表单提交
                const nameInput = document.createElement('input');
                nameInput.type = 'hidden';
                nameInput.name = 'person_name[]';
                nameInput.value = person.name;
                hiddenContainer.appendChild(nameInput);

                const rolesInput = document.createElement('input');
                rolesInput.type = 'hidden';
                rolesInput.name = 'person_role[]';
                rolesInput.value = person.roles.join(',');
                hiddenContainer.appendChild(rolesInput);

                const resourcesInput = document.createElement('input');
                resourcesInput.type = 'hidden';
                resourcesInput.name = 'person_resources[]';
                resourcesInput.value = person.resources.join(',');
                hiddenContainer.appendChild(resourcesInput);

                const needsInput = document.createElement('input');
                needsInput.type = 'hidden';
                needsInput.name = 'person_needs[]';
                needsInput.value = person.needs.join(',');
                hiddenContainer.appendChild(needsInput);
            });
        }





        // 表单提交前验证和处理
        document.getElementById('mainForm').addEventListener('submit', function(e) {
            e.preventDefault(); // 阻止默认表单提交

            const projectName = document.getElementById('project_name').value.trim();
            const projectDescription = document.getElementById('project_description').value.trim();

            if (!projectName || !projectDescription) {
                alert('请填写项目名称和背景描述');
                return;
            }

            // 添加提交动画
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>正在分析...';
            submitBtn.disabled = true;

            // 收集表单数据
            const formData = {
                projectName: projectName,
                projectDescription: projectDescription,
                keyPersons: []
            };

            // 收集关键人物数据（从独立人物清单）
            formData.keyPersons = personnelData.map(person => ({
                name: person.name,
                roles: person.roles,
                resources: person.resources,
                makeHappy: person.needs,
                notes: ''
            }));


            // 发送数据到后端Flask而不是sessionStorage
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/generate';
            form.style.display = 'none';

            // 添加项目基础信息
            const addInput = (name, value) => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = name;
                input.value = value;
                form.appendChild(input);
            };

            addInput('project_name', formData.projectName);
            addInput('project_description', formData.projectDescription);


            // 添加关键人物数据
            formData.keyPersons.forEach((person, index) => {
                addInput('person_name[]', person.name);
                addInput('person_role[]', person.roles.join(','));
                addInput('person_resources[]', person.resources.join(','));
                addInput('person_needs[]', person.makeHappy.join(','));
            });


            // 提交表单并处理重定向
            document.body.appendChild(form);
            
            // 使用fetch提交表单，确保包含session cookie
            const submitFormData = new FormData(form);
            fetch('/generate', {
                method: 'POST',
                body: submitFormData,
                credentials: 'same-origin', // 确保携带session cookie
                headers: {
                    'X-Requested-With': 'XMLHttpRequest' // 标记为AJAX请求
                }
            })
            .then(response => {
                if (response.redirected) {
                    // 处理重定向
                    window.location.href = response.url;
                } else if (response.ok) {
                    // 检查是否是登录页面重定向
                    return response.text().then(text => {
                        if (text.includes('Redirecting') && text.includes('/login')) {
                            // 重定向到登录页面
                            window.location.href = '/login';
                        } else {
                            // 正常提交，跳转到thinking页面
                            window.location.href = '/thinking';
                        }
                    });
                } else {
                    throw new Error('表单提交失败');
                }
            })
            .catch(error => {
                console.error('提交错误:', error);
                alert('提交失败，请重试');
                // 恢复按钮状态
                submitBtn.innerHTML = '<i class="fas fa-brain me-2"></i>开始AI分析';
                submitBtn.disabled = false;
            });
            
            // 移除动态创建的表单
            document.body.removeChild(form);
        });

        // 测试案例数据
        const demoTestCases = {
            'english-training': {
                projectName: '在线口语陪练连接平台',
                projectDescription: '我通过朋友圈发现，升学规划师朋友经常有家长询问英语培训推荐，而我认识的外教群体因为疫情线下课减少正在找线上机会。我设计了"1对1外教口语陪练"产品：标准化课程包（30分钟/节，8节一期），统一定价288元/期，我负责获客和质量监督，外教获得稳定学员，升学规划师获得推荐费。这样形成三方共赢的收入管道。',

                persons: [
                    {
                        name: '升学规划师Lisa',
                        roles: ['enterprise_owner'],
                        resources: ['1000+精准家长客户', '教育咨询品牌信任度', '家长微信群3个', '升学规划专业认证'],
                        makeHappy: ['获得持续收入', '不冲突现有合作', '品牌曝光', '获得认可/名声'],
                        notes: '主营升学规划，家长经常问英语培训推荐，但她不想直接做培训影响主业，希望有可信赖的推荐来源'
                    },
                    {
                        name: '英语外教Kevin',
                        roles: ['service_provider'],
                        resources: ['TESOL认证', '5年教学经验', '线上教学设备', '标准美式发音', '课程设计能力'],
                        makeHappy: ['获得稳定客源', '获得持续收入', '获得认可/名声'],
                        notes: '疫情后线下课程减少，正在寻找稳定的线上学员来源，擅长口语教学和课程标准化'
                    },
                    {
                        name: '程序员家长王先生',
                        roles: ['store_owner'],
                        resources: ['教育支付预算年5万', '对在线教育接受度高', '注重教学效果', '愿意分享好的教育产品'],
                        makeHappy: ['控制成本开支', '获得稳定供应', '获得优质产品'],
                        notes: '孩子12岁，英语基础不错但缺乏口语练习，希望找到性价比高且效果好的外教一对一'
                    }
                ]
            },
            'rental-business': {
                projectName: '社区生活服务集合店',
                projectDescription: '我在调研中发现，某社区临街200平商铺空置3个月，房东要求整租但租金偏高导致无人问津。通过分析发现，这个位置适合做"生活服务集合店"：一楼做社区便利店+代收快递，二楼做美容美甲+儿童托管。我设计了分租转包模式：我整租后按功能分区转租，同时整合各业态形成客户互导，让各商家都获得更多客流。',

                persons: [
                    {
                        name: '商铺房东老张',
                        roles: ['other_provider'],
                        resources: ['临街200平双层商铺', '停车位3个', '独立水电接入', '商业用地证照齐全'],
                        makeHappy: ['获得持续收入', '无风险无责任', '盘活闲置资产'],
                        notes: '退休教师，不愿操心具体经营，希望稳定租金收入，优先考虑长期租约'
                    },
                    {
                        name: '便利店老板小李',
                        roles: ['service_provider'],
                        resources: ['便利店运营经验', '供应商渠道', '快递代收服务', '社区居民信任度'],
                        makeHappy: ['获得稳定供应', '控制成本开支', '客流互导分享'],
                        notes: '原店面到期需要换地方，有成熟的便利店运营模式，希望租金合理且有稳定客流'
                    },
                    {
                        name: '美甲师Amy',
                        roles: ['service_provider'],
                        resources: ['专业美甲技能', '固定客户群200+', '美甲设备全套', '小红书1万粉丝'],
                        makeHappy: ['品牌曝光', '控制成本开支', '客流互导分享'],
                        notes: '想要有固定门店提升专业形象，预算有限，希望通过客户互导增加收入'
                    },
                    {
                        name: '托管老师刘阿姨',
                        roles: ['service_provider'],
                        resources: ['幼教资格证', '15年托管经验', '家长口碑好', '安全意识强'],
                        makeHappy: ['获得稳定供应', '获得认可/名声', '获得持续收入'],
                        notes: '之前在家做托管，想要正规化经营，需要合适的场地和合理的租金'
                    }
                ]
            },
            'cicada-farming': {
                projectName: '订单农业知了猴供应链',
                projectDescription: '我发现县城餐饮市场知了猴供不应求，价格每斤80-120元，但缺乏稳定供应。通过调研发现可以建立"订单农业模式"：与餐厅签订供货协议，向农户定制化收购，建立标准化养殖和收购体系。我有餐饮渠道资源，本地林农有场地但缺销路，专业养殖户有技术但缺规模，形成完美的资源互补。计划第一年供应5家餐厅，年产值目标50万。',

                persons: [
                    {
                        name: '林地承包户老王',
                        roles: ['other_provider'],
                        resources: ['柳树林地200亩', '山区水源充足', '农业设施基础', '当地农户关系网'],
                        makeHappy: ['盘活闲置资产', '获得持续收入', '无风险无责任', '获得认可/名声'],
                        notes: '林地利用率低，除草成本高，愿意低价租给能带来额外收入且帮助管理的合作方'
                    },
                    {
                        name: '知了猴养殖专家赵师傅',
                        roles: ['service_provider'],
                        resources: ['养殖技术专利', '培训教材', '成功案例', '行业人脉网络', '质量检测设备'],
                        makeHappy: ['获得认可/名声', '品牌曝光', '成为专业顾问', '获得持续收入'],
                        notes: '有15年养殖经验，技术成熟但缺乏推广渠道，希望通过技术输出获得收入和行业地位'
                    },
                    {
                        name: '餐厅老板陈总',
                        roles: ['enterprise_owner'],
                        resources: ['餐厅客流日均200+', '食材采购预算月2万', '当地餐饮协会资源', '冷链存储设备'],
                        makeHappy: ['获得稳定供应', '控制成本开支', '获得优质产品', '品牌曝光'],
                        notes: '主营农家菜，知了猴是招牌特色但经常断货，愿意预付定金确保稳定供应'
                    },
                    {
                        name: '收购协调员小张',
                        roles: ['traffic_provider'],
                        resources: ['农户资源网络', '收购经验', '运输车辆', '当地市场信息', '农产品收购许可'],
                        makeHappy: ['获得持续收入', '获得认可/名声', '获得稳定供应'],
                        notes: '曾做过其他农产品收购，熟悉当地农户和市场情况，希望找到稳定且利润较好的收购项目'
                    }
                ]
            }
        };

        // 处理测试案例选择
        function handleDemoCaseSelection() {
            const caseCards = document.querySelectorAll('.demo-case-card');

            caseCards.forEach(card => {
                card.addEventListener('click', function() {
                    const caseType = this.dataset.case;

                    // 移除其他卡片的选中状态
                    caseCards.forEach(c => c.classList.remove('selected'));

                    if (caseType === 'custom') {
                        // 自定义项目 - 清空表单
                        this.classList.add('selected');
                        clearForm();
                        scrollToForm();
                    } else if (demoTestCases[caseType]) {
                        // 选择测试案例 - 填充表单
                        this.classList.add('selected');
                        loadTestCase(demoTestCases[caseType]);
                        scrollToForm();

                        // 显示成功提示
                        showNotification('✅ 示例案例已加载完成！向下滚动查看表单内容，可直接提交分析或修改参数', 'success');
                    }
                });
            });
        }

        // 加载测试案例数据到表单
        function loadTestCase(caseData) {
            // 强制显示所有表单元素（移除动画类避免时序问题）
            const mainForm = document.getElementById('mainForm');
            if (mainForm) {
                // 移除可能影响显示的动画类
                const animatedElements = mainForm.querySelectorAll('.fade-in, .slide-up');
                animatedElements.forEach(el => {
                    el.classList.remove('fade-in', 'slide-up');
                    el.style.opacity = '1';
                    el.style.transform = 'translateY(0)';
                    el.style.visibility = 'visible';
                });

                // 强制重新布局
                mainForm.style.display = 'block';
                mainForm.offsetHeight; // 触发重绘
            }

            // 填充项目基础信息
            const projectNameEl = document.getElementById('project_name');
            const projectDescEl = document.getElementById('project_description');
            // 项目阶段字段已移除

            if (projectNameEl) {
                projectNameEl.value = caseData.projectName || '';
                projectNameEl.setAttribute('value', caseData.projectName || '');
            }
            if (projectDescEl) {
                projectDescEl.value = caseData.projectDescription || '';
                projectDescEl.textContent = caseData.projectDescription || '';
            }


            // 清空现有关键人物清单数据
            personnelData = [];

            // 添加测试案例中的人物到关键人物清单
            if (caseData.persons && caseData.persons.length > 0) {
                caseData.persons.forEach((person, index) => {
                    const newPerson = {
                        id: Date.now() + index, // 确保每个人物有唯一ID
                        name: person.name || '未命名',
                        roles: person.roles || [],
                        resources: person.resources || [],
                        needs: person.makeHappy || [] // 注意这里是makeHappy字段
                    };
                    personnelData.push(newPerson);
                });

                // 更新关键人物清单表格显示
                updatePersonnelTable();
            }


        }

        // 清空表单
        function clearForm() {
            document.getElementById('project_name').value = '';
            document.getElementById('project_description').value = '';

            // 清空关键人物清单
            personnelData = [];
            updatePersonnelTable();
        }

        // 滚动到表单区域
        function scrollToForm() {
            const formElement = document.getElementById('mainForm');
            if (formElement) {
                setTimeout(() => {
                    formElement.scrollIntoView({
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                    // 强制重新渲染表单以确保内容显示
                    setTimeout(() => {
                        // 触发重绘
                        const inputs = formElement.querySelectorAll('input, textarea, select');
                        inputs.forEach(input => {
                            if (input.value) {
                                input.dispatchEvent(new Event('input', { bubbles: true }));
                            }
                        });
                    }, 500);
                }, 800);
            }
        }

        // 显示通知消息
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} slide-up`;
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '9999';
            notification.style.maxWidth = '400px';

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // === 缺失的辅助函数 ===

        // 添加资源推荐到文本框
        function addResourceSuggestion(resource) {
            const textarea = document.getElementById('resourcesTextArea');
            if (!textarea) return;

            const currentValue = textarea.value.trim();
            const newValue = currentValue ? currentValue + '\n' + resource : resource;
            textarea.value = newValue;
            
            // 触发输入事件以更新UI
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
        }

        // 添加需求推荐到文本框
        function addNeedsSuggestion(need) {
            const textarea = document.getElementById('needsTextArea');
            if (!textarea) return;

            const currentValue = textarea.value.trim();
            const newValue = currentValue ? currentValue + '\n' + need : need;
            textarea.value = newValue;
            
            // 触发输入事件以更新UI
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
        }

        // 添加人物函数（兼容旧的调用方式）
        function addPerson() {
            addNewPersonnel();
        }

        // 更新需求显示（占位函数，兼容旧代码）
        function updateNeedsDisplay() {
            // 这个函数主要是为了兼容性，实际的更新由updatePersonnelTable处理
            console.log('updateNeedsDisplay called - handled by updatePersonnelTable');
        }

        // 初始化交互功能
        function initializeInteractions() {
            console.log('交互功能已初始化');
            
            // 初始化人物表格
            if (typeof updatePersonnelTable === 'function') {
                updatePersonnelTable();
            }
            
            // 设置随机提示语
            if (typeof setRandomPlaceholder === 'function') {
                setRandomPlaceholder();
            }
            
            // 处理测试案例选择
            if (typeof handleDemoCaseSelection === 'function') {
                handleDemoCaseSelection();
            }
        }

        // 为模态框生成资源推荐
        function generateResourceSuggestionsForModal() {
            // 获取当前编辑的人物信息
            if (!currentEditingPersonId) return;
            
            const person = personnelData.find(p => p.id === currentEditingPersonId);
            if (!person) return;
            
            // 调用现有的更新函数
            if (typeof updateModalResourceSuggestions === 'function') {
                updateModalResourceSuggestions(person.roles || []);
            }
        }





        // 添加平滑滚动
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // 添加输入框焦点动画
        document.querySelectorAll('.form-control').forEach(input => {
            input.addEventListener('focus', function() {
                this.parentElement.classList.add('focused');
            });

            input.addEventListener('blur', function() {
                this.parentElement.classList.remove('focused');
            });
        });

        // 移动端汉堡菜单功能
        function toggleMobileMenu() {
            const dropdown = document.getElementById('mobileDropdown');
            const toggle = document.querySelector('.mobile-menu-toggle');
            const icon = toggle.querySelector('i');

            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
                icon.className = 'fas fa-bars';
            } else {
                dropdown.classList.add('show');
                icon.className = 'fas fa-times';
            }
        }

        // 修复缺失的JavaScript函数
        function addPerson() {
            // 这个函数在独立人物清单系统中已被addNewPersonnel替代
            addNewPersonnel();
        }

        function updateNeedsDisplay(needs) {
            // 在需求编辑模态框中更新显示
            // 这个函数主要用于模态框内部，现在由其他函数处理
            console.log('更新需求显示:', needs);
        }

        function initializeInteractions() {
            // 初始化所有交互功能
            console.log('交互功能已初始化');
        }

        function generateResourceSuggestionsForModal(selectedRoles) {
            // 兼容旧的函数调用，使用新的函数名
            updateModalResourceSuggestions(selectedRoles);
        }

        // 修复角色选择后的资源推荐更新
        document.addEventListener('DOMContentLoaded', function() {
            // 监听角色选择变化
            const roleModal = document.getElementById('editRolesModal');
            if (roleModal) {
                roleModal.addEventListener('show.bs.modal', function() {
                    // 当角色模态框显示时，确保当前编辑人物ID已设置
                    console.log('编辑角色模态框已打开，当前编辑人物ID:', currentEditingPersonId);
                });
            }

            // 监听资源模态框显示事件
            const resourceModal = document.getElementById('editResourcesModal');
            if (resourceModal) {
                resourceModal.addEventListener('show.bs.modal', function() {
                    const person = personnelData.find(p => p.id === currentEditingPersonId);
                    if (person) {
                        updateModalResourceSuggestions(person.roles || []);
                    }
                });
            }
        });

        // 修复移动端编辑功能 - 确保模态框中的资源推荐功能正常
        function updateModalResourceSuggestions(selectedRoles) {
            const suggestionsContainer = document.getElementById('modalResourceSuggestions');

            if (!suggestionsContainer) {
                console.warn('资源推荐容器未找到');
                return;
            }

            if (!selectedRoles || selectedRoles.length === 0) {
                suggestionsContainer.innerHTML = '<p class="text-muted">请先在角色选择中选择身份角色以获得智能推荐</p>';
                return;
            }

            // 获取所有选中角色的候选资源
            const allSuggestions = new Set();
            selectedRoles.forEach(role => {
                if (roleToResourceSuggestions[role]) {
                    roleToResourceSuggestions[role].forEach(resource => allSuggestions.add(resource));
                }
            });

            if (allSuggestions.size === 0) {
                suggestionsContainer.innerHTML = '<p class="text-muted">暂无推荐资源</p>';
                return;
            }

            // 生成推荐标签
            const tagsHtml = Array.from(allSuggestions).map(resource => 
                `<span class="suggestion-tag" onclick="addResourceSuggestion('${resource.replace(/'/g, "\\'")}')">${resource}</span>`
            ).join('');

            suggestionsContainer.innerHTML = `<div class="suggestion-tags">${tagsHtml}</div>`;
        }

        // 点击菜单外部关闭菜单
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('mobileDropdown');
            const toggle = document.querySelector('.mobile-menu-toggle');

            if (dropdown && dropdown.classList.contains('show') && 
                !dropdown.contains(event.target) && !toggle.contains(event.target)) {
                dropdown.classList.remove('show');
                toggle.querySelector('i').className = 'fas fa-bars';
            }
        });

        // 点击菜单项后关闭菜单
        document.querySelectorAll('.mobile-dropdown .dropdown-item').forEach(item => {
            item.addEventListener('click', function() {
                const dropdown = document.getElementById('mobileDropdown');
                const toggle = document.querySelector('.mobile-menu-toggle');
                dropdown.classList.remove('show');
                toggle.querySelector('i').className = 'fas fa-bars';
            });
        });
    </script>

    <!-- 模态框：编辑身份角色 -->
    <div class="modal fade" id="editRolesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑身份角色</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="role-categories">
                        <div class="role-category" data-category="demand">
                            <h6 class="role-category-title demand">
                                <i class="fas fa-user-tie"></i>
                                需求方
                            </h6>
                            <div class="role-options">
                                <label class="role-item" data-tooltip="拥有企业决策权，需要项目带来商业价值">
                                    <input type="checkbox" name="modal_person_role" value="enterprise_owner">
                                    <span>企业主</span>
                                    <div class="role-tooltip">拥有企业决策权，需要项目带来商业价值</div>
                                </label>
                                <label class="role-item" data-tooltip="经营实体门店，关注客流量和营业额提升">
                                    <input type="checkbox" name="modal_person_role" value="store_owner">
                                    <span>实体店主</span>
                                    <div class="role-tooltip">经营实体门店，关注客流量和营业额提升</div>
                                </label>
                                <label class="role-item" data-tooltip="管理特定部门，需要提升部门业绩和效率">
                                    <input type="checkbox" name="modal_person_role" value="department_head">
                                    <span>部门负责人</span>
                                    <div class="role-tooltip">管理特定部门，需要提升部门业绩和效率</div>
                                </label>
                                <label class="role-item" data-tooltip="品牌或产品的主要负责人，注重品牌价值和影响力">
                                    <input type="checkbox" name="modal_person_role" value="brand_manager">
                                    <span>主理人</span>
                                    <div class="role-tooltip">品牌或产品的主要负责人，注重品牌价值和影响力</div>
                                </label>
                            </div>
                        </div>

                        <div class="role-category" data-category="delivery">
                            <h6 class="role-category-title delivery">
                                <i class="fas fa-hands-helping"></i>
                                交付方
                            </h6>
                            <div class="role-options">
                                <label class="role-item" data-tooltip="提供具体产品或商品，负责产品质量和供应链">
                                    <input type="checkbox" name="modal_person_role" value="product_provider">
                                    <span>产品</span>
                                    <div class="role-tooltip">提供具体产品或商品，负责产品质量和供应链</div>
                                </label>
                                <label class="role-item" data-tooltip="提供专业服务或技能，注重服务质量和客户满意度">
                                    <input type="checkbox" name="modal_person_role" value="service_provider">
                                    <span>服务</span>
                                    <div class="role-tooltip">提供专业服务或技能，注重服务质量和客户满意度</div>
                                </label>
                                <label class="role-item" data-tooltip="提供客户资源或推广渠道，关注转化率和用户质量">
                                    <input type="checkbox" name="modal_person_role" value="traffic_provider">
                                    <span>流量</span>
                                    <div class="role-tooltip">提供客户资源或推广渠道，关注转化率和用户质量</div>
                                </label>
                                <label class="role-item" data-tooltip="提供其他资源或支持，可能包括场地、设备、信息等">
                                    <input type="checkbox" name="modal_person_role" value="other_provider">
                                    <span>其他</span>
                                    <div class="role-tooltip">提供其他资源或支持，可能包括场地、设备、信息等</div>
                                </label>
                            </div>
                        </div>

                        <div class="role-category" data-category="funding">
                            <h6 class="role-category-title funding">
                                <i class="fas fa-coins"></i>
                                资金方
                            </h6>
                            <div class="role-options">
                                <label class="role-item" data-tooltip="提供项目资金支持，关注投资回报和风险控制">
                                    <input type="checkbox" name="modal_person_role" value="funding_provider">
                                    <span>资金提供方</span>
                                    <div class="role-tooltip">提供项目资金支持，关注投资回报和风险控制</div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveRoles()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框：编辑掌握资源 -->
    <div class="modal fade" id="editResourcesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑掌握资源</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="resourcesTextArea" class="form-label">掌握的资源</label>
                        <textarea class="form-control" id="resourcesTextArea" rows="6" 
                                placeholder="每行一个资源，例如：&#10;微信群500人&#10;抖音账号10万粉丝&#10;采购预算50万"></textarea>
                    </div>

                    <div class="mb-3">
                        <h6 class="text-muted mb-3">
                            <i class="fas fa-lightbulb text-warning me-1"></i>
                            基于身份角色的资源推荐
                        </h6>
                        <div id="modalResourceSuggestions" class="modal-resource-suggestions">
                            <!-- 智能推荐内容将在这里动态生成 -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveResources()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框：编辑如何让TA高兴 -->
    <div class="modal fade" id="editNeedsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑如何让TA高兴</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 粘性顶部区域：输入区域 -->
                    <div class="needs-sticky-section" id="needsStickySection">
                        <div class="mb-3">
                            <label class="form-label">添加让TA高兴的方式（一行一个）</label>
                            <textarea class="form-control" id="needsTextArea" rows="6" placeholder="请输入让这个人高兴的方式，每个方式占一行&#10;例如：&#10;获得更多利润&#10;提升品牌知名度&#10;节省运营成本&#10;获得认可和尊重"></textarea>
                        </div>
                    </div>
                    <div class="needs-suggestions">
                        <div class="motivation-category">
                            <div class="category-header">
                                <span class="category-icon green">💚</span>
                                <h6>想看到回报 / 实际效果</h6>
                                <p>他在意投入和产出，有明确的"结果导向"。</p>
                            </div>
                            <div class="motivation-tags">
                                <span class="motivation-tag" onclick="addNeedsSuggestion('拿到分成/抽成')">拿到分成/抽成</span>
                                <span class="motivation-tag" onclick="addNeedsSuggestion('带来客户/用户')">带来客户/用户</span>
                                <span class="motivation-tag" onclick="addNeedsSuggestion('项目尽快落地')">项目尽快落地</span>
                                <span class="motivation-tag" onclick="addNeedsSuggestion('能长期持续赚钱')">能长期持续赚钱</span>
                                <span class="motivation-tag" onclick="addNeedsSuggestion('有资源被用起来（不闲置）')">有资源被用起来（不闲置）</span>
                            </div>
                        </div>

                        <div class="motivation-category">
                            <div class="category-header">
                                <span class="category-icon blue">💙</span>
                                <h6>想被看到 / 被宣传</h6>
                                <p>他要曝光，要名声，而且最好是精准曝光。</p>
                            </div>
                            <div class="motivation-tags">
                                <span class="motivation-tag" onclick="addNeedsSuggestion('有品牌露出（线上线下）')">有品牌露出（线上线下）</span>
                                <span class="motivation-tag" onclick="addNeedsSuggestion('打造个人标签/专家身份')">打造个人标签/专家身份</span>
                                <span class="motivation-tag" onclick="addNeedsSuggestion('曝光到目标圈层')">曝光到目标圈层</span>
                                <span class="motivation-tag" onclick="addNeedsSuggestion('项目中看起来是主导者')">项目中看起来是主导者</span>
                            </div>
                        </div>

                        <div class="motivation-category">
                            <div class="category-header">
                                <span class="category-icon red">❤️</span>
                                <h6>不想冒风险</h6>
                                <p>他想参与，但不能有风险或预损失。</p>
                            </div>
                            <div class="motivation-tags">
                                <span class="motivation-tag" onclick="addNeedsSuggestion('不出钱不担责')">不出钱不担责</span>
                                <span class="motivation-tag" onclick="addNeedsSuggestion('不公开露脸')">不公开露脸</span>
                                <span class="motivation-tag" onclick="addNeedsSuggestion('不影响已有合作方')">不影响已有合作方</span>
                                <span class="motivation-tag" onclick="addNeedsSuggestion('保证信息保密')">保证信息保密</span>
                                <span class="motivation-tag" onclick="addNeedsSuggestion('可隐身参与（不被对手知道）')">可隐身参与（不被对手知道）</span>
                            </div>
                        </div>

                        <div class="motivation-category">
                            <div class="category-header">
                                <span class="category-icon gray">🔴</span>
                                <h6>想被尊重 / 有地位</h6>
                                <p>他要身份感，面子感和圈子认可。</p>
                            </div>
                            <div class="motivation-tags">
                                <span class="motivation-tag" onclick="addNeedsSuggestion('成为顾问/专家')">成为顾问/专家</span>
                                <span class="motivation-tag" onclick="addNeedsSuggestion('被认可很重要')">被认可很重要</span>
                                <span class="motivation-tag" onclick="addNeedsSuggestion('提升在圈子里的地位')">提升在圈子里的地位</span>
                                <span class="motivation-tag" onclick="addNeedsSuggestion('像是他发起的局')">像是他发起的局</span>
                            </div>
                        </div>


                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveNeeds()">保存</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>