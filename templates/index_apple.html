<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Angela · 非劳务收入管道设计师</title>

    <!-- 预加载关键字体 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <!-- Apple级别设计系统 -->
    <link href="{{ url_for('static', filename='css/apple-design-system.css') }}" rel="stylesheet">
    <!-- 未来科幻增强版设计系统 -->
    <link href="{{ url_for('static', filename='css/future-enhanced-apple.css') }}" rel="stylesheet">
    <!-- 按钮修复样式 -->
    <link href="{{ url_for('static', filename='css/button-fix.css') }}" rel="stylesheet">
    <!-- 用户认证样式 -->
    <link href="{{ url_for('static', filename='css/auth-styles.css') }}" rel="stylesheet">
    <!-- 世界一流导航设计 -->
    <link href="{{ url_for('static', filename='css/navigation-redesign.css') }}" rel="stylesheet">
    <!-- 用户菜单下拉设计 -->
    <link href="{{ url_for('static', filename='css/user-menu-dropdown.css') }}" rel="stylesheet">

    <!-- SEO优化 -->
    <meta name="description" content="Angela - Apple级别AI驱动的非劳务收入管道设计工具，世界一流的用户体验">
    <meta name="keywords" content="AI收入设计,非劳务收入,智能管道,商业策略,Apple设计">
</head>
<body>
    <!-- Apple风格导航栏 -->
    <nav class="navigation-bar">
        <div class="nav-content">
            <a href="{{ url_for('index') }}" class="nav-brand">
                <i class="fas fa-brain"></i>
                Angela
            </a>
            <div class="nav-actions">
                <a href="{{ url_for('analysis_history') }}" class="btn btn-primary">
                    <i class="fas fa-history"></i>历史记录
                </a>
                <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary">
                    <i class="fas fa-cog"></i>管理中心
                </a>

                <!-- 移动端汉堡菜单按钮 -->
                <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">
                    <i class="fas fa-bars"></i>
                </button>

                <!-- 移动端下拉菜单 -->
                <div class="mobile-dropdown" id="mobileDropdown">
                    <div class="mobile-user-info">
                        <div class="user-avatar">
                            <i class="fas fa-user"></i>
                        </div>
                        <div class="user-details">
                            <h4>{{ current_user.name or '用户' }}</h4>
                            <p>{{ current_user.phone }}</p>
                        </div>
                    </div>

                    <a href="{{ url_for('analysis_history') }}" class="dropdown-item">
                        <i class="fas fa-history"></i>
                        历史记录
                    </a>
                    <a href="{{ url_for('admin_dashboard') }}" class="dropdown-item">
                        <i class="fas fa-cog"></i>
                        管理中心
                    </a>
                    <a href="{{ url_for('change_password') }}" class="dropdown-item">
                        <i class="fas fa-key"></i>
                        修改密码
                    </a>
                    <a href="{{ url_for('edit_profile') }}" class="dropdown-item">
                        <i class="fas fa-user-edit"></i>
                        个人资料
                    </a>
                    <a href="{{ url_for('logout') }}" class="dropdown-item">
                        <i class="fas fa-sign-out-alt"></i>
                        退出登录
                    </a>
                </div>

                <div class="user-menu">
                    <div class="user-trigger" tabindex="0" role="button" aria-haspopup="true" aria-expanded="false">
                        <div class="user-info">
                            <i class="fas fa-user-circle"></i>
                            <span class="user-name">{{ current_user.name or current_user.phone }}</span>
                        </div>
                        <i class="fas fa-chevron-down dropdown-arrow"></i>
                    </div>
                    <div class="user-dropdown" role="menu">
                        <div class="dropdown-header">
                            <div class="user-profile">
                                <div class="user-avatar"></div>
                                <div class="user-details">
                                    <h4>{{ current_user.name or '用户' }}</h4>
                                    <p>{{ current_user.phone }}</p>
                                </div>
                            </div>
                        </div>
                        <a href="{{ url_for('change_password') }}" class="dropdown-item" role="menuitem">
                            <i class="fas fa-key"></i>
                            修改密码
                        </a>
                        <a href="{{ url_for('edit_profile') }}" class="dropdown-item" role="menuitem">
                            <i class="fas fa-user-edit"></i>
                            个人资料
                        </a>
                        <a href="{{ url_for('logout') }}" class="dropdown-item logout" role="menuitem">
                            <i class="fas fa-sign-out-alt"></i>
                            退出登录
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- 主要内容区域 -->
    <main class="main-content">
        <!-- 页面标题区域 -->
        <header class="page-header">
            <h1 class="page-title">非劳务收入管道设计师</h1>
            <p class="page-subtitle">根据您的项目和关键人物信息，生成个性化的非劳务收入管道方案</p>

            <!-- 测试案例选择区域 -->
            <div class="demo-cases-section">
                <div class="demo-cases-header">
                    <h3>
                        <i class="fas fa-lightbulb"></i>
                        快速开始-选择示例案例
                    </h3>
                    <p>选择下方任一真实案例，快速体验Angela AI的分析能力</p>
                </div>
                <div class="demo-cases-grid">
                    <div class="demo-case-card" data-case="english-training">
                        <div class="case-icon">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <div class="case-content">
                            <h4>英语培训管道案例</h4>
                            <p>通过连接升学规划师和英语机构，3个月内搭建年收入40万的培训管道</p>
                            <div class="case-tags">
                                <span class="tag">教育培训</span>
                                <span class="tag">B2B连接</span>
                            </div>
                        </div>
                    </div>

                    <div class="demo-case-card" data-case="rental-business">
                        <div class="case-icon">
                            <i class="fas fa-building"></i>
                        </div>
                        <div class="case-content">
                            <h4>商铺租赁管道案例</h4>
                            <p>1万元启动资金，通过二房东模式，8年累计收益72万</p>
                            <div class="case-tags">
                                <span class="tag">房地产</span>
                                <span class="tag">差价收益</span>
                            </div>
                        </div>
                    </div>

                    <div class="demo-case-card" data-case="cicada-farming">
                        <div class="case-icon">
                            <i class="fas fa-seedling"></i>
                        </div>
                        <div class="case-content">
                            <h4>知了猴养殖管道案例</h4>
                            <p>1万元启动成本，搭建7条管道，实现年收入70万的农村创业</p>
                            <div class="case-tags">
                                <span class="tag">农业创新</span>
                                <span class="tag">资源整合</span>
                            </div>
                        </div>
                    </div>

                    <div class="demo-case-card" data-case="custom">
                        <div class="case-icon">
                            <i class="fas fa-edit"></i>
                        </div>
                        <div class="case-content">
                            <h4>自定义项目</h4>
                            <p>根据您的实际情况，从零开始设计专属的非劳务收入方案</p>
                            <div class="case-tags">
                                <span class="tag">个性定制</span>
                                <span class="tag">原创设计</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div style="margin-bottom: var(--space-8);">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'error' if category == 'error' else 'info' }} slide-up">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- 主要表单 -->
        <form method="POST" action="{{ url_for('generate') }}" id="mainForm">

            <!-- 项目基础信息模块 -->
            <div class="card interactive-hover">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-rocket"></i>
                        项目基础信息
                    </h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="project_name" class="form-label">项目名称</label>
                        <input type="text" class="form-control" id="project_name" name="project_name" 
                               placeholder="请输入您的项目名称" required>
                    </div>

                    <div class="form-group">
                        <label for="project_description" class="form-label">项目背景描述</label>
                        <textarea class="form-control" id="project_description" name="project_description" 
                                  placeholder="详细描述您的项目背景、目标和现状..." required></textarea>
                    </div>



                </div>
            </div>

            <!-- 关键人物清单（概览表格） -->
            <div class="card interactive-hover">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-list-alt"></i>
                        关键人物清单
                    </h3>
                    <small class="text-muted">项目中所有关键人物的概览，支持快速添加和编辑</small>
                </div>
                <div class="card-body">
                    <div class="personnel-overview-container">
                        <!-- 表格头部 -->
                        <div class="personnel-table-header">
                            <div class="table-column col-number">#</div>
                            <div class="table-column col-name">姓名/代号</div>
                            <div class="table-column col-roles">身份角色</div>
                            <div class="table-column col-resources">掌握资源</div>
                            <div class="table-column col-needs">如何让TA高兴</div>
                            <div class="table-column col-actions">操作</div>
                        </div>

                        <!-- 表格内容区域 -->
                        <div class="personnel-table-body" id="personnelTableBody">
                            <div class="empty-personnel-state">
                                <div class="empty-state-content">
                                    <i class="fas fa-users-slash"></i>
                                    <h4>还没有添加关键人物</h4>
                                    <p>点击下方按钮开始添加项目中的关键人物</p>
                                </div>
                            </div>
                        </div>

                        <!-- 快速添加按钮 -->
                        <div class="personnel-quick-add">
                            <button type="button" class="btn btn-outline-primary btn-sm" onclick="addNewPersonnel()">
                                <i class="fas fa-plus"></i>
                                快速添加人物
                            </button>
                        </div>

                        <!-- 隐藏的表单字段用于提交 -->
                        <div style="display: none;" id="hiddenPersonnelData">
                            <!-- 人物数据将动态添加到这里 -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 提交按钮 -->
            <div style="text-align: center; margin-top: 32px; padding-top: 24px; border-top: 1px solid rgba(0, 0, 0, 0.1);">
                <button type="submit" class="btn btn-primary btn-large interactive gpu-accelerated">
                    <i class="fas fa-magic me-2"></i>
                    开始AI智能分析
                </button>
                <p style="margin-top: 16px; color: #667680; font-size: 14px;">
                    基于您提供的信息，AI将在几秒内生成专业的收入管道设计方案
                </p>
            </div>
        </form>
    </main>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/future-enhanced-interactions.js') }}"></script>
    <script src="{{ url_for('static', filename='js/user-menu.js') }}"></script>
    <script>
        // Navigation Enhancement Script
        document.addEventListener('DOMContentLoaded', function() {
            const navbar = document.querySelector('.navigation-bar');

            // Add scroll effect to navigation
            let lastScrollTop = 0;
            window.addEventListener('scroll', function() {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;

                if (scrollTop > 20) {
                    navbar.classList.add('scrolled');
                } else {
                    navbar.classList.remove('scrolled');
                }

                lastScrollTop = scrollTop;
            });

            // Enhanced button interactions
            const navButtons = document.querySelectorAll('.nav-actions .btn');
            navButtons.forEach(button => {
                button.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-1px)';
                });

                button.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                });

                button.addEventListener('click', function(e) {
                    // Add ripple effect
                    const ripple = document.createElement('span');
                    ripple.classList.add('ripple');

                    const rect = this.getBoundingClientRect();
                    const size = Math.max(rect.width, rect.height);
                    const x = e.clientX - rect.left - size / 2;
                    const y = e.clientY - rect.top - size / 2;

                    ripple.style.width = ripple.style.height = size + 'px';
                    ripple.style.left = x + 'px';
                    ripple.style.top = y + 'px';

                    this.appendChild(ripple);

                    setTimeout(() => {
                        ripple.remove();
                    }, 600);
                });
            });

            // Mobile menu toggle for very small screens
            function handleResponsiveNavigation() {
                const navActions = document.querySelector('.nav-actions');
                const userMenu = document.querySelector('.user-menu');

                if (window.innerWidth <= 480) {
                    navActions.style.flexDirection = 'column';
                    userMenu.style.flexDirection = 'column';
                } else if (window.innerWidth <= 768) {
                    navActions.style.flexDirection = 'row';
                    userMenu.style.flexDirection = 'row';
                }
            }

            // Handle resize events
            window.addEventListener('resize', handleResponsiveNavigation);
            handleResponsiveNavigation(); // Initial call
        });
    </script>
    <script>
        // 初始化功能
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化交互功能
            initializeInteractions();
            // 初始化独立人物清单表格
            updatePersonnelTable();
            // 设置输入框的随机提示语
            setRandomPlaceholder();
            // 处理测试案例选择
            handleDemoCaseSelection();
        });





        // 角色到资源的映射
        const roleToResourceSuggestions = {
            // 需求方
            "enterprise_owner": ["采购预算", "项目立项权", "签约权限", "内部宣传位", "企业客户名单", "决策权"],
            "store_owner": ["店铺空间", "客流量", "本地资源", "营业执照", "店面展示位", "顾客数据", "采购预算", "签约权限", "决策权"],
            "department_head": ["部门预算", "团队人力", "内部协调权", "KPI指标", "汇报渠道", "资源分配权", "采购预算", "签约权限", "决策权"],
            "brand_manager": ["品牌授权", "营销预算", "品牌露出机会", "用户社群", "品牌合作资源", "市场推广权", "采购预算", "签约权限", "决策权"],

            // 交付方
            "product_provider": ["产品试用名额", "样品/兑换码", "分销价权限", "售后支持", "产品授权", "库存资源"],
            "service_provider": ["专业技能", "执行团队", "服务时间", "工具平台", "交付方案", "质量保证"],
            "traffic_provider": ["用户粉丝", "媒体渠道", "社群资源", "推广位", "流量入口", "曝光机会"],
            "other_provider": ["特殊资质", "关系网络", "平台权限", "独特资源", "专业认证", "行业地位"],

            // 资金方
            "funding_provider": ["投资资金", "赞助额度", "现金预算", "投后服务", "背书资源", "融资渠道"]
        };

        // 资源示例模板
        const resourceExamples = [
            ["视频号8万粉", "社群2个", "品牌对接人：本地咖啡连锁"],
            ["SaaS试用名额100个", "API授权（14天）", "实施团队2人/2周"],
            ["赞助额度30万", "项目排期控制权", "合同模板/法务接口"]
        ];

        // 资源输入随机提示语
        const resourcePlaceholders = [
            "微信社群5个、视频号10万粉、年度广告预算50万、产品试用码100个、活动场地一天、品牌对接人：XX",
            "电商渠道位3个、线下门店2家、KOL合作位2期、媒体采访资源、API授权、课程版权",
            "企业客户名单200条、招商会场地、投委会路演名额、供应链工厂档期、施工队2组"
        ];

        // 随机设置提示语
        function setRandomPlaceholder() {
            const textareas = document.querySelectorAll('.dynamic-placeholder-textarea');
            textareas.forEach(textarea => {
                const randomText = inspirationTexts[Math.floor(Math.random() * inspirationTexts.length)];
                textarea.placeholder = `还有什么特别的点会让他愿意参与？比如：${randomText}`;
            });

            // 设置资源输入的随机提示语
            const resourceInputs = document.querySelectorAll('.dynamic-placeholder-resource');
            resourceInputs.forEach(input => {
                const randomPlaceholder = resourcePlaceholders[Math.floor(Math.random() * resourcePlaceholders.length)];
                input.placeholder = randomPlaceholder;
            });
        }



        // ==== 独立人物清单表格管理功能 ====

        // 存储人物数据的全局变量
        let personnelData = [];
        let currentEditingPersonId = null;

        // 角色映射
        const roleMapping = {
            'enterprise_owner': { text: '企业主', type: 'demand', displayText: '需求方-企业主' },
            'store_owner': { text: '实体店主', type: 'demand', displayText: '需求方-实体店主' },
            'department_head': { text: '部门负责人', type: 'demand', displayText: '需求方-部门负责人' },
            'brand_manager': { text: '主理人', type: 'demand', displayText: '需求方-主理人' },
            'product_provider': { text: '产品', type: 'delivery', displayText: '交付方-产品' },
            'service_provider': { text: '服务', type: 'delivery', displayText: '交付方-服务' },
            'traffic_provider': { text: '流量', type: 'delivery', displayText: '交付方-流量' },
            'other_provider': { text: '其他', type: 'delivery', displayText: '交付方-其他' },
            'funding_provider': { text: '资金提供方', type: 'funding', displayText: '资金提供方' }
        };

        // 添加新人物到独立表格
        function addNewPersonnel() {
            const newPerson = {
                id: Date.now(),
                name: '未命名',
                roles: [],
                resources: [],
                needs: []
            };

            personnelData.push(newPerson);
            updatePersonnelTable();

            // 立即编辑姓名
            setTimeout(() => {
                editPersonName(newPerson.id);
            }, 100);
        }

        // 更新人物清单表格
        function updatePersonnelTable() {
            const tableBody = document.getElementById('personnelTableBody');

            if (personnelData.length === 0) {
                tableBody.innerHTML = `
                    <div class="empty-personnel-state">
                        <div class="empty-state-content">
                            <i class="fas fa-users-slash"></i>
                            <h4>还没有添加关键人物</h4>
                            <p>点击下方按钮开始添加项目中的关键人物</p>
                        </div>
                    </div>
                `;
                return;
            }

            tableBody.innerHTML = '';
            personnelData.forEach((person, index) => {
                const row = createPersonnelRow(person, index + 1);
                tableBody.appendChild(row);
            });

            // 更新隐藏表单数据
            updateHiddenFormData();
        }

        // 创建人物表格行
        function createPersonnelRow(person, number) {
            const row = document.createElement('div');
            row.className = 'personnel-table-row';
            row.dataset.personId = person.id;

            // 角色标签
            const roleTagsHtml = person.roles.map(roleValue => {
                const roleInfo = roleMapping[roleValue];
                return roleInfo ? `<span class="role-tag ${roleInfo.type}">${roleInfo.displayText}</span>` : '';
            }).join('');

            // 资源摘要
            const resourcesSummary = person.resources.length > 0 ? 
                person.resources.slice(0, 2).join('、') + (person.resources.length > 2 ? '...' : '') : 
                '待添加';

            // 需求摘要
            const needsSummary = person.needs.length > 0 ? 
                person.needs.slice(0, 2).join('、') + (person.needs.length > 2 ? '...' : '') : 
                '待补充';

            row.innerHTML = `
                <!-- 桌面端表格布局 -->
                <div class="desktop-table-layout">
                    <div class="row-number">${number}</div>
                    <div class="row-name" onclick="editPersonName(${person.id})" style="cursor: pointer;">
                        ${person.name}
                    </div>
                    <div class="row-roles" onclick="editPersonRoles(${person.id})" style="cursor: pointer;">
                        ${roleTagsHtml || '<span style="color: #999;">未选择</span>'}
                    </div>
                    <div class="row-resources" onclick="editPersonResources(${person.id})" style="cursor: pointer;" title="${person.resources.join('、')}">
                        ${resourcesSummary}
                    </div>
                    <div class="row-needs" onclick="editPersonNeeds(${person.id})" style="cursor: pointer;" title="${person.needs.join('、')}">
                        ${needsSummary}
                    </div>
                    <div class="row-actions">
                        <button class="action-btn delete" onclick="deletePerson(${person.id})" title="删除此人物">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>

                <!-- 移动端卡片布局 -->
                <div class="mobile-card-layout">
                    <div class="mobile-person-header">
                        <div class="mobile-person-title">
                            <div class="row-number">${number}</div>
                            <div class="row-name" onclick="editPersonName(${person.id})" style="cursor: pointer;" title="点击编辑姓名">
                                <span class="mobile-field-prefix">姓名：</span>
                                <span class="name-content">${person.name}</span>
                                <div class="mobile-edit-hint">点击编辑</div>
                            </div>
                        </div>
                        <div class="row-actions">
                            <button class="action-btn delete" onclick="deletePerson(${person.id})" title="删除此人物">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>

                    <div class="mobile-person-content">
                        <div class="mobile-field">
                            <div class="mobile-field-label">身份角色</div>
                            <div class="mobile-field-content row-roles" onclick="editPersonRoles(${person.id})" style="cursor: pointer; padding: 8px; border-radius: 4px; transition: background-color 0.2s;" title="点击编辑身份角色">
                                ${roleTagsHtml || '<span style="color: #999;">未选择 <small>(点击编辑)</small></span>'}
                            </div>
                        </div>

                        <div class="mobile-field">
                            <div class="mobile-field-label">掌握资源</div>
                            <div class="mobile-field-content row-resources" onclick="editPersonResources(${person.id})" style="cursor: pointer; padding: 8px; border-radius: 4px; transition: background-color 0.2s;" title="点击编辑掌握资源">
                                ${resourcesSummary === '待添加' ? '<span style="color: #999;">待添加 <small>(点击编辑)</small></span>' : resourcesSummary}
                            </div>
                        </div>

                        <div class="mobile-field">
                            <div class="mobile-field-label">如何让TA高兴</div>
                            <div class="mobile-field-content row-needs" onclick="editPersonNeeds(${person.id})" style="cursor: pointer; padding: 8px; border-radius: 4px; transition: background-color 0.2s;" title="点击编辑让TA高兴的方式">
                                ${needsSummary === '待补充' ? '<span style="color: #999;">待补充 <small>(点击编辑)</small></span>' : needsSummary}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            return row;
        }

        // 编辑人物姓名（内联编辑）
        function editPersonName(personId) {
            const person = personnelData.find(p => p.id === personId);
            if (!person) {
                console.warn('未找到人物数据:', personId);
                return;
            }

            // 查找姓名元素，支持移动端和桌面端布局
            let nameCell = document.querySelector(`[data-person-id="${personId}"] .row-name`);

            // 如果没找到，可能是因为DOM结构问题，尝试其他选择器
            if (!nameCell) {
                const personRow = document.querySelector(`[data-person-id="${personId}"]`);
                if (personRow) {
                    nameCell = personRow.querySelector('.row-name');
                }
            }

            if (!nameCell) {
                console.warn('未找到姓名元素:', personId);
                return;
            }

            // 防止重复编辑
            if (nameCell.querySelector('input')) {
                return;
            }

            const currentName = person.name;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = currentName;
            input.className = 'form-control form-control-sm name-edit-input';
            input.style.cssText = `
                width: 100%;
                border: 2px solid #007AFF;
                border-radius: 6px;
                padding: 8px;
                font-size: 16px;
                font-weight: 600;
                background: white;
                box-shadow: 0 2px 8px rgba(0, 122, 255, 0.2);
            `;

            // 清空内容并添加输入框
            nameCell.innerHTML = '';
            nameCell.appendChild(input);

            // 聚焦并选中文本
            setTimeout(() => {
                input.focus();
                input.select();
            }, 50);

            const saveName = () => {
                const newName = input.value.trim() || '未命名';
                person.name = newName;
                updatePersonnelTable();

                // 显示保存成功提示
                showQuickToast('姓名已保存');
            };

            const cancelEdit = () => {
                updatePersonnelTable();
            };

            // 事件监听
            input.addEventListener('blur', saveName);
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    saveName();
                }
                if (e.key === 'Escape') {
                    e.preventDefault();
                    cancelEdit();
                }
            });
        }

        // 快速提示函数
        function showQuickToast(message) {
            const toast = document.createElement('div');
            toast.className = 'quick-toast';
            toast.textContent = message;
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #007AFF;
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 500;
                z-index: 10000;
                box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
                transform: translateX(100%);
                transition: transform 0.3s ease;
            `;

            document.body.appendChild(toast);

            // 滑入动画
            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 100);

            // 自动消失
            setTimeout(() => {
                toast.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.remove();
                    }
                }, 300);
            }, 2000);
        }

        // 编辑人物角色
        function editPersonRoles(personId) {
            currentEditingPersonId = personId;
            const person = personnelData.find(p => p.id === personId);
            if (!person) return;

            // 清空模态框选择
            document.querySelectorAll('#editRolesModal input[name="modal_person_role"]').forEach(checkbox => {
                checkbox.checked = person.roles.includes(checkbox.value);
            });

            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('editRolesModal'));
            modal.show();
        }

        // 编辑人物资源
        function editPersonResources(personId) {
            currentEditingPersonId = personId;
            const person = personnelData.find(p => p.id === personId);
            if (!person) return;

            // 填充当前资源
            const resourcesText = (person.resources || []).join('\n');
            document.getElementById('resourcesTextArea').value = resourcesText;

            // 根据已选择的角色生成智能推荐
            updateModalResourceSuggestions(person.roles || []);

            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('editResourcesModal'));
            modal.show();
        }

        // 为模态框更新资源推荐
        function updateModalResourceSuggestions(selectedRoles) {
            const suggestionsContainer = document.getElementById('modalResourceSuggestions');

            if (!suggestionsContainer) {
                console.warn('资源推荐容器未找到');
                return;
            }

            if (!selectedRoles || selectedRoles.length === 0) {
                suggestionsContainer.innerHTML = '<p class="text-muted">请先在角色选择中选择身份角色以获得智能推荐</p>';
                return;
            }

            // 获取所有选中角色的候选资源
            const allSuggestions = new Set();
            selectedRoles.forEach(role => {
                if (roleToResourceSuggestions[role]) {
                    roleToResourceSuggestions[role].forEach(resource => allSuggestions.add(resource));
                }
            });

            if (allSuggestions.size === 0) {
                suggestionsContainer.innerHTML = '<p class="text-muted">暂无推荐资源</p>';
                return;
            }

            // 生成推荐标签
            const tagsHtml = Array.from(allSuggestions).map(resource => 
                `<span class="suggestion-tag" onclick="addResourceSuggestion('${resource.replace(/'/g, "\\'")}')">${resource}</span>`
            ).join('');

            suggestionsContainer.innerHTML = `<div class="suggestion-tags">${tagsHtml}</div>`;
        }

        // 编辑人物需求
        function editPersonNeeds(personId) {
            currentEditingPersonId = personId;
            const person = personnelData.find(p => p.id === personId);
            if (!person) return;

            // 设置文本框内容
            document.getElementById('needsTextArea').value = person.needs.join('\n');

            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('editNeedsModal'));
            modal.show();

            // 绑定滚动事件
            setTimeout(() => {
                initNeedsStickyScroll();
            }, 300);
        }

        // 初始化粘性滚动效果
        function initNeedsStickyScroll() {
            const modalBody = document.querySelector('#editNeedsModal .modal-body');
            const stickySection = document.getElementById('needsStickySection');

            if (!modalBody || !stickySection) return;

            modalBody.addEventListener('scroll', () => {
                if (modalBody.scrollTop > 20) {
                    stickySection.classList.add('scrolled');
                } else {
                    stickySection.classList.remove('scrolled');
                }
            });
        }

        // 保存角色选择
        function saveRoles() {
            if (!currentEditingPersonId) return;

            const person = personnelData.find(p => p.id === currentEditingPersonId);
            if (!person) return;

            const selectedRoles = [];
            document.querySelectorAll('#editRolesModal input[name="modal_person_role"]:checked').forEach(checkbox => {
                selectedRoles.push(checkbox.value);
            });

            person.roles = selectedRoles;
            updatePersonnelTable();

            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('editRolesModal'));
            modal.hide();

            // 显示保存成功提示
            showQuickToast('角色已保存');
        }

        // 保存资源
        function saveResources() {
            if (!currentEditingPersonId) return;

            const person = personnelData.find(p => p.id === currentEditingPersonId);
            if (!person) return;

            const resourcesText = document.getElementById('resourcesTextArea').value;
            person.resources = resourcesText.split('\n').map(r => r.trim()).filter(r => r);

            updatePersonnelTable();

            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('editResourcesModal'));
            modal.hide();

            // 显示保存成功提示
            showQuickToast('资源已保存');
        }

        // 保存需求
        function saveNeeds() {
            if (!currentEditingPersonId) return;

            const person = personnelData.find(p => p.id === currentEditingPersonId);
            if (!person) return;

            const needsText = document.getElementById('needsTextArea').value;
            person.needs = needsText.split('\n').map(n => n.trim()).filter(n => n);

            updatePersonnelTable();

            // 关闭模态框
            const modal = bootstrap.Modal.getInstance(document.getElementById('editNeedsModal'));
            modal.hide();

            // 显示保存成功提示
            showQuickToast('需求已保存');
        }

        // 添加资源建议
        function addResourceSuggestion(resource) {
            const textarea = document.getElementById('resourcesTextArea');
            const currentValue = textarea.value;
            if (currentValue) {
                textarea.value = currentValue + (currentValue.endsWith('\n') ? '' : '\n') + resource;
            } else {
                textarea.value = resource;
            }
            textarea.focus();
        }

        // 添加需求建议
        function addNeedsSuggestion(need) {
            const textarea = document.getElementById('needsTextArea');
            const currentValue = textarea.value;
            if (currentValue) {
                textarea.value = currentValue + (currentValue.endsWith('\n') ? '' : '\n') + need;
            } else {
                textarea.value = need;
            }

            // 更新显示区域
            const needs = textarea.value.split('\n').map(n => n.trim()).filter(n => n);
            updateNeedsDisplay(needs);

            textarea.focus();
        }

        // 删除人物
        function deletePerson(personId) {
            if (confirm('确定要删除这个关键人物吗？')) {
                personnelData = personnelData.filter(p => p.id !== personId);
                updatePersonnelTable();
            }
        }

        // 更新隐藏表单数据
        function updateHiddenFormData() {
            const hiddenContainer = document.getElementById('hiddenPersonnelData');
            hiddenContainer.innerHTML = '';

            personnelData.forEach((person, index) => {
                // 添加隐藏字段以便表单提交
                const nameInput = document.createElement('input');
                nameInput.type = 'hidden';
                nameInput.name = 'person_name[]';
                nameInput.value = person.name;
                hiddenContainer.appendChild(nameInput);

                const rolesInput = document.createElement('input');
                rolesInput.type = 'hidden';
                rolesInput.name = 'person_role[]';
                rolesInput.value = person.roles.join(',');
                hiddenContainer.appendChild(rolesInput);

                const resourcesInput = document.createElement('input');
                resourcesInput.type = 'hidden';
                resourcesInput.name = 'person_resources[]';
                resourcesInput.value = person.resources.join(',');
                hiddenContainer.appendChild(resourcesInput);

                const needsInput = document.createElement('input');
                needsInput.type = 'hidden';
                needsInput.name = 'person_needs[]';
                needsInput.value = person.needs.join(',');
                hiddenContainer.appendChild(needsInput);
            });
        }





        // 表单提交前验证和处理
        document.getElementById('mainForm').addEventListener('submit', function(e) {
            e.preventDefault(); // 阻止默认表单提交

            const projectName = document.getElementById('project_name').value.trim();
            const projectDescription = document.getElementById('project_description').value.trim();

            if (!projectName || !projectDescription) {
                alert('请填写项目名称和背景描述');
                return;
            }

            // 添加提交动画
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>正在分析...';
            submitBtn.disabled = true;

            // 收集表单数据
            const formData = {
                projectName: projectName,
                projectDescription: projectDescription,
                keyPersons: []
            };

            // 收集关键人物数据（从独立人物清单）
            formData.keyPersons = personnelData.map(person => ({
                name: person.name,
                roles: person.roles,
                resources: person.resources,
                makeHappy: person.needs,
                notes: ''
            }));


            // 发送数据到后端Flask而不是sessionStorage
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/generate';
            form.style.display = 'none';

            // 添加项目基础信息
            const addInput = (name, value) => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = name;
                input.value = value;
                form.appendChild(input);
            };

            addInput('project_name', formData.projectName);
            addInput('project_description', formData.projectDescription);


            // 添加关键人物数据
            formData.keyPersons.forEach((person, index) => {
                addInput('person_name[]', person.name);
                addInput('person_role[]', person.roles.join(','));
                addInput('person_resources[]', person.resources.join(','));
                addInput('person_needs[]', person.makeHappy.join(','));
            });


            // 提交表单
            document.body.appendChild(form);
            form.submit();
        });

        // 测试案例数据
        const demoTestCases = {
            'english-training': {
                projectName: 'Bonnie英语培训管道',
                projectDescription: '有一天，一个做升学规划的朋友在饭局上随口吐槽："最近合作的英语机构交付太差，特别不靠谱，你有没有靠谱的老师推荐？"我发现我有这个朋友就有生源，我可以去找老师就有交付，我来做连接不就能搭个闭环？而且机构交付差是因为价格太低只有市场价1/3，我就设计标准化产品配助教，成本降下来。',
                projectStage: 'testing',
                persons: [
                    {
                        name: '升学规划师朋友',
                        roles: ['channel'],
                        resources: ['家长客户资源', '升学规划服务信任度', '教育圈人脉'],
                        makeHappy: ['bring_leads', 'no_conflict_current_partner', 'recurring_income'],
                        notes: '有流量焦虑，经常有家长问英语培训推荐'
                    },
                    {
                        name: '英语培训机构',
                        roles: ['product', 'delivery'],
                        resources: ['英语课程产品', '师资助教团队', '线上教学系统'],
                        makeHappy: ['bring_leads', 'brand_exposure'],
                        notes: '想转型线上，有流量焦虑，交付成本高'
                    }
                ]
            },
            'rental-business': {
                projectName: 'Angela临街商铺二房东管道',
                projectDescription: '我打了20多个电话调研发现一个房东有临街双层商铺，挂了两三个月都租不出去，因为房东要求整租，很多人想分开租上下层。更重要的是，这个铺子没有煤气不能做热菜，所以餐饮做不了。但通过市场调研我发现一楼可以做便利店、水果店，二楼可以做美容SPA、理发店。房东还是个社恐，太好了！',
                projectStage: 'testing',
                persons: [
                    {
                        name: '社恐房东',
                        roles: ['investor'],
                        resources: ['临街双层商铺', '5年长期租约意愿', '稳定现金流需求'],
                        makeHappy: ['recurring_income', 'no_money_no_liability', 'no_public_appearance'],
                        notes: '社恐不想跟太多租客打交道，要求整租，铺子空置好几个月'
                    }
                ]
            },
            'cicada-farming': {
                projectName: '楚楚知了猴7条管道',
                projectDescription: '我是十八线小县城美容院老板娘，全年无休当高强度打工者。老公开玩笑说"要不咱们养一片林子自己抓知了猴吧？"让我意识到这么多人吃知了猴，我为什么不能做供货方？我盘了4个关键资源：销路（烧烤摊、餐馆供不应求）、林地（老公同学有柳树林）、蝉卵（劳务市场乡亲能捡）、技术（当地养殖户教学）。',
                projectStage: 'testing',
                persons: [
                    {
                        name: '柳树林主',
                        roles: ['investor'],
                        resources: ['柳树林地', '除草需求', '长期合作意愿'],
                        makeHappy: ['use_idle_assets', 'recurring_income', 'no_money_no_liability'],
                        notes: '除草成本高是真正痛点，我们帮他除草换取低价租金'
                    },
                    {
                        name: '当地养殖户老师',
                        roles: ['expert'],
                        resources: ['知了猴养殖技术', '成功经验', '行业人脉'],
                        makeHappy: ['be_recognized', 'brand_exposure', 'be_consultant'],
                        notes: '被称为"乡村袁隆平"，感受到尊重后愿意倾囊相授'
                    },
                    {
                        name: '劳务市场大爷大妈',
                        roles: ['delivery'],
                        resources: ['蝉卵采集能力', '山区熟悉度', '时间充裕'],
                        makeHappy: ['recurring_income', 'be_recognized'],
                        notes: '以件计价不设打卡，干得开心效率更高'
                    },
                    {
                        name: '烧烤摊餐馆老板',
                        roles: ['buyer'],
                        resources: ['稳定销路需求', '现金交易', '食材采购渠道'],
                        makeHappy: ['stable_supply', 'cost_control', 'unique_products'],
                        notes: '知了猴供不应求，愿意预付定金确保稳定供货'
                    }
                ]
            }
        };

        // 处理测试案例选择
        function handleDemoCaseSelection() {
            const caseCards = document.querySelectorAll('.demo-case-card');

            caseCards.forEach(card => {
                card.addEventListener('click', function() {
                    const caseType = this.dataset.case;

                    // 移除其他卡片的选中状态
                    caseCards.forEach(c => c.classList.remove('selected'));

                    if (caseType === 'custom') {
                        // 自定义项目 - 清空表单
                        this.classList.add('selected');
                        clearForm();
                        scrollToForm();
                    } else if (demoTestCases[caseType]) {
                        // 选择测试案例 - 填充表单
                        this.classList.add('selected');
                        loadTestCase(demoTestCases[caseType]);
                        scrollToForm();

                        // 显示成功提示
                        showNotification('✅ 示例案例已加载完成！向下滚动查看表单内容，可直接提交分析或修改参数', 'success');
                    }
                });
            });
        }

        // 加载测试案例数据到表单
        function loadTestCase(caseData) {
            // 强制显示所有表单元素（移除动画类避免时序问题）
            const mainForm = document.getElementById('mainForm');
            if (mainForm) {
                // 移除可能影响显示的动画类
                const animatedElements = mainForm.querySelectorAll('.fade-in, .slide-up');
                animatedElements.forEach(el => {
                    el.classList.remove('fade-in', 'slide-up');
                    el.style.opacity = '1';
                    el.style.transform = 'translateY(0)';
                    el.style.visibility = 'visible';
                });

                // 强制重新布局
                mainForm.style.display = 'block';
                mainForm.offsetHeight; // 触发重绘
            }

            // 填充项目基础信息
            const projectNameEl = document.getElementById('project_name');
            const projectDescEl = document.getElementById('project_description');
            const projectStageEl = document.getElementById('project_stage');

            if (projectNameEl) {
                projectNameEl.value = caseData.projectName || '';
                projectNameEl.setAttribute('value', caseData.projectName || '');
            }
            if (projectDescEl) {
                projectDescEl.value = caseData.projectDescription || '';
                projectDescEl.textContent = caseData.projectDescription || '';
            }


            // 清空现有人物卡片并重置计数器
            const personsContainer = document.getElementById('personsContainer');
            if (personsContainer) {
                personsContainer.innerHTML = '';
                personCount = 0; // 重置人物计数器

                // 确保容器可见
                personsContainer.style.display = 'block';
                personsContainer.style.opacity = '1';
                personsContainer.style.visibility = 'visible';
            }

            // 添加测试案例中的人物
            if (caseData.persons && caseData.persons.length > 0) {
                caseData.persons.forEach((person, index) => {
                    addPerson();
                    const personCards = document.querySelectorAll('.person-card');
                    const currentCard = personCards[personCards.length - 1];

                    if (!currentCard) return;

                    // 强制显示人物卡片（移除动画类）
                    currentCard.classList.remove('fade-in', 'slide-up');
                    currentCard.style.opacity = '1';
                    currentCard.style.transform = 'translateY(0)';
                    currentCard.style.visibility = 'visible';
                    currentCard.style.display = 'block';

                    // 填充人物信息
                    const nameInput = currentCard.querySelector('input[name="person_name[]"]');
                    if (nameInput) {
                        nameInput.value = person.name || '';
                        nameInput.setAttribute('value', person.name || '');
                        // 强制显示输入框内容
                        nameInput.style.opacity = '1';
                        nameInput.style.visibility = 'visible';
                    }

                    // 选择角色
                    if (person.roles) {
                        person.roles.forEach(role => {
                            const roleCheckbox = currentCard.querySelector(`input[name="person_role[]"][value="${role}"]`);
                            if (roleCheckbox) {
                                roleCheckbox.checked = true;
                            }
                        });
                        updateRolesSummary(currentCard);
                        updateResourceSuggestions(currentCard.dataset.personId); // Pass personId
                    }

                    // 添加资源
                    if (person.resources) {
                        person.resources.forEach(resource => {
                            const personId = currentCard.querySelector('.resource-input').dataset.personId;
                            addSelectedResource(resource, personId);
                        });
                    }

                    // 选择需求选项
                    if (person.makeHappy) {
                        person.makeHappy.forEach(need => {
                            const needCheckbox = currentCard.querySelector(`input[name="person_needs[]"][value="${need}"]`);
                            if (needCheckbox) {
                                needCheckbox.checked = true;
                            }
                        });
                    }

                    // 填充备注
                    const notesTextarea = currentCard.querySelector('textarea[name="person_notes[]"]');
                    if (notesTextarea) notesTextarea.value = person.notes || '';

                    // 在最后一个人物加载完成后更新编号
                    if (index === caseData.persons.length - 1) {
                        updatePersonNumbers();
                    }
                });
            }


        }

        // 清空表单
        function clearForm() {
            document.getElementById('project_name').value = '';
            document.getElementById('project_description').value = '';

            document.getElementById('personsContainer').innerHTML = '';
            personCount = 0; // 重置计数器
            addPerson();


        }

        // 滚动到表单区域
        function scrollToForm() {
            const formElement = document.getElementById('mainForm');
            if (formElement) {
                setTimeout(() => {
                    formElement.scrollIntoView({
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                    // 强制重新渲染表单以确保内容显示
                    setTimeout(() => {
                        // 触发重绘
                        const inputs = formElement.querySelectorAll('input, textarea, select');
                        inputs.forEach(input => {
                            if (input.value) {
                                input.dispatchEvent(new Event('input', { bubbles: true }));
                            }
                        });
                    }, 500);
                }, 800);
            }
        }

        // 显示通知消息
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} slide-up`;
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '9999';
            notification.style.maxWidth = '400px';

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // === 缺失的辅助函数 ===

        // 添加资源推荐到文本框
        function addResourceSuggestion(resource) {
            const textarea = document.getElementById('resourcesTextArea');
            if (!textarea) return;

            const currentValue = textarea.value.trim();
            const newValue = currentValue ? currentValue + '\n' + resource : resource;
            textarea.value = newValue;
            
            // 触发输入事件以更新UI
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
        }

        // 添加需求推荐到文本框
        function addNeedsSuggestion(need) {
            const textarea = document.getElementById('needsTextArea');
            if (!textarea) return;

            const currentValue = textarea.value.trim();
            const newValue = currentValue ? currentValue + '\n' + need : need;
            textarea.value = newValue;
            
            // 触发输入事件以更新UI
            textarea.dispatchEvent(new Event('input', { bubbles: true }));
        }

        // 添加人物函数（兼容旧的调用方式）
        function addPerson() {
            addNewPersonnel();
        }

        // 更新需求显示（占位函数，兼容旧代码）
        function updateNeedsDisplay() {
            // 这个函数主要是为了兼容性，实际的更新由updatePersonnelTable处理
            console.log('updateNeedsDisplay called - handled by updatePersonnelTable');
        }

        // 初始化交互功能
        function initializeInteractions() {
            console.log('交互功能已初始化');
            
            // 初始化人物表格
            if (typeof updatePersonnelTable === 'function') {
                updatePersonnelTable();
            }
            
            // 设置随机提示语
            if (typeof setRandomPlaceholder === 'function') {
                setRandomPlaceholder();
            }
            
            // 处理测试案例选择
            if (typeof handleDemoCaseSelection === 'function') {
                handleDemoCaseSelection();
            }
        }

        // 为模态框生成资源推荐
        function generateResourceSuggestionsForModal() {
            // 获取当前编辑的人物信息
            if (!currentEditingPersonId) return;
            
            const person = personnelData.find(p => p.id === currentEditingPersonId);
            if (!person) return;
            
            // 调用现有的更新函数
            if (typeof updateModalResourceSuggestions === 'function') {
                updateModalResourceSuggestions(person.roles || []);
            }
        }

        // 删除人物
        function deletePerson(personId) {
            const person = personnelData.find(p => p.id === personId);
            if (!person) return;
            
            if (confirm(`确定要删除"${person.name}"吗？`)) {
                personnelData = personnelData.filter(p => p.id !== personId);
                updatePersonnelTable();
                showQuickToast('人物已删除');
            }
        }



        // 添加平滑滚动
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // 添加输入框焦点动画
        document.querySelectorAll('.form-control').forEach(input => {
            input.addEventListener('focus', function() {
                this.parentElement.classList.add('focused');
            });

            input.addEventListener('blur', function() {
                this.parentElement.classList.remove('focused');
            });
        });

        // 移动端汉堡菜单功能
        function toggleMobileMenu() {
            const dropdown = document.getElementById('mobileDropdown');
            const toggle = document.querySelector('.mobile-menu-toggle');
            const icon = toggle.querySelector('i');

            if (dropdown.classList.contains('show')) {
                dropdown.classList.remove('show');
                icon.className = 'fas fa-bars';
            } else {
                dropdown.classList.add('show');
                icon.className = 'fas fa-times';
            }
        }

        // 修复缺失的JavaScript函数
        function addPerson() {
            // 这个函数在独立人物清单系统中已被addNewPersonnel替代
            addNewPersonnel();
        }

        function updateNeedsDisplay(needs) {
            // 在需求编辑模态框中更新显示
            // 这个函数主要用于模态框内部，现在由其他函数处理
            console.log('更新需求显示:', needs);
        }

        function initializeInteractions() {
            // 初始化所有交互功能
            console.log('交互功能已初始化');
        }

        function generateResourceSuggestionsForModal(selectedRoles) {
            // 兼容旧的函数调用，使用新的函数名
            updateModalResourceSuggestions(selectedRoles);
        }

        // 修复角色选择后的资源推荐更新
        document.addEventListener('DOMContentLoaded', function() {
            // 监听角色选择变化
            const roleModal = document.getElementById('editRolesModal');
            if (roleModal) {
                roleModal.addEventListener('show.bs.modal', function() {
                    // 当角色模态框显示时，确保当前编辑人物ID已设置
                    console.log('编辑角色模态框已打开，当前编辑人物ID:', currentEditingPersonId);
                });
            }

            // 监听资源模态框显示事件
            const resourceModal = document.getElementById('editResourcesModal');
            if (resourceModal) {
                resourceModal.addEventListener('show.bs.modal', function() {
                    const person = personnelData.find(p => p.id === currentEditingPersonId);
                    if (person) {
                        updateModalResourceSuggestions(person.roles || []);
                    }
                });
            }
        });

        // 修复移动端编辑功能 - 确保模态框中的资源推荐功能正常
        function updateModalResourceSuggestions(selectedRoles) {
            const suggestionsContainer = document.getElementById('modalResourceSuggestions');

            if (!suggestionsContainer) {
                console.warn('资源推荐容器未找到');
                return;
            }

            if (!selectedRoles || selectedRoles.length === 0) {
                suggestionsContainer.innerHTML = '<p class="text-muted">请先在角色选择中选择身份角色以获得智能推荐</p>';
                return;
            }

            // 获取所有选中角色的候选资源
            const allSuggestions = new Set();
            selectedRoles.forEach(role => {
                if (roleToResourceSuggestions[role]) {
                    roleToResourceSuggestions[role].forEach(resource => allSuggestions.add(resource));
                }
            });

            if (allSuggestions.size === 0) {
                suggestionsContainer.innerHTML = '<p class="text-muted">暂无推荐资源</p>';
                return;
            }

            // 生成推荐标签
            const tagsHtml = Array.from(allSuggestions).map(resource => 
                `<span class="suggestion-tag" onclick="addResourceSuggestion('${resource.replace(/'/g, "\\'")}')">${resource}</span>`
            ).join('');

            suggestionsContainer.innerHTML = `<div class="suggestion-tags">${tagsHtml}</div>`;
        }

        // 点击菜单外部关闭菜单
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('mobileDropdown');
            const toggle = document.querySelector('.mobile-menu-toggle');

            if (dropdown && dropdown.classList.contains('show') && 
                !dropdown.contains(event.target) && !toggle.contains(event.target)) {
                dropdown.classList.remove('show');
                toggle.querySelector('i').className = 'fas fa-bars';
            }
        });

        // 点击菜单项后关闭菜单
        document.querySelectorAll('.mobile-dropdown .dropdown-item').forEach(item => {
            item.addEventListener('click', function() {
                const dropdown = document.getElementById('mobileDropdown');
                const toggle = document.querySelector('.mobile-menu-toggle');
                dropdown.classList.remove('show');
                toggle.querySelector('i').className = 'fas fa-bars';
            });
        });
    </script>

    <!-- 模态框：编辑身份角色 -->
    <div class="modal fade" id="editRolesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑身份角色</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="role-categories">
                        <div class="role-category" data-category="demand">
                            <h6 class="role-category-title demand">
                                <i class="fas fa-user-tie"></i>
                                需求方
                            </h6>
                            <div class="role-options">
                                <label class="role-item" data-tooltip="拥有企业决策权，需要项目带来商业价值">
                                    <input type="checkbox" name="modal_person_role" value="enterprise_owner">
                                    <span>企业主</span>
                                    <div class="role-tooltip">拥有企业决策权，需要项目带来商业价值</div>
                                </label>
                                <label class="role-item" data-tooltip="经营实体门店，关注客流量和营业额提升">
                                    <input type="checkbox" name="modal_person_role" value="store_owner">
                                    <span>实体店主</span>
                                    <div class="role-tooltip">经营实体门店，关注客流量和营业额提升</div>
                                </label>
                                <label class="role-item" data-tooltip="管理特定部门，需要提升部门业绩和效率">
                                    <input type="checkbox" name="modal_person_role" value="department_head">
                                    <span>部门负责人</span>
                                    <div class="role-tooltip">管理特定部门，需要提升部门业绩和效率</div>
                                </label>
                                <label class="role-item" data-tooltip="品牌或产品的主要负责人，注重品牌价值和影响力">
                                    <input type="checkbox" name="modal_person_role" value="brand_manager">
                                    <span>主理人</span>
                                    <div class="role-tooltip">品牌或产品的主要负责人，注重品牌价值和影响力</div>
                                </label>
                            </div>
                        </div>

                        <div class="role-category" data-category="delivery">
                            <h6 class="role-category-title delivery">
                                <i class="fas fa-hands-helping"></i>
                                交付方
                            </h6>
                            <div class="role-options">
                                <label class="role-item" data-tooltip="提供具体产品或商品，负责产品质量和供应链">
                                    <input type="checkbox" name="modal_person_role" value="product_provider">
                                    <span>产品</span>
                                    <div class="role-tooltip">提供具体产品或商品，负责产品质量和供应链</div>
                                </label>
                                <label class="role-item" data-tooltip="提供专业服务或技能，注重服务质量和客户满意度">
                                    <input type="checkbox" name="modal_person_role" value="service_provider">
                                    <span>服务</span>
                                    <div class="role-tooltip">提供专业服务或技能，注重服务质量和客户满意度</div>
                                </label>
                                <label class="role-item" data-tooltip="提供客户资源或推广渠道，关注转化率和用户质量">
                                    <input type="checkbox" name="modal_person_role" value="traffic_provider">
                                    <span>流量</span>
                                    <div class="role-tooltip">提供客户资源或推广渠道，关注转化率和用户质量</div>
                                </label>
                                <label class="role-item" data-tooltip="提供其他资源或支持，可能包括场地、设备、信息等">
                                    <input type="checkbox" name="modal_person_role" value="other_provider">
                                    <span>其他</span>
                                    <div class="role-tooltip">提供其他资源或支持，可能包括场地、设备、信息等</div>
                                </label>
                            </div>
                        </div>

                        <div class="role-category" data-category="funding">
                            <h6 class="role-category-title funding">
                                <i class="fas fa-coins"></i>
                                资金方
                            </h6>
                            <div class="role-options">
                                <label class="role-item" data-tooltip="提供项目资金支持，关注投资回报和风险控制">
                                    <input type="checkbox" name="modal_person_role" value="funding_provider">
                                    <span>资金提供方</span>
                                    <div class="role-tooltip">提供项目资金支持，关注投资回报和风险控制</div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveRoles()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框：编辑掌握资源 -->
    <div class="modal fade" id="editResourcesModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑掌握资源</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="resourcesTextArea" class="form-label">掌握的资源</label>
                        <textarea class="form-control" id="resourcesTextArea" rows="6" 
                                placeholder="每行一个资源，例如：&#10;微信群500人&#10;抖音账号10万粉丝&#10;采购预算50万"></textarea>
                    </div>

                    <div class="mb-3">
                        <h6 class="text-muted mb-3">
                            <i class="fas fa-lightbulb text-warning me-1"></i>
                            基于身份角色的资源推荐
                        </h6>
                        <div id="modalResourceSuggestions" class="modal-resource-suggestions">
                            <!-- 智能推荐内容将在这里动态生成 -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveResources()">保存</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框：编辑如何让TA高兴 -->
    <div class="modal fade" id="editNeedsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">编辑如何让TA高兴</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 粘性顶部区域：输入区域 -->
                    <div class="needs-sticky-section" id="needsStickySection">
                        <div class="mb-3">
                            <label class="form-label">添加让TA高兴的方式（一行一个）</label>
                            <textarea class="form-control" id="needsTextArea" rows="6" placeholder="请输入让这个人高兴的方式，每个方式占一行&#10;例如：&#10;获得更多利润&#10;提升品牌知名度&#10;节省运营成本&#10;获得认可和尊重"></textarea>
                        </div>
                    </div>
                    <div class="needs-suggestions">
                        <div class="motivation-category">
                            <div class="category-header">
                                <span class="category-icon green">💚</span>
                                <h6>想看到回报 / 实际效果</h6>
                                <p>他在意投入和产出，有明确的"结果导向"。</p>
                            </div>
                            <div class="motivation-tags">
                                <span class="motivation-tag" onclick="addNeedsSuggestion('拿到分成/抽成')">拿到分成/抽成</span>
                                <span class="motivation-tag" onclick="addNeedsSuggestion('带来客户/用户')">带来客户/用户</span>
                                <span class="motivation-tag" onclick="addNeedsSuggestion('项目尽快落地')">项目尽快落地</span>
                                <span class="motivation-tag" onclick="addNeedsSuggestion('能长期持续赚钱')">能长期持续赚钱</span>
                                <span class="motivation-tag" onclick="addNeedsSuggestion('有资源被用起来（不闲置）')">有资源被用起来（不闲置）</span>
                            </div>
                        </div>

                        <div class="motivation-category">
                            <div class="category-header">
                                <span class="category-icon blue">💙</span>
                                <h6>想被看到 / 被宣传</h6>
                                <p>他要曝光，要名声，而且最好是精准曝光。</p>
                            </div>
                            <div class="motivation-tags">
                                <span class="motivation-tag" onclick="addNeedsSuggestion('有品牌露出（线上线下）')">有品牌露出（线上线下）</span>
                                <span class="motivation-tag" onclick="addNeedsSuggestion('打造个人标签/专家身份')">打造个人标签/专家身份</span>
                                <span class="motivation-tag" onclick="addNeedsSuggestion('曝光到目标圈层')">曝光到目标圈层</span>
                                <span class="motivation-tag" onclick="addNeedsSuggestion('项目中看起来是主导者')">项目中看起来是主导者</span>
                            </div>
                        </div>

                        <div class="motivation-category">
                            <div class="category-header">
                                <span class="category-icon red">❤️</span>
                                <h6>不想冒风险</h6>
                                <p>他想参与，但不能有风险或预损失。</p>
                            </div>
                            <div class="motivation-tags">
                                <span class="motivation-tag" onclick="addNeedsSuggestion('不出钱不担责')">不出钱不担责</span>
                                <span class="motivation-tag" onclick="addNeedsSuggestion('不公开露脸')">不公开露脸</span>
                                <span class="motivation-tag" onclick="addNeedsSuggestion('不影响已有合作方')">不影响已有合作方</span>
                                <span class="motivation-tag" onclick="addNeedsSuggestion('保证信息保密')">保证信息保密</span>
                                <span class="motivation-tag" onclick="addNeedsSuggestion('可隐身参与（不被对手知道）')">可隐身参与（不被对手知道）</span>
                            </div>
                        </div>

                        <div class="motivation-category">
                            <div class="category-header">
                                <span class="category-icon gray">🔴</span>
                                <h6>想被尊重 / 有地位</h6>
                                <p>他要身份感，面子感和圈子认可。</p>
                            </div>
                            <div class="motivation-tags">
                                <span class="motivation-tag" onclick="addNeedsSuggestion('成为顾问/专家')">成为顾问/专家</span>
                                <span class="motivation-tag" onclick="addNeedsSuggestion('被认可很重要')">被认可很重要</span>
                                <span class="motivation-tag" onclick="addNeedsSuggestion('提升在圈子里的地位')">提升在圈子里的地位</span>
                                <span class="motivation-tag" onclick="addNeedsSuggestion('像是他发起的局')">像是他发起的局</span>
                            </div>
                        </div>


                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveNeeds()">保存</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>