<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Angela · 非劳务收入管道设计师</title>
    
    <!-- 预加载关键字体 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <!-- Apple级别设计系统 -->
    <link href="{{ url_for('static', filename='css/apple-design-system.css') }}" rel="stylesheet">
    <!-- 未来科幻增强版设计系统 -->
    <link href="{{ url_for('static', filename='css/future-enhanced-apple.css') }}" rel="stylesheet">
    <!-- 按钮修复样式 -->
    <link href="{{ url_for('static', filename='css/button-fix.css') }}" rel="stylesheet">
    
    <!-- SEO优化 -->
    <meta name="description" content="Angela - Apple级别AI驱动的非劳务收入管道设计工具，世界一流的用户体验">
    <meta name="keywords" content="AI收入设计,非劳务收入,智能管道,商业策略,Apple设计">
</head>
<body>
    <!-- Apple风格导航栏 -->
    <nav class="navigation-bar">
        <div class="nav-content">
            <a href="{{ url_for('index') }}" class="nav-brand">
                <i class="fas fa-brain"></i>
                Angela
            </a>
            <div class="nav-actions">
                <a href="{{ url_for('analysis_history') }}" class="btn btn-primary btn-small" style="margin-right: var(--space-3);">
                    <i class="fas fa-history me-2"></i>历史记录
                </a>
                <a href="{{ url_for('admin_dashboard') }}" class="btn btn-secondary btn-small">
                    <i class="fas fa-cog me-2"></i>管理中心
                </a>
            </div>
        </div>
    </nav>

    <!-- 主要内容区域 -->
    <main class="main-content">
        <!-- 页面标题区域 -->
        <header class="page-header">
            <h1 class="page-title">非劳务收入管道设计师</h1>
            <p class="page-subtitle">根据您的项目和关键人物信息，生成个性化的非劳务收入管道方案</p>
            
            <!-- 测试案例选择区域 -->
            <div class="demo-cases-section">
                <div class="demo-cases-header">
                    <h3>
                        <i class="fas fa-lightbulb"></i>
                        快速开始-选择示例案例
                    </h3>
                    <p>选择下方任一真实案例，快速体验Angela AI的分析能力</p>
                </div>
                <div class="demo-cases-grid">
                    <div class="demo-case-card" data-case="english-training">
                        <div class="case-icon">
                            <i class="fas fa-graduation-cap"></i>
                        </div>
                        <div class="case-content">
                            <h4>英语培训管道案例</h4>
                            <p>通过连接升学规划师和英语机构，3个月内搭建年收入40万的培训管道</p>
                            <div class="case-tags">
                                <span class="tag">教育培训</span>
                                <span class="tag">B2B连接</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="demo-case-card" data-case="rental-business">
                        <div class="case-icon">
                            <i class="fas fa-building"></i>
                        </div>
                        <div class="case-content">
                            <h4>商铺租赁管道案例</h4>
                            <p>1万元启动资金，通过二房东模式，8年累计收益72万</p>
                            <div class="case-tags">
                                <span class="tag">房地产</span>
                                <span class="tag">差价收益</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="demo-case-card" data-case="cicada-farming">
                        <div class="case-icon">
                            <i class="fas fa-seedling"></i>
                        </div>
                        <div class="case-content">
                            <h4>知了猴养殖管道案例</h4>
                            <p>1万元启动成本，搭建7条管道，实现年收入70万的农村创业</p>
                            <div class="case-tags">
                                <span class="tag">农业创新</span>
                                <span class="tag">资源整合</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="demo-case-card" data-case="custom">
                        <div class="case-icon">
                            <i class="fas fa-edit"></i>
                        </div>
                        <div class="case-content">
                            <h4>自定义项目</h4>
                            <p>根据您的实际情况，从零开始设计专属的非劳务收入方案</p>
                            <div class="case-tags">
                                <span class="tag">个性定制</span>
                                <span class="tag">原创设计</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div style="margin-bottom: var(--space-8);">
                    {% for category, message in messages %}
                        <div class="alert alert-{{ 'error' if category == 'error' else 'info' }} slide-up">
                            {{ message }}
                        </div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <!-- 主要表单 -->
        <form method="POST" action="{{ url_for('generate') }}" id="mainForm">
            
            <!-- 项目基础信息模块 -->
            <div class="card interactive-hover">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-rocket"></i>
                        项目基础信息
                    </h3>
                </div>
                <div class="card-body">
                    <div class="form-group">
                        <label for="project_name" class="form-label">项目名称</label>
                        <input type="text" class="form-control" id="project_name" name="project_name" 
                               placeholder="请输入您的项目名称" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="project_description" class="form-label">项目背景描述</label>
                        <textarea class="form-control" id="project_description" name="project_description" 
                                  placeholder="详细描述您的项目背景、目标和现状..." required></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="project_stage" class="form-label">项目阶段</label>
                        <select class="form-control" id="project_stage" name="project_stage">
                            <option value="">选择项目当前阶段</option>
                            <option value="idea">想法阶段</option>
                            <option value="planning">规划阶段</option>
                            <option value="development">开发阶段</option>
                            <option value="testing">测试阶段</option>
                            <option value="launch">准备上线</option>
                            <option value="running">已上线运营</option>
                            <option value="scaling">规模化扩展</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- 关键人物模块 -->
            <div class="card interactive-hover">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-users"></i>
                        关键人物列表
                    </h3>
                </div>
                <div class="card-body">
                    <div id="personsContainer">
                        <!-- 初始人物卡片将由JavaScript动态生成 -->
                    </div>
                    
                    <div class="text-center mt-4" id="emptyState">
                        <p class="text-muted">
                            <i class="fas fa-users-slash"></i>
                            还没有添加关键人物，点击下方按钮开始添加
                        </p>
                    </div>
                    <div class="text-center">
                        <button type="button" class="btn btn-primary interactive gpu-accelerated" onclick="addPerson()">
                            <i class="fas fa-plus me-2"></i>
                            添加关键人物
                        </button>
                    </div>
                </div>
            </div>

            <!-- 外部资源模块 -->
            <div class="card interactive-hover">
                <div class="card-header">
                    <h3 class="card-title">
                        <i class="fas fa-network-wired"></i>
                        外部资源与合作
                    </h3>
                </div>
                <div class="card-body">
                    <!-- 区别说明 -->
                    <div class="resource-description">
                        <i class="fas fa-info-circle me-2"></i>
                        这里填写"不依赖单个人"的资源，例如组织、平台、政策、公共合作伙伴<br>
                        <strong>区别：</strong>关键人物资源 = 需要去找人拿；外部资源 = 你直接就能用
                    </div>

                    <!-- 资源分类 -->
                    <div class="resource-categories">
                        <!-- 资金支持类 -->
                        <div class="resource-category-section">
                            <h5 class="resource-category-title">
                                <i class="fas fa-coins me-2"></i>
                                资金支持
                            </h5>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="external_resources" value="政府补贴">
                                    <span>政府补贴</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="external_resources" value="投资机构">
                                    <span>投资机构</span>
                                </label>
                            </div>
                        </div>

                        <!-- 市场渠道类 -->
                        <div class="resource-category-section">
                            <h5 class="resource-category-title">
                                <i class="fas fa-bullhorn me-2"></i>
                                市场渠道
                            </h5>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="external_resources" value="媒体渠道">
                                    <span>媒体渠道</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="external_resources" value="行业协会">
                                    <span>行业协会</span>
                                </label>
                            </div>
                        </div>

                        <!-- 执行能力类 -->
                        <div class="resource-category-section">
                            <h5 class="resource-category-title">
                                <i class="fas fa-cogs me-2"></i>
                                执行能力
                            </h5>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="external_resources" value="供应链资源">
                                    <span>供应链资源</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="external_resources" value="技术平台">
                                    <span>技术平台</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="external_resources" value="专业服务机构">
                                    <span>专业服务机构</span>
                                </label>
                            </div>
                        </div>

                        <!-- 战略合作类 -->
                        <div class="resource-category-section">
                            <h5 class="resource-category-title">
                                <i class="fas fa-handshake me-2"></i>
                                战略合作
                            </h5>
                            <div class="checkbox-group">
                                <label class="checkbox-item">
                                    <input type="checkbox" name="external_resources" value="已有合作伙伴">
                                    <span>已有合作伙伴</span>
                                </label>
                                <label class="checkbox-item">
                                    <input type="checkbox" name="external_resources" value="联盟组织">
                                    <span>联盟组织</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 其他资源输入 -->
                    <div class="form-group" style="margin-top: var(--space-6);">
                        <label class="checkbox-item">
                            <input type="checkbox" id="other_resource_checkbox" name="other_resource_checkbox">
                            <span>其他资源</span>
                        </label>
                        <input type="text" class="form-control" id="other_resource_text" name="other_resource_text" 
                               placeholder="例如：公司签署的框架协议、认证资质、专利技术、开放API接口等..." 
                               style="margin-top: var(--space-3); display: none;">
                    </div>
                </div>
            </div>

            <!-- 提交按钮 -->
            <div style="text-align: center; margin-top: 32px; padding-top: 24px; border-top: 1px solid rgba(0, 0, 0, 0.1);">
                <button type="submit" class="btn btn-primary btn-large interactive gpu-accelerated">
                    <i class="fas fa-magic me-2"></i>
                    开始AI智能分析
                </button>
                <p style="margin-top: 16px; color: #666; font-size: 14px;">
                    基于您提供的信息，AI将在几秒内生成专业的收入管道设计方案
                </p>
            </div>
        </form>
    </main>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/future-enhanced-interactions.js') }}"></script>
    <script>
        // 人物计数器
        let personCount = 0;
        
        // 添加人物卡片
        function addPerson() {
            personCount++;
            const container = document.getElementById('personsContainer');
            
            const personCard = document.createElement('div');
            personCard.className = 'person-card';
            personCard.innerHTML = `
                <div class="person-card-header">
                    <div class="person-number">${personCount}</div>
                    <button type="button" class="remove-person-btn" onclick="removePerson(this)">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="form-group">
                    <label class="form-label">人物代号/姓名</label>
                    <input type="text" class="form-control" name="person_name[]" placeholder="例如：A总">
                </div>
                
                <div class="form-group">
                    <label class="form-label">
                        身份角色（可多选）
                        <span class="help-icon" data-tooltip="请选择该人物在项目中的身份角色，可选择多个">
                            <i class="fas fa-question-circle"></i>
                        </span>
                    </label>
                    <div class="role-selection-container">
                        <div class="role-checkbox-group">
                            <label class="checkbox-item role-item" data-desc="有需求/有预算的一方，项目最终买单者或提出方（如企业客户、政府采购）">
                                <input type="checkbox" name="person_role[]" value="buyer">
                                <span>需求方 / 采购方</span>
                                <div class="role-tooltip">有需求/有预算的一方，项目最终买单者或提出方</div>
                            </label>
                            <label class="checkbox-item role-item" data-desc="提供资金或赞助，换取回报/分润/权益（如VC、天使、品牌赞助商）">
                                <input type="checkbox" name="person_role[]" value="investor">
                                <span>投资方 / 资金方</span>
                                <div class="role-tooltip">提供资金或赞助，换取回报/分润/权益</div>
                            </label>
                            <label class="checkbox-item role-item" data-desc="提供可销售的产品或服务（实体或数字），可作为变现载体（如品牌方、课程/软件提供方）">
                                <input type="checkbox" name="person_role[]" value="product">
                                <span>产品方 / 服务方</span>
                                <div class="role-tooltip">提供可销售的产品或服务，可作为变现载体</div>
                            </label>
                            <label class="checkbox-item role-item" data-desc="提供原创内容、IP或影响力资源，可用于引流与联名（如自媒体、作家、IP方）">
                                <input type="checkbox" name="person_role[]" value="content">
                                <span>内容方 / IP方</span>
                                <div class="role-tooltip">提供原创内容、IP或影响力资源，可用于引流与联名</div>
                            </label>
                            <label class="checkbox-item role-item" data-desc="负责落地与产出结果，按方案交付（如活动执行公司、研发/制作团队）">
                                <input type="checkbox" name="person_role[]" value="delivery">
                                <span>交付方 / 执行方</span>
                                <div class="role-tooltip">负责落地与产出结果，按方案交付</div>
                            </label>
                            <label class="checkbox-item role-item" data-desc="拥有分发能力，把产品/内容推广给用户（如代理商、电商平台、社群主、媒体）">
                                <input type="checkbox" name="person_role[]" value="channel">
                                <span>渠道方 / 推广方</span>
                                <div class="role-tooltip">拥有分发能力，把产品/内容推广给用户</div>
                            </label>
                            <label class="checkbox-item role-item" data-desc="运营并维护某平台/系统/入口，掌控流量与规则（如APP/SaaS/媒体平台运营）">
                                <input type="checkbox" name="person_role[]" value="ops">
                                <span>平台运营方</span>
                                <div class="role-tooltip">运营并维护某平台/系统/入口，掌控流量与规则</div>
                            </label>
                            <label class="checkbox-item role-item" data-desc="整合各方资源、定节奏并推动落地的牵头者（如项目经理、总策划、行业协会）">
                                <input type="checkbox" name="person_role[]" value="orchestrator">
                                <span>统筹方 / 牵头方</span>
                                <div class="role-tooltip">整合各方资源、定节奏并推动落地的牵头者</div>
                            </label>
                            <label class="checkbox-item role-item" data-desc="提供专业知识、资质或背书，提高可信度（如行业顾问、认证机构、导师）">
                                <input type="checkbox" name="person_role[]" value="expert">
                                <span>外部专家 / 顾问</span>
                                <div class="role-tooltip">提供专业知识、资质或背书，提高可信度</div>
                            </label>
                        </div>
                        <div class="selected-roles-summary" id="selectedRoles_${personCount}">
                            <small class="text-muted">尚未选择角色</small>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">掌握的资源（必填 ≥ 1）</label>
                    <p class="resource-description">请描述他现在就能调动的具体资源，例如：预算金额、用户数量、平台权限等</p>
                    
                    <!-- 智能推荐区域 -->
                    <div class="resource-smart-section">
                        <div class="resource-suggestions-header">
                            <i class="fas fa-lightbulb text-warning"></i>
                            <span>根据身份角色推荐</span>
                            <small class="text-muted">（选择上方角色后显示相关资源）</small>
                        </div>
                        <div class="resource-suggestions-scroll">
                            <div class="no-role-selected">
                                <i class="fas fa-arrow-up"></i>
                                请先选择身份角色以获得智能推荐
                            </div>
                        </div>
                    </div>
                    
                    <!-- 输入区域 -->
                    <div class="resource-input-section">
                        <div class="input-section-header">
                            <i class="fas fa-edit text-primary"></i>
                            <span>手动添加资源</span>
                            <div class="input-hints">
                                <span class="hint-item">💬 输入后按回车</span>
                                <span class="hint-item">📋 支持粘贴多个</span>
                                <span class="hint-item">⌫ 空白时按退格删除</span>
                            </div>
                        </div>
                        <div class="resource-input-box">
                            <input type="text" class="form-control resource-input dynamic-placeholder-resource" 
                                   placeholder="例如：微信群3个，视频号8万粉，年度预算30万"
                                   data-person-id="${personCount}">
                        </div>
                    </div>
                    
                    <!-- 已选资源显示区 -->
                    <div class="selected-resources-section">
                        <div class="selected-header">
                            <i class="fas fa-check-circle text-success"></i>
                            <span>已添加的资源</span>
                            <span class="resource-count">0</span>
                        </div>
                        <div class="selected-resources-container empty">
                            <div class="empty-state">
                                <i class="fas fa-plus-circle"></i>
                                <span>还没有添加任何资源</span>
                                <small>点击上方推荐标签或在输入框中添加</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 隐藏字段存储最终数据 -->
                    <input type="hidden" name="person_resources[]" class="resources-data">
                    
                    <!-- 验证提示区域 -->
                    <div class="resource-validation" style="display: none;">
                        <!-- 验证提示信息 -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">如何让此人高兴（需求/痛点）</label>
                    <div class="needs-selection-container">
                        <!-- 默认显示的前两个分类 -->
                        <div class="needs-visible-section">
                            <!-- 想看到回报 -->
                            <div class="tag-group" style="margin-bottom: var(--space-3);">
                                <h6 style="color: var(--color-success); margin-bottom: var(--space-1); font-size: var(--text-sm); font-weight: var(--font-semibold);">
                                    <span style="background: var(--color-success); color: white; padding: 2px 6px; border-radius: var(--radius-sm); margin-right: var(--space-1); font-size: 10px;">🟢</span>想看到回报 / 实际效果
                                </h6>
                                <p style="color: var(--color-gray-600); font-size: var(--text-xs); margin-bottom: var(--space-2); font-style: italic; padding-left: 20px;">他在意投入和产出，有明确的"结果导向"。</p>
                                <div class="checkbox-group">
                                    <label class="checkbox-tag">
                                        <input type="checkbox" name="person_needs[]" value="share_revenue">
                                        <span>拿到分成/抽成</span>
                                    </label>
                                    <label class="checkbox-tag">
                                        <input type="checkbox" name="person_needs[]" value="bring_leads">
                                        <span>带来客户/用户</span>
                                    </label>
                                    <label class="checkbox-tag">
                                        <input type="checkbox" name="person_needs[]" value="fast_execution">
                                        <span>项目尽快落地</span>
                                    </label>
                                    <label class="checkbox-tag">
                                        <input type="checkbox" name="person_needs[]" value="recurring_income">
                                        <span>能长期持续赚钱</span>
                                    </label>
                                    <label class="checkbox-tag">
                                        <input type="checkbox" name="person_needs[]" value="use_idle_assets">
                                        <span>有资源被用起来（不闲置）</span>
                                    </label>
                                </div>
                            </div>

                            <!-- 想被看到 -->
                            <div class="tag-group" style="margin-bottom: var(--space-3);">
                                <h6 style="color: var(--color-primary); margin-bottom: var(--space-1); font-size: var(--text-sm); font-weight: var(--font-semibold);">
                                    <span style="background: var(--color-primary); color: white; padding: 2px 6px; border-radius: var(--radius-sm); margin-right: var(--space-1); font-size: 10px;">🔵</span>想被看到 / 被宣传
                                </h6>
                                <p style="color: var(--color-gray-600); font-size: var(--text-xs); margin-bottom: var(--space-2); font-style: italic; padding-left: 20px;">他要曝光、要名声，而且最好是精准曝光。</p>
                                <div class="checkbox-group">
                                    <label class="checkbox-tag">
                                        <input type="checkbox" name="person_needs[]" value="brand_exposure">
                                        <span>有品牌露出（线上/线下）</span>
                                    </label>
                                    <label class="checkbox-tag">
                                        <input type="checkbox" name="person_needs[]" value="build_expert_brand">
                                        <span>打造个人标签/专家身份</span>
                                    </label>
                                    <label class="checkbox-tag">
                                        <input type="checkbox" name="person_needs[]" value="targeted_exposure">
                                        <span>曝光到目标圈层</span>
                                    </label>
                                    <label class="checkbox-tag">
                                        <input type="checkbox" name="person_needs[]" value="look_like_initiator">
                                        <span>项目中看起来是主导者</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- 展开时显示的其他分类 -->
                        <div class="needs-expandable-section" style="display: none;">
                            <!-- 主导控制 -->
                            <div class="tag-group" style="margin-bottom: var(--space-3);">
                                <h6 style="color: var(--color-warning); margin-bottom: var(--space-1); font-size: var(--text-sm); font-weight: var(--font-semibold);">
                                    <span style="background: var(--color-warning); color: white; padding: 2px 6px; border-radius: var(--radius-sm); margin-right: var(--space-1); font-size: 10px;">🟡</span>想主导项目 / 有话语权
                                </h6>
                                <p style="color: var(--color-gray-600); font-size: var(--text-xs); margin-bottom: var(--space-2); font-style: italic; padding-left: 20px;">他要掌控节奏、方向和人选，不想被当工具。</p>
                                <div class="checkbox-group">
                                    <label class="checkbox-tag">
                                        <input type="checkbox" name="person_needs[]" value="control_pace">
                                        <span>自己定节奏</span>
                                    </label>
                                    <label class="checkbox-tag">
                                        <input type="checkbox" name="person_needs[]" value="choose_partners">
                                        <span>决定和谁合作</span>
                                    </label>
                                    <label class="checkbox-tag">
                                        <input type="checkbox" name="person_needs[]" value="decide_content">
                                        <span>决定内容/产品怎么做</span>
                                    </label>
                                    <label class="checkbox-tag">
                                        <input type="checkbox" name="person_needs[]" value="own_planning">
                                        <span>有发起权/策划权</span>
                                    </label>
                                </div>
                            </div>

                            <!-- 风险规避 -->
                            <div class="tag-group" style="margin-bottom: var(--space-3);">
                                <h6 style="color: var(--color-error); margin-bottom: var(--space-1); font-size: var(--text-sm); font-weight: var(--font-semibold);">
                                    <span style="background: var(--color-error); color: white; padding: 2px 6px; border-radius: var(--radius-sm); margin-right: var(--space-1); font-size: 10px;">🟠</span>不想冒风险
                                </h6>
                                <p style="color: var(--color-gray-600); font-size: var(--text-xs); margin-bottom: var(--space-2); font-style: italic; padding-left: 20px;">他想参与，但不能有风险或损失。</p>
                                <div class="checkbox-group">
                                    <label class="checkbox-tag">
                                        <input type="checkbox" name="person_needs[]" value="no_money_no_liability">
                                        <span>不出钱不担责</span>
                                    </label>
                                    <label class="checkbox-tag">
                                        <input type="checkbox" name="person_needs[]" value="no_public_appearance">
                                        <span>不公开露脸</span>
                                    </label>
                                    <label class="checkbox-tag">
                                        <input type="checkbox" name="person_needs[]" value="no_conflict_current_partner">
                                        <span>不影响已有合作方</span>
                                    </label>
                                    <label class="checkbox-tag">
                                        <input type="checkbox" name="person_needs[]" value="keep_confidential">
                                        <span>保证信息保密</span>
                                    </label>
                                    <label class="checkbox-tag">
                                        <input type="checkbox" name="person_needs[]" value="stealth_mode">
                                        <span>可隐身参与（不被对手知道）</span>
                                    </label>
                                </div>
                            </div>

                            <!-- 被尊重 -->
                            <div class="tag-group" style="margin-bottom: var(--space-3);">
                                <h6 style="color: var(--color-info); margin-bottom: var(--space-1); font-size: var(--text-sm); font-weight: var(--font-semibold);">
                                    <span style="background: var(--color-info); color: white; padding: 2px 6px; border-radius: var(--radius-sm); margin-right: var(--space-1); font-size: 10px;">🔴</span>想被尊重 / 有地位
                                </h6>
                                <p style="color: var(--color-gray-600); font-size: var(--text-xs); margin-bottom: var(--space-2); font-style: italic; padding-left: 20px;">他要身份感、面子感和圈子认可。</p>
                                <div class="checkbox-group">
                                    <label class="checkbox-tag">
                                        <input type="checkbox" name="person_needs[]" value="be_consultant">
                                        <span>成为顾问/专家</span>
                                    </label>
                                    <label class="checkbox-tag">
                                        <input type="checkbox" name="person_needs[]" value="be_recognized">
                                        <span>被认可很重要</span>
                                    </label>
                                    <label class="checkbox-tag">
                                        <input type="checkbox" name="person_needs[]" value="raise_status_in_circle">
                                        <span>提升在圈子里的地位</span>
                                    </label>
                                    <label class="checkbox-tag">
                                        <input type="checkbox" name="person_needs[]" value="as_initiator">
                                        <span>像是他发起的局</span>
                                    </label>
                                </div>
                            </div>

                            <!-- 人脉情绪 -->
                            <div class="tag-group" style="margin-bottom: var(--space-3);">
                                <h6 style="color: var(--color-gray-700); margin-bottom: var(--space-1); font-size: var(--text-sm); font-weight: var(--font-semibold);">
                                    <span style="background: var(--color-gray-700); color: white; padding: 2px 6px; border-radius: var(--radius-sm); margin-right: var(--space-1); font-size: 10px;">🟣</span>在乎人脉 / 感受
                                </h6>
                                <p style="color: var(--color-gray-600); font-size: var(--text-xs); margin-bottom: var(--space-2); font-style: italic; padding-left: 20px;">他为关系、体验、参与感而来。</p>
                                <div class="checkbox-group">
                                    <label class="checkbox-tag">
                                        <input type="checkbox" name="person_needs[]" value="expand_network">
                                        <span>拓展人脉</span>
                                    </label>
                                    <label class="checkbox-tag">
                                        <input type="checkbox" name="person_needs[]" value="sense_of_participation">
                                        <span>有参与感/成就感</span>
                                    </label>
                                    <label class="checkbox-tag">
                                        <input type="checkbox" name="person_needs[]" value="talk_value">
                                        <span>项目能当作谈资</span>
                                    </label>
                                    <label class="checkbox-tag">
                                        <input type="checkbox" name="person_needs[]" value="feel_invited">
                                        <span>有被邀请的感觉</span>
                                    </label>
                                    <label class="checkbox-tag">
                                        <input type="checkbox" name="person_needs[]" value="learn_info">
                                        <span>能接触到新信息/学到东西</span>
                                    </label>
                                </div>
                            </div>

                            <!-- 其他自定义 -->
                            <div class="tag-group">
                                <h6 style="color: var(--color-gray-600); margin-bottom: var(--space-2); font-size: var(--text-sm); font-weight: var(--font-semibold);">
                                    <span style="background: var(--color-gray-600); color: white; padding: 2px 6px; border-radius: var(--radius-sm); margin-right: var(--space-1); font-size: 10px;">✍️</span>其他（可补充描述）
                                </h6>
                                <div class="other-input-container">
                                    <textarea class="form-control dynamic-placeholder-textarea" name="person_needs_extra[]" rows="2" 
                                              placeholder="还有什么特别的点会让他愿意参与？"></textarea>
                                    <button type="button" class="inspiration-btn" onclick="showInspirationModal(this)">
                                        <i class="fas fa-lightbulb"></i> 灵感
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- 展开/收起按钮 -->
                        <div style="text-align: center; margin-top: var(--space-3);">
                            <button type="button" class="btn-outline expand-toggle-btn" style="font-size: var(--text-sm); padding: var(--space-1) var(--space-3);" onclick="toggleExpand(this)">
                                <i class="fas fa-angle-down me-1"></i>展开更多选项
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(personCard);
            updateEmptyState();
            
            // 初始化角色提示功能
            initRoleTooltips(personCard);
            
            // 初始化资源输入功能
            initResourceInput(personCard);
            
            // 监听角色变化更新资源推荐
            const roleCheckboxes = personCard.querySelectorAll('input[name="person_role[]"]');
            roleCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    updateResourceSuggestions(personCard);
                });
            });
            
            // 初始化资源推荐（显示提示信息）
            updateResourceSuggestions(personCard);
            
            // 为新卡片设置随机提示语
            setRandomPlaceholder();
        }
        
        // 删除人物卡片
        function removePerson(button) {
            const card = button.closest('.person-card');
            card.style.animation = 'slideUp 0.3s ease-out reverse';
            setTimeout(() => {
                card.remove();
                updatePersonNumbers();
                updateEmptyState();
            }, 300);
        }
        
        // 更新人物编号
        function updatePersonNumbers() {
            const cards = document.querySelectorAll('.person-card');
            cards.forEach((card, index) => {
                const numberElement = card.querySelector('.person-number');
                if (numberElement) {
                    numberElement.textContent = index + 1;
                }
            });
            personCount = cards.length;
        }
        
        // 更新空状态显示
        function updateEmptyState() {
            const emptyState = document.getElementById('emptyState');
            const cards = document.querySelectorAll('.person-card');
            if (emptyState) {
                emptyState.style.display = cards.length === 0 ? 'block' : 'none';
            }
        }
        
        // 切换展开状态
        function toggleExpand(button) {
            const container = button.closest('.needs-selection-container');
            const expandableSection = container.querySelector('.needs-expandable-section');
            const icon = button.querySelector('i');
            
            if (expandableSection.style.display === 'none') {
                expandableSection.style.display = 'block';
                icon.className = 'fas fa-angle-up me-1';
                button.innerHTML = '<i class="fas fa-angle-up me-1"></i>收起选项';
            } else {
                expandableSection.style.display = 'none';
                icon.className = 'fas fa-angle-down me-1';
                button.innerHTML = '<i class="fas fa-angle-down me-1"></i>展开更多选项';
            }
        }
        
        // 其他资源复选框功能
        document.addEventListener('DOMContentLoaded', function() {
            const otherResourceCheckbox = document.getElementById('other_resource_checkbox');
            const otherResourceText = document.getElementById('other_resource_text');
            
            if (otherResourceCheckbox && otherResourceText) {
                otherResourceCheckbox.addEventListener('change', function() {
                    if (this.checked) {
                        otherResourceText.style.display = 'block';
                        otherResourceText.focus();
                    } else {
                        otherResourceText.style.display = 'none';
                        otherResourceText.value = '';
                    }
                });
            }
            
            // 初始化空状态
            updateEmptyState();
            
            // 初始化动态提示语
            setRandomPlaceholder();
        });
        
        // 处理其他资源输入框显示
        document.getElementById('other_resource_checkbox').addEventListener('change', function() {
            const textInput = document.getElementById('other_resource_text');
            if (this.checked) {
                textInput.style.display = 'block';
                textInput.focus();
            } else {
                textInput.style.display = 'none';
                textInput.value = '';
            }
        });
        
        // 初始化角色提示功能
        function initRoleTooltips(personCard) {
            const roleItems = personCard.querySelectorAll('.role-item');
            const summaryContainer = personCard.querySelector('.selected-roles-summary');
            
            roleItems.forEach(item => {
                const checkbox = item.querySelector('input[type="checkbox"]');
                
                // 选择变化时更新摘要
                checkbox.addEventListener('change', () => {
                    updateRolesSummary(personCard);
                });
            });
            
            // 初始更新摘要
            updateRolesSummary(personCard);
        }
        
        // 更新已选角色摘要
        function updateRolesSummary(personCard) {
            const checkedItems = personCard.querySelectorAll('.role-item input[type="checkbox"]:checked');
            const summaryContainer = personCard.querySelector('.selected-roles-summary');
            const summaryText = summaryContainer.querySelector('small');
            
            if (checkedItems.length === 0) {
                summaryText.textContent = '尚未选择角色';
                summaryContainer.classList.remove('has-selection');
            } else if (checkedItems.length === 1) {
                const selectedItem = checkedItems[0].closest('.role-item');
                summaryText.textContent = `已选择：${selectedItem.querySelector('span').textContent}`;
                summaryContainer.classList.add('has-selection');
            } else {
                const roleNames = Array.from(checkedItems).map(cb => 
                    cb.closest('.role-item').querySelector('span').textContent
                );
                summaryText.textContent = `已选择 ${checkedItems.length} 个角色：${roleNames.join('、')}`;
                summaryContainer.classList.add('has-selection');
            }
        }
        
        // 角色到资源的映射
        const roleToResourceSuggestions = {
            "buyer": ["采购预算", "项目立项权", "签约权限", "内部宣传位", "目标客户名单"],
            "investor": ["赞助额度", "现金预算", "投后服务渠道", "投委会背书", "路演名额"],
            "product": ["产品试用名额", "样品/兑换码", "分销价权限", "售后/客服支持", "API/SDK授权"],
            "content": ["公众号/视频号/抖音号X粉", "版权授权", "专栏/播客位", "内容制作团队", "素材库"],
            "delivery": ["执行团队编制", "设计/拍摄/研发能力", "供应链/施工队", "制作/交付SOP", "搭建工具/模板"],
            "channel": ["社群X个", "私域好友数X", "媒体投放位", "电商渠道位", "线下门店/展位"],
            "ops": ["APP/小程序入口位", "Push/弹窗位", "频道/专题页", "数据看板访问", "客服体系接入"],
            "orchestrator": ["跨方对接权", "项目排期控制", "合同模板/法务接口", "行业协会关系", "内推白名单"],
            "expert": ["专业认证/资质", "顾问背书", "评审名额", "培训课程", "行业人脉图谱"]
        };
        
        // 资源示例模板
        const resourceExamples = [
            ["视频号8万粉", "社群2个", "品牌对接人：本地咖啡连锁"],
            ["SaaS试用名额100个", "API授权（14天）", "实施团队2人/2周"],
            ["赞助额度30万", "项目排期控制权", "合同模板/法务接口"]
        ];
        
        // 资源输入随机提示语
        const resourcePlaceholders = [
            "微信社群5个、视频号10万粉、年度广告预算50万、产品试用码100个、活动场地一天、品牌对接人：XX",
            "电商渠道位3个、线下门店2家、KOL合作位2期、媒体采访资源、API授权、课程版权",
            "企业客户名单200条、招商会场地、投委会路演名额、供应链工厂档期、施工队2组"
        ];
        
        // 动态提示语数据
        const inspirationTexts = [
            "老板刚批预算，需要尽快花掉",
            "最近要冲 KPI / 冲业绩", 
            "有闲置团队 / 场地 / 资源想利用",
            "想测试一个新市场/新渠道的反应",
            "需要快速刷一个案例 / 成功故事",
            "刚拿到新产品，想找机会试水",
            "需要应付上级/甲方的活动要求",
            "希望年底前完成某个指标",
            "想在圈子里制造一次话题",
            "最近空档期，想找事做保持曝光",
            "希望用项目换取长期合作关系",
            "临时有媒体/活动曝光机会",
            "需要短期内验证一个想法是否可行",
            "想占个\"坑位\"避免竞争对手先做",
            "最近资金或资源到期，不用就浪费"
        ];
        
        // 随机设置提示语
        function setRandomPlaceholder() {
            const textareas = document.querySelectorAll('.dynamic-placeholder-textarea');
            textareas.forEach(textarea => {
                const randomText = inspirationTexts[Math.floor(Math.random() * inspirationTexts.length)];
                textarea.placeholder = `还有什么特别的点会让他愿意参与？比如：${randomText}`;
            });
            
            // 设置资源输入的随机提示语
            const resourceInputs = document.querySelectorAll('.dynamic-placeholder-resource');
            resourceInputs.forEach(input => {
                const randomPlaceholder = resourcePlaceholders[Math.floor(Math.random() * resourcePlaceholders.length)];
                input.placeholder = randomPlaceholder;
            });
        }
        
        // 更新资源候选标签
        function updateResourceSuggestions(personCard) {
            const personId = personCard.querySelector('.resource-input').dataset.personId;
            const roleCheckboxes = personCard.querySelectorAll('input[name="person_role[]"]:checked');
            const suggestionsContainer = personCard.querySelector('.resource-suggestions-scroll');
            
            // 获取所有选中角色的候选资源（并集）
            const allSuggestions = new Set();
            roleCheckboxes.forEach(checkbox => {
                const role = checkbox.value;
                if (roleToResourceSuggestions[role]) {
                    roleToResourceSuggestions[role].forEach(resource => allSuggestions.add(resource));
                }
            });
            
            // 清空并重新生成候选标签
            suggestionsContainer.innerHTML = '';
            
            if (allSuggestions.size > 0) {
                allSuggestions.forEach(resource => {
                    const tag = document.createElement('div');
                    tag.className = 'resource-suggestion-tag';
                    tag.textContent = resource;
                    tag.onclick = () => toggleResourceSuggestion(tag, resource, personId);
                    suggestionsContainer.appendChild(tag);
                });
            } else {
                suggestionsContainer.innerHTML = '<div class="no-role-selected"><i class="fas fa-arrow-up"></i>请先选择身份角色以获得智能推荐</div>';
            }
        }
        
        // 更新资源计数
        function updateResourceCount(personCard) {
            const container = personCard.querySelector('.selected-resources-container');
            const countElement = personCard.querySelector('.resource-count');
            const tags = container.querySelectorAll('.selected-resource-tag');
            countElement.textContent = tags.length;
        }
        
        // 切换资源候选标签
        function toggleResourceSuggestion(tagElement, resource, personId) {
            if (tagElement.classList.contains('selected')) {
                // 移除资源
                removeSelectedResource(resource, personId);
                tagElement.classList.remove('selected');
            } else {
                // 添加资源
                addSelectedResource(resource, personId);
                tagElement.classList.add('selected');
            }
        }
        
        // 添加选中的资源
        function addSelectedResource(resource, personId) {
            // 使用更精确的选择器，通过resource-input类找到正确的人物卡片
            const resourceInput = document.querySelector(`.resource-input[data-person-id="${personId}"]`);
            const targetCard = resourceInput.closest('.person-card');
            const container = targetCard.querySelector('.selected-resources-container');
            const existingTags = Array.from(container.querySelectorAll('.selected-resource-tag'));
            
            // 检查是否已存在
            if (existingTags.some(tag => tag.dataset.resource === resource)) {
                return;
            }
            
            // 验证资源格式
            const validation = validateResource(resource);
            if (validation.type === 'error') {
                showResourceValidation(personId, validation.message, 'error');
                return;
            } else if (validation.type === 'warning') {
                showResourceValidation(personId, validation.message, 'warning');
            }
            
            // 创建标签
            const tag = document.createElement('div');
            tag.className = 'selected-resource-tag';
            tag.dataset.resource = resource;
            tag.innerHTML = `
                <span>${resource}</span>
                <button type="button" class="remove-btn" onclick="removeSelectedResource('${resource.replace(/'/g, "\\'")}', '${personId}')">&times;</button>
            `;
            
            container.appendChild(tag);
            container.classList.add('has-resources');
            container.classList.remove('empty');
            updateResourceCount(targetCard);
            updateResourcesData(personId);
        }
        
        // 移除选中的资源
        function removeSelectedResource(resource, personId) {
            // 使用更精确的选择器，通过resource-input类找到正确的人物卡片
            const resourceInput = document.querySelector(`.resource-input[data-person-id="${personId}"]`);
            const targetCard = resourceInput.closest('.person-card');
            const container = targetCard.querySelector('.selected-resources-container');
            const tag = container.querySelector(`[data-resource="${resource}"]`);
            if (tag) {
                tag.remove();
            }
            
            if (container.querySelectorAll('.selected-resource-tag').length === 0) {
                container.classList.remove('has-resources');
                container.classList.add('empty');
            }
            updateResourceCount(targetCard);
            
            // 更新候选标签状态
            const currentCard = container.closest('.person-card');
            const suggestionTags = currentCard.querySelectorAll('.resource-suggestion-tag');
            suggestionTags.forEach(tag => {
                if (tag.textContent === resource) {
                    tag.classList.remove('selected');
                }
            });
            
            updateResourcesData(personId);
        }
        
        // 验证资源格式
        function validateResource(resource) {
            // 长度检查
            if (resource.length > 40) {
                return {
                    type: 'error',
                    message: '请更精炼，保留关键信息（平台/数量/权限），单条不超过40字。'
                };
            }
            
            // 空泛词检查
            const vaguePattern = /(资源|人脉|渠道|预算|粉丝|关系|能力|团队)$/;
            if (vaguePattern.test(resource.trim())) {
                return {
                    type: 'warning',
                    message: '请具体到平台/数量/对象/权限，例如"视频号10万粉"而不是"粉丝"。'
                };
            }
            
            return { type: 'success' };
        }
        
        // 显示资源验证提示
        function showResourceValidation(personId, message, type) {
            // 使用更精确的选择器，通过resource-input类找到正确的人物卡片
            const resourceInput = document.querySelector(`.resource-input[data-person-id="${personId}"]`);
            const targetCard = resourceInput.closest('.person-card');
            const validationElement = targetCard.querySelector('.resource-validation');
            validationElement.textContent = message;
            validationElement.className = `resource-validation ${type}`;
            validationElement.style.display = 'block';
            
            // 3秒后自动隐藏警告
            if (type === 'warning') {
                setTimeout(() => {
                    validationElement.style.display = 'none';
                }, 3000);
            }
        }
        
        // 格式化资源文本
        function formatResource(resource) {
            return resource
                .replace(/，/g, ',')  // 全角逗号转半角
                .replace(/(\d+)w/gi, '$1万')  // w转万
                .replace(/(\d+)万\+/g, '$1万')  // 万+转万
                .replace(/社群x(\d+)/g, '社群$1个')  // 社群x3转社群3个
                .replace(/粉(\d+)w/g, '粉丝$1万')  // 粉5w转粉丝5万
                .trim();
        }
        
        // 更新资源数据到隐藏字段
        function updateResourcesData(personId) {
            // 使用更精确的选择器，通过resource-input类找到正确的人物卡片
            const resourceInput = document.querySelector(`.resource-input[data-person-id="${personId}"]`);
            const targetCard = resourceInput.closest('.person-card');
            const container = targetCard.querySelector('.selected-resources-container');
            const tags = container.querySelectorAll('.selected-resource-tag');
            const resources = Array.from(tags).map(tag => formatResource(tag.dataset.resource));
            
            const hiddenInput = targetCard.querySelector('.resources-data');
            hiddenInput.value = JSON.stringify(resources);
        }
        
        // 处理资源输入框
        function initResourceInput(personCard) {
            const input = personCard.querySelector('.resource-input');
            const personId = input.dataset.personId;
            
            // 回车和逗号分隔
            input.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ',') {
                    e.preventDefault();
                    const value = this.value.trim();
                    if (value) {
                        // 按逗号或换行分割
                        const resources = value.split(/[,，\n]/).map(r => r.trim()).filter(r => r);
                        resources.forEach(resource => {
                            const formatted = formatResource(resource);
                            if (formatted) {
                                addSelectedResource(formatted, personId);
                            }
                        });
                        this.value = '';
                    }
                } else if (e.key === 'Backspace' && this.value === '') {
                    // 删除最后一个标签
                    const currentCard = this.closest('.person-card');
                    const container = currentCard.querySelector('.selected-resources-container');
                    const lastTag = container.querySelector('.selected-resource-tag:last-child');
                    if (lastTag) {
                        const resource = lastTag.dataset.resource;
                        removeSelectedResource(resource, personId);
                    }
                }
            });
            
            // 粘贴处理
            input.addEventListener('paste', function(e) {
                e.preventDefault();
                const paste = (e.clipboardData || window.clipboardData).getData('text');
                const resources = paste.split(/[,，\n]/).map(r => r.trim()).filter(r => r);
                resources.forEach(resource => {
                    const formatted = formatResource(resource);
                    if (formatted) {
                        addSelectedResource(formatted, personId);
                    }
                });
            });
        }
        

        
        // 初始化空状态显示
        function initResourceEmptyState() {
            const containers = document.querySelectorAll('.selected-resources-container');
            containers.forEach(container => {
                if (container.children.length === 0) {
                    container.classList.add('empty');
                } else {
                    container.classList.remove('empty');
                }
            });
        }
        
        // 显示灵感模态框
        function showInspirationModal(button) {
            const textarea = button.parentElement.querySelector('textarea');
            
            // 创建模态框
            const modal = document.createElement('div');
            modal.className = 'inspiration-modal';
            modal.innerHTML = `
                <div class="inspiration-modal-content">
                    <button class="inspiration-modal-close" onclick="closeInspirationModal()">&times;</button>
                    <h5><i class="fas fa-lightbulb" style="color: #667eea; margin-right: 8px;"></i>常见动机灵感</h5>
                    <div class="inspiration-list">
                        ${inspirationTexts.map(text => 
                            `<div class="inspiration-item" onclick="selectInspiration(this, '${text.replace(/'/g, "\\'")}')">${text}</div>`
                        ).join('')}
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 存储当前 textarea 引用
            modal.targetTextarea = textarea;
            
            // 显示模态框
            setTimeout(() => modal.classList.add('show'), 10);
            
            // 点击背景关闭
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeInspirationModal();
                }
            });
        }
        
        // 选择灵感文本
        function selectInspiration(item, text) {
            const modal = document.querySelector('.inspiration-modal');
            if (modal && modal.targetTextarea) {
                const currentValue = modal.targetTextarea.value;
                if (currentValue) {
                    modal.targetTextarea.value = currentValue + (currentValue.endsWith('\n') ? '' : '\n') + text;
                } else {
                    modal.targetTextarea.value = text;
                }
                modal.targetTextarea.focus();
            }
            closeInspirationModal();
        }
        
        // 关闭灵感模态框
        function closeInspirationModal() {
            const modal = document.querySelector('.inspiration-modal');
            if (modal) {
                modal.classList.remove('show');
                setTimeout(() => {
                    if (modal.parentNode) {
                        modal.parentNode.removeChild(modal);
                    }
                }, 300);
            }
        }
        
        // 表单提交前验证和处理
        document.getElementById('mainForm').addEventListener('submit', function(e) {
            e.preventDefault(); // 阻止默认表单提交
            
            const projectName = document.getElementById('project_name').value.trim();
            const projectDescription = document.getElementById('project_description').value.trim();
            
            if (!projectName || !projectDescription) {
                alert('请填写项目名称和背景描述');
                return;
            }
            
            // 添加提交动画
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>正在分析...';
            submitBtn.disabled = true;
            
            // 收集表单数据
            const formData = {
                projectName: projectName,
                projectDescription: projectDescription,
                projectStage: document.getElementById('project_stage').value,
                keyPersons: [],
                externalResources: []
            };
            
            // 收集关键人物数据
            document.querySelectorAll('.person-card').forEach(card => {
                const nameInput = card.querySelector('input[name="person_name[]"]');
                const name = nameInput ? nameInput.value.trim() : '';
                if (name) {
                    const person = {
                        name: name,
                        roles: Array.from(card.querySelectorAll('input[name="person_role[]"]:checked')).map(cb => cb.value),
                        resources: [],
                        makeHappy: Array.from(card.querySelectorAll('input[name="person_needs[]"]:checked')).map(cb => cb.value),
                        notes: ''
                    };
                    
                    // 收集个人资源（从已选资源标签中获取）
                    const resourceTags = card.querySelectorAll('.selected-resource-tag');
                    if (resourceTags.length > 0) {
                        person.resources = Array.from(resourceTags).map(tag => tag.dataset.resource);
                    }
                    
                    // 收集备注（从其他自定义输入获取）
                    const notesInput = card.querySelector('textarea[name="person_needs_extra[]"]');
                    if (notesInput) {
                        person.notes = notesInput.value.trim();
                    }
                    
                    formData.keyPersons.push(person);
                }
            });
            
            // 收集外部资源（从外部资源区域）
            const externalResourcesSection = document.getElementById('external-resources-section');
            if (externalResourcesSection) {
                const resourceChips = externalResourcesSection.querySelectorAll('.resource-chip');
                resourceChips.forEach(chip => {
                    const resourceText = chip.textContent.replace('×', '').trim();
                    if (resourceText) {
                        formData.externalResources.push(resourceText);
                    }
                });
            }
            
            // 如果没有外部资源，添加一个默认值
            if (formData.externalResources.length === 0) {
                formData.externalResources = ['暂无明确外部资源'];
            }
            
            // 发送数据到后端Flask而不是sessionStorage
            const form = document.createElement('form');
            form.method = 'POST';
            form.action = '/generate';
            form.style.display = 'none';
            
            // 添加项目基础信息
            const addInput = (name, value) => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = name;
                input.value = value;
                form.appendChild(input);
            };
            
            addInput('project_name', formData.projectName);
            addInput('project_description', formData.projectDescription);
            addInput('project_stage', formData.projectStage);
            
            // 添加关键人物数据
            formData.keyPersons.forEach((person, index) => {
                addInput('person_name[]', person.name);
                addInput('person_role[]', person.roles.join(','));
                addInput('person_resources[]', person.resources.join(','));
                addInput('person_needs[]', person.makeHappy.join(','));
            });
            
            // 添加外部资源数据
            formData.externalResources.forEach(resource => {
                addInput('external_resources', resource);
            });
            
            // 提交表单
            document.body.appendChild(form);
            form.submit();
        });
        
        // 测试案例数据
        const demoTestCases = {
            'english-training': {
                projectName: 'Bonnie英语培训管道',
                projectDescription: '有一天，一个做升学规划的朋友在饭局上随口吐槽："最近合作的英语机构交付太差，特别不靠谱，你有没有靠谱的老师推荐？"我发现我有这个朋友就有生源，我可以去找老师就有交付，我来做连接不就能搭个闭环？而且机构交付差是因为价格太低只有市场价1/3，我就设计标准化产品配助教，成本降下来。',
                projectStage: 'testing',
                persons: [
                    {
                        name: '升学规划师朋友',
                        roles: ['channel'],
                        resources: ['家长客户资源', '升学规划服务信任度', '教育圈人脉'],
                        makeHappy: ['bring_leads', 'no_conflict_current_partner', 'recurring_income'],
                        notes: '有流量焦虑，经常有家长问英语培训推荐'
                    },
                    {
                        name: '英语培训机构',
                        roles: ['product', 'delivery'],
                        resources: ['英语课程产品', '师资助教团队', '线上教学系统'],
                        makeHappy: ['bring_leads', 'brand_exposure', 'expand_network'],
                        notes: '想转型线上，有流量焦虑，交付成本高'
                    }
                ],
                externalResources: ['标准化产品设计能力', '三方合作协议模板']
            },
            'rental-business': {
                projectName: 'Angela临街商铺二房东管道',
                projectDescription: '我打了20多个电话调研发现一个房东有临街双层商铺，挂了两三个月都租不出去，因为房东要求整租，很多人想分开租上下层。更重要的是，这个铺子没有煤气不能做热菜，所以餐饮做不了。但通过市场调研我发现一楼可以做便利店、水果店，二楼可以做美容SPA、理发店。房东还是个社恐，太好了！',
                projectStage: 'testing',
                persons: [
                    {
                        name: '社恐房东',
                        roles: ['investor'],
                        resources: ['临街双层商铺', '5年长期租约意愿', '稳定现金流需求'],
                        makeHappy: ['recurring_income', 'no_money_no_liability', 'no_public_appearance'],
                        notes: '社恐不想跟太多租客打交道，要求整租，铺子空置好几个月'
                    }
                ],
                externalResources: ['20+电话市场调研结果', '商圈消费数据', '分租市场需求']
            },
            'cicada-farming': {
                projectName: '楚楚知了猴7条管道',
                projectDescription: '我是十八线小县城美容院老板娘，全年无休当高强度打工者。老公开玩笑说"要不咱们养一片林子自己抓知了猴吧？"让我意识到这么多人吃知了猴，我为什么不能做供货方？我盘了4个关键资源：销路（烧烤摊、餐馆供不应求）、林地（老公同学有柳树林）、蝉卵（劳务市场乡亲能捡）、技术（当地养殖户教学）。',
                projectStage: 'testing',
                persons: [
                    {
                        name: '柳树林主',
                        roles: ['investor'],
                        resources: ['柳树林地', '除草需求', '长期合作意愿'],
                        makeHappy: ['use_idle_assets', 'recurring_income', 'no_money_no_liability'],
                        notes: '除草成本高是真正痛点，我们帮他除草换取低价租金'
                    },
                    {
                        name: '当地养殖户老师',
                        roles: ['expert'],
                        resources: ['知了猴养殖技术', '成功经验', '行业人脉'],
                        makeHappy: ['be_recognized', 'brand_exposure', 'be_consultant'],
                        notes: '被称为"乡村袁隆平"，感受到尊重后愿意倾囊相授'
                    },
                    {
                        name: '劳务市场大爷大妈',
                        roles: ['delivery'],
                        resources: ['蝉卵采集能力', '山区熟悉度', '时间充裕'],
                        makeHappy: ['recurring_income', 'control_pace', 'be_recognized'],
                        notes: '以件计价不设打卡，干得开心效率更高'
                    },
                    {
                        name: '烧烤摊餐馆老板',
                        roles: ['buyer'],
                        resources: ['稳定销路需求', '现金交易', '食材采购渠道'],
                        makeHappy: ['stable_supply', 'cost_control', 'unique_products'],
                        notes: '知了猴供不应求，愿意预付定金确保稳定供货'
                    }
                ],
                externalResources: ['机械除草设备', '包教包会收购模式', '县城食材供应链']
            }
        };

        // 处理测试案例选择
        function handleDemoCaseSelection() {
            const caseCards = document.querySelectorAll('.demo-case-card');
            
            caseCards.forEach(card => {
                card.addEventListener('click', function() {
                    const caseType = this.dataset.case;
                    
                    // 移除其他卡片的选中状态
                    caseCards.forEach(c => c.classList.remove('selected'));
                    
                    if (caseType === 'custom') {
                        // 自定义项目 - 清空表单
                        this.classList.add('selected');
                        clearForm();
                        scrollToForm();
                    } else if (demoTestCases[caseType]) {
                        // 选择测试案例 - 填充表单
                        this.classList.add('selected');
                        loadTestCase(demoTestCases[caseType]);
                        scrollToForm();
                        
                        // 显示成功提示
                        showNotification('✅ 示例案例已加载完成！向下滚动查看表单内容，可直接提交分析或修改参数', 'success');
                    }
                });
            });
        }

        // 加载测试案例数据到表单
        function loadTestCase(caseData) {
            // 强制显示所有表单元素（移除动画类避免时序问题）
            const mainForm = document.getElementById('mainForm');
            if (mainForm) {
                // 移除可能影响显示的动画类
                const animatedElements = mainForm.querySelectorAll('.fade-in, .slide-up');
                animatedElements.forEach(el => {
                    el.classList.remove('fade-in', 'slide-up');
                    el.style.opacity = '1';
                    el.style.transform = 'translateY(0)';
                    el.style.visibility = 'visible';
                });
                
                // 强制重新布局
                mainForm.style.display = 'block';
                mainForm.offsetHeight; // 触发重绘
            }
            
            // 填充项目基础信息
            const projectNameEl = document.getElementById('project_name');
            const projectDescEl = document.getElementById('project_description');
            const projectStageEl = document.getElementById('project_stage');
            
            if (projectNameEl) {
                projectNameEl.value = caseData.projectName || '';
                projectNameEl.setAttribute('value', caseData.projectName || '');
            }
            if (projectDescEl) {
                projectDescEl.value = caseData.projectDescription || '';
                projectDescEl.textContent = caseData.projectDescription || '';
            }
            if (projectStageEl) {
                projectStageEl.value = caseData.projectStage || '';
            }
            
            // 清空现有人物卡片并重置计数器
            const personsContainer = document.getElementById('personsContainer');
            if (personsContainer) {
                personsContainer.innerHTML = '';
                personCount = 0; // 重置人物计数器
                
                // 确保容器可见
                personsContainer.style.display = 'block';
                personsContainer.style.opacity = '1';
                personsContainer.style.visibility = 'visible';
            }
            
            // 添加测试案例中的人物
            if (caseData.persons && caseData.persons.length > 0) {
                caseData.persons.forEach((person, index) => {
                    addPerson();
                    const personCards = document.querySelectorAll('.person-card');
                    const currentCard = personCards[personCards.length - 1];
                        
                    if (!currentCard) return;
                    
                    // 强制显示人物卡片（移除动画类）
                    currentCard.classList.remove('fade-in', 'slide-up');
                    currentCard.style.opacity = '1';
                    currentCard.style.transform = 'translateY(0)';
                    currentCard.style.visibility = 'visible';
                    currentCard.style.display = 'block';
                        
                    // 填充人物信息
                    const nameInput = currentCard.querySelector('input[name="person_name[]"]');
                    if (nameInput) {
                        nameInput.value = person.name || '';
                        nameInput.setAttribute('value', person.name || '');
                        // 强制显示输入框内容
                        nameInput.style.opacity = '1';
                        nameInput.style.visibility = 'visible';
                    }
                        
                    // 选择角色
                    if (person.roles) {
                        person.roles.forEach(role => {
                            const roleCheckbox = currentCard.querySelector(`input[name="person_role[]"][value="${role}"]`);
                            if (roleCheckbox) {
                                roleCheckbox.checked = true;
                            }
                        });
                        updateRolesSummary(currentCard);
                        updateResourceSuggestions(currentCard);
                    }
                    
                    // 添加资源
                    if (person.resources) {
                        person.resources.forEach(resource => {
                            const personId = currentCard.querySelector('.resource-input').dataset.personId;
                            addSelectedResource(resource, personId);
                        });
                    }
                    
                    // 选择需求选项
                    if (person.makeHappy) {
                        person.makeHappy.forEach(need => {
                            const needCheckbox = currentCard.querySelector(`input[name="person_needs[]"][value="${need}"]`);
                            if (needCheckbox) {
                                needCheckbox.checked = true;
                            }
                        });
                    }
                    
                    // 填充备注
                    const notesTextarea = currentCard.querySelector('textarea[name="person_notes[]"]');
                    if (notesTextarea) notesTextarea.value = person.notes || '';
                    
                    // 在最后一个人物加载完成后更新编号
                    if (index === caseData.persons.length - 1) {
                        updatePersonNumbers();
                    }
                });
            }
            
            // 填充外部资源（延迟一点让DOM更新完成）
            setTimeout(() => {
                if (caseData.externalResources) {
                    caseData.externalResources.forEach(resource => {
                        const allCheckboxes = document.querySelectorAll('input[name="external_resources"]');
                        allCheckboxes.forEach(checkbox => {
                            if (checkbox.value.includes(resource) || resource.includes(checkbox.value)) {
                                checkbox.checked = true;
                            }
                        });
                    });
                }
            }, 300);
        }

        // 清空表单
        function clearForm() {
            document.getElementById('project_name').value = '';
            document.getElementById('project_description').value = '';
            document.getElementById('project_stage').value = '';
            
            document.getElementById('personsContainer').innerHTML = '';
            personCount = 0; // 重置计数器
            addPerson();
            
            document.querySelectorAll('input[name="external_resources"]').forEach(cb => {
                cb.checked = false;
            });
        }

        // 滚动到表单区域
        function scrollToForm() {
            const formElement = document.getElementById('mainForm');
            if (formElement) {
                setTimeout(() => {
                    formElement.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'start' 
                    });
                    // 强制重新渲染表单以确保内容显示
                    setTimeout(() => {
                        // 触发重绘
                        const inputs = formElement.querySelectorAll('input, textarea, select');
                        inputs.forEach(input => {
                            if (input.value) {
                                input.dispatchEvent(new Event('input', { bubbles: true }));
                            }
                        });
                    }, 500);
                }, 800);
            }
        }

        // 显示通知消息
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} slide-up`;
            notification.textContent = message;
            notification.style.position = 'fixed';
            notification.style.top = '20px';
            notification.style.right = '20px';
            notification.style.zIndex = '9999';
            notification.style.maxWidth = '400px';
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 4000);
        }

        // 页面加载时添加初始人物卡片
        document.addEventListener('DOMContentLoaded', function() {
            addPerson();
            setRandomPlaceholder();
            handleDemoCaseSelection();
        });
        
        // 添加平滑滚动
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });
        
        // 添加输入框焦点动画
        document.querySelectorAll('.form-control').forEach(input => {
            input.addEventListener('focus', function() {
                this.parentElement.classList.add('focused');
            });
            
            input.addEventListener('blur', function() {
                this.parentElement.classList.remove('focused');
            });
        });
    </script>
</body>
</html>